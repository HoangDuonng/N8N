{"createdAt":"2023-03-07T10:29:04.992Z","updatedAt":"2023-05-14T04:57:34.000Z","id":"43","name":"Ph√≤ng v√© g·ª≠i zalo zns","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"ncmk-phong-ve-zns","options":{}},"id":"8902284b-4f3f-4001-b3e4-8c80066a8d22","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[840,540],"webhookId":"dfa7db72-9657-44d2-ac57-f9430a4ca50d"},{"parameters":{"method":"POST","url":"https://business.openapi.zalo.me/message/template","sendHeaders":true,"headerParameters":{"parameters":[{"name":"access_token","value":"={{ $node.Airtable.json.fields.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"phone\": \"{{$node[\"Code\"].json[\"sdtZalo\"]}}\",\n    \"template_id\": \"249129\",\n    \"template_data\": {\n        \"ma_dat_cho\": \"{{$node[\"Code\"].json[\"maDatCho\"]}}\",\n        \"hang\": \"{{$node[\"Code\"].json[\"hang\"]}}\",\n        \"ngay_khoi_hanh\": \"{{$node[\"Code\"].json[\"ngayKhoiHanh\"]}}\",\n        \"customer_name\": \"{{$node[\"Code\"].json[\"customerName\"]}}\",\n        \"thong_tin_ve\": \"{{$node[\"Code\"].json[\"thongTinVe\"]}}\",\n        \"ten_hanh_khach\": \"{{$node[\"Code\"].json[\"tenHanhKhach\"]}}\",\n        \"gia_ban\": {{$node[\"Code\"].json[\"giaBan\"]}},\n        \"tinh_trang_thanh_toan\": \"{{$node[\"Code\"].json[\"tinhTrangThanhToan\"]}}\"\n    },\n    \"tracking_id\": \"ncmk_phong_ve_gui_ve\"\n}\n","options":{}},"id":"3c19a95a-6711-40c5-844a-6b7d1b59963a","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1680,520]},{"parameters":{"jsCode":"let data = $('Webhook').first().json.body;\n\nlet sdtZalo = '84' + ((data.sdt_zalo === '') ? data.sdt.slice(1) : data.sdt_zalo.slice(1));\nsdtZalo = sdtZalo.replace(/\\s/g, '');\n\nlet thongTinVe = (data.thong_tin_ve === '') ? '-' : data.thong_tin_ve.replace(/\\n/g, \", \");\n\nlet hang = (data.hang === '') ? '-' : data.hang.replace(/\\n/g, \", \");\n\nlet maDatCho = (data.ma_dat_cho === '') ? '-' : data.ma_dat_cho.replace(/\\n/g, \", \");\n\nlet tenHanhKhach = (data.ten_hanh_khach === '') ? '-' : data.ten_hanh_khach.replace(/\\n/g, \", \");\n\nlet ngayKhoiHanh = (data.ngay_khoi_hanh === '') ? '-' : new Date(data.ngay_khoi_hanh).toLocaleDateString('en-GB');\n\nlet giaBan = (data.gia_ban === '') ? 0 : data.gia_ban;\n\nlet giaBanLark = (data.gia_ban === '') ? 0 : Math.floor(+data.gia_ban).toLocaleString(\"en-US\") + \" VND\";;\nlet tinhTrangThanhToan = (data.tinh_trang_thanh_toan === 'true') ? 'ƒê√£ thanh to√°n' : 'Ch∆∞a thanh to√°n ƒë·ªß';\n\nlet customerName = (data.customer_name === '') ? '-' : data.customer_name.replace(/\\n/g, \", \");\n\nlet loaiKhach = (data.loai_khach === '') ? '-' : data.loai_khach.replace(/\\n/g, \", \");\n\nlet nhanVienXuatVe = (data.nhan_vien_xuat_ve === '') ? '-' : data.nhan_vien_xuat_ve.replace(/\\n/g, \", \");\n\nreturn {\n  sdtZalo,\n  thongTinVe,\n  hang,\n  maDatCho,\n  tenHanhKhach,\n  ngayKhoiHanh,\n  giaBan,\n  giaBanLark,\n  tinhTrangThanhToan,\n  customerName,\n  loaiKhach,\n  nhanVienXuatVe\n}"},"id":"4eecece2-44b2-474b-b740-0622bee10dd6","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[1500,520]},{"parameters":{"conditions":{"number":[{"value1":"={{Number($json.data.quota.remainingQuota) }}","operation":"smallerEqual","value2":5}]}},"id":"941b1e59-ea50-4884-b73f-eb6753dc3062","name":"IF remainingQuota < 5","type":"n8n-nodes-base.if","typeVersion":1,"position":[2300,540]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/cfa4bb90-0e41-45df-9af0-66fdd358063d","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"msg_type\": \"text\",\n    \"content\": {\n        \"text\": \"H·∫°n m·ª©c c√≤n l·∫°i {{ $node[\"HTTP Request\"].json[\"data\"][\"quota\"][\"remainingQuota\"] }}/{{ $node[\"HTTP Request\"].json[\"data\"][\"quota\"][\"dailyQuota\"] }}. ZaloZNS: Vui l√≤ng Topup!\"\n    }\n}","options":{}},"id":"8475c010-5102-4a33-9b18-1e0a9ce93bd3","name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,440]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/cfa4bb90-0e41-45df-9af0-66fdd358063d","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"msg_type\": \"interactive\",\n    \"card\": {\n        \"config\": {\n            \"wide_screen_mode\": true\n        },\n        \"elements\": [\n            {\n                \"tag\": \"div\",\n                \"fields\": [\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"H√£ng\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Webhook\"].json[\"body\"][\"hang\"] }}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"Th√¥ng tin v√©\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{$node[\"Code\"].json[\"thongTinVe\"]}}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"M√£ ƒë·∫∑t ch·ªó\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Webhook\"].json[\"body\"][\"ma_dat_cho\"] }}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"T√™n h√†nh kh√°ch\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Code\"].json[\"tenHanhKhach\"] }}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"Ng√†y kh·ªüi h√†nh\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Code\"].json[\"ngayKhoiHanh\"] }}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"Gi√° b√°n\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Code\"].json[\"giaBanLark\"] }}\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"T√¨nh tr·∫°ng thanh to√°n\"\n                        }\n                    },\n                    {\n                        \"is_short\": true,\n                        \"text\": {\n                            \"tag\": \"lark_md\",\n                            \"content\": \"{{ $node[\"Code\"].json[\"tinhTrangThanhToan\"] }}\"\n                        }\n                    }\n                ]\n            },\n            {\n                \"tag\": \"action\",\n                \"actions\": [\n                    {\n                        \"tag\": \"button\",\n                        \"text\": {\n                            \"tag\": \"plain_text\",\n                            \"content\": \"Chat Zalo v·ªõi kh√°ch\"\n                        },\n                        \"url\": \"https://zalo.me/{{ $node[\"Webhook\"].json[\"body\"][\"sdt_zalo\"] }}\",\n                        \"type\": \"primary\"\n                    },\n                    {\n                        \"tag\": \"button\",\n                        \"text\": {\n                            \"tag\": \"plain_text\",\n                            \"content\": \"M·ªü CRM\"\n                        },\n                        \"url\": \"https://phongve.ncmk.app\",\n                        \"type\": \"default\"\n                    }\n                ]\n            }\n        ],\n                \"header\": {\n                        \"template\": \"green\",\n                        \"title\": {\n                                  \"content\": \"{{ $node[\"Webhook\"].json[\"body\"][\"nhan_vien_xuat_ve\"] }} ƒë√£ ch·ªët th√†nh c√¥ng 1 ƒë∆°n h√†ng üéâ\",\n                                  \"tag\": \"plain_text\"\n                         }\n                 }\n    }\n}","options":{}},"id":"806a910c-bfee-489e-a052-568aebd815a0","name":"HTTP Request2","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,620]},{"parameters":{"application":{"__rl":true,"value":"appg7xGBQYqUYbJAr","mode":"id"},"table":{"__rl":true,"value":"tblWAtHbJemABDvCG","mode":"id"},"id":"recqr9eRsaI69jq2D"},"id":"0ccc2f3b-d960-4e67-9912-c5b39067c08f","name":"Airtable","type":"n8n-nodes-base.airtable","typeVersion":1,"position":[1280,520],"credentials":{"airtableApi":{"id":"20","name":"Airtable: lekhoi456@gmail.com"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.loai_khach }}","value2":"Kh√°ch l·∫ª"},{"value1":"={{ $json.body.loai_khach }}","operation":"isEmpty"}]},"combineOperation":"any"},"id":"25f7c478-171e-4916-9aa8-f3fb4854bc8d","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[1060,540]},{"parameters":{"conditions":{"string":[{"value1":"={{ $node[\"HTTP Request\"].json.data.quota.remainingQuota }}","operation":"isEmpty"}]}},"id":"1e9c6897-a38d-412b-b649-201621d22520","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1880,520]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/cfa4bb90-0e41-45df-9af0-66fdd358063d","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"msg_type\": \"text\",\n    \"content\": {\n        \"text\": \"C√≥ l·ªói khi g·ª≠i. Vui l√≤ng ki·ªÉm tra!\"\n    }\n}","options":{}},"id":"9981d992-3767-4dd1-b2a3-509df08ba099","name":"HTTP Request3","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2320,220]},{"parameters":{"conditions":{"number":[{"value1":"={{ $node[\"HTTP Request\"].json.error }}","operation":"equal","value2":-118}]}},"id":"501973be-8f7c-4fc2-b3d5-9a99f6e0a7b8","name":"IF2","type":"n8n-nodes-base.if","typeVersion":1,"position":[2100,420]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/cfa4bb90-0e41-45df-9af0-66fdd358063d","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"msg_type\": \"text\",\n    \"content\": {\n        \"text\": \"Kh√¥ng t√¨m th·∫•y t√†i kho·∫£n Zalo\"\n    }\n}","options":{}},"id":"3bd8eb59-1dc5-4488-8972-f53deb48757e","name":"HTTP Request4","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2320,60]}],"connections":{"Webhook":{"main":[[{"node":"IF","type":"main","index":0}]]},"Code":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"IF1","type":"main","index":0}]]},"IF remainingQuota < 5":{"main":[[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"HTTP Request2","type":"main","index":0}]]},"Airtable":{"main":[[{"node":"Code","type":"main","index":0}]]},"IF":{"main":[[{"node":"Airtable","type":"main","index":0}]]},"IF1":{"main":[[{"node":"IF2","type":"main","index":0}],[{"node":"IF remainingQuota < 5","type":"main","index":0}]]},"IF2":{"main":[[{"node":"HTTP Request4","type":"main","index":0}],[{"node":"HTTP Request3","type":"main","index":0}]]}},"settings":{"saveExecutionProgress":false,"saveManualExecutions":false,"callerPolicy":"workflowsFromSameOwner"},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"Go-http-client/2.0","content-length":"1642","accept-encoding":"gzip","content-type":"multipart/form-data; boundary=dbf35de732d5364c681e296feaa79066bc993b02de889c2ae5fd7615ee8f","x-forwarded-for":"3.211.55.69","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"422302823b8a","x-real-ip":"3.211.55.69","x-tt-logid":"02168085530122800000000000000000000fffff03552d75d01fa"},"params":{},"query":{},"body":{"thong_tin_ve":"V√© m√°y bay SGN-SIN-SGN","hang":"Vietjet Air","ma_dat_cho":"DB5RPM","ten_hanh_khach":"LE QUOC KHOI","ngay_khoi_hanh":"2023/03/14","gia_ban":"3018000","tinh_trang_thanh_toan":"true","sdt_zalo":"0333111868","customer_name":"Le Khoi ","loai_khach":"Kh√°ch l·∫ª","nhan_vien_xuat_ve":"H·ªì Th·ªã T∆∞·ªùng Vy","sdt":"0333111868"}}}]},"versionId":"e346827a-8873-4bd4-9af4-ade19dd25013","triggerCount":1,"tags":[{"createdAt":"2023-02-10T04:34:16.814Z","updatedAt":"2023-02-10T04:34:16.814Z","id":"9","name":"ncmk"}]}
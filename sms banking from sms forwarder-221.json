{"createdAt":"2023-07-22T10:56:35.035Z","updatedAt":"2023-07-22T15:48:13.000Z","id":"221","name":"SMS BANKING FROM SMS FORWARDER","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"forwarder-sms","options":{}},"id":"060edf5d-0f11-43c6-bd15-9033e65eebef","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1640,960],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let elements = [];\n\n  elements.push({\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**NgÃ¢n hÃ ng**: ${data.bankName.toUpperCase()}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Sá»‘ tÃ i khoáº£n**: ${data.receiverAccount}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Sá»‘ dÆ° thay Ä‘á»•i:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Ná»™i dung:** ${data.transactionMessage}`,\n        },\n      },\n    ],\n  });\n\n  // Append transaction ID if exist\n  if (data.transactionId) {\n    elements[0].fields.push({\n      is_short: false,\n      text: {\n        tag: 'lark_md',\n        content: `**MÃ£ giao dá»‹ch:** ${data.transactionId}`,\n      },\n    });\n  }\n\n  // Append received time\n  elements[0].fields.push({\n    is_short: false,\n    text: {\n      tag: 'lark_md',\n      content: `**Thá»i gian nháº­n:** ${data.receivedTime.text}`,\n    },\n  });\n\n  // Kiá»ƒm tra enableBalance náº¿u true thÃ¬ thÃªm pháº§n tá»­ \"Sá»‘ dÆ° táº¡m tÃ­nh\" vÃ o máº£ng fields\n  if ($input.item.json.enableBalance) {\n    const balanceIndex = elements[0].fields.findIndex((field) =>\n      field?.text?.content?.includes('Sá»‘ dÆ° thay Ä‘á»•i')\n    );\n    if (balanceIndex !== -1) {\n      elements[0].fields.splice(balanceIndex + 1, 0, {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Sá»‘ dÆ° táº¡m tÃ­nh**: ${data.balance.amountText} VND`,\n        },\n      });\n    }\n  }\n\n  // create message card\n  let result = {\n    msg_type: 'interactive',\n    card: {\n      config: {\n        wide_screen_mode: true,\n      },\n      header: {\n        template: data.larkMessConfig?.cardColor ?? 'blue',\n        title: {\n          content: `${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n            data.transactionType.type\n          }) ${data.transactionAmount.amountText}VND`,\n          tag: 'plain_text',\n        },\n      },\n      elements,\n    },\n  };\n\n  return {\n    json: {\n      isSend: true,\n      data: result,\n      customBotURL: $input.item.json.customBotURL,\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"4e076f56-7f22-4083-b93f-d5925083c0f5","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,1000]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $input.item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $input.item.json[\"appSecret\"] }}\" }","options":{}},"id":"cc302259-ad86-4638-b99a-26e05bf947f0","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[-400,700]},{"parameters":{"method":"POST","url":"={{ $input.item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.data)}}","options":{}},"id":"2f163fbe-bd05-498d-b370-749c89270001","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1080,860]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: data.bankName + '-' + data.receiverAccount,\n        Bank: data.bankName.toUpperCase(),\n        Account: data.receiverAccount,\n        'Transaction Type': data.transactionType.typeText,\n        Debit:\n          data.transactionType.type === '+'\n            ? data.transactionAmount.amount\n            : undefined,\n        Credit:\n          data.transactionType.type === '-'\n            ? data.transactionAmount.amount\n            : undefined,\n        'Transaction ID': data.transactionId,\n        'Transaction Message': data.transactionMessage,\n        'Original Message': data.originalMessage,\n        'Time received': data.receivedTime.timestamp,\n      },\n    },\n  ];\n\n  // Kiá»ƒm tra enableBalance náº¿u true thÃ¬ thÃªm pháº§n tá»­ \"Balance\" vÃ o máº£ng fields\n  if ($input.item.json.enableBalance) {\n    records[0].fields = {\n      ...records[0].fields,\n      Balance: data.balance.amount,\n    };\n  }\n\n  return {\n    json: {\n      isSend: true,\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"5e9dd9a0-0bb8-488c-a769-46ee7b4dc212","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[640,600]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $json[\"configs\"][\"baseId\"] }}/tables/{{  $json[\"configs\"][\"tableId\"]}}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($json[\"records\"]) }}}","options":{}},"id":"c825e01e-eeff-4b10-a12a-c6db49610329","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1060,540]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"0a322418-b806-4b4b-8f81-ec3ab8072865","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1220,960]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"a6e294f9-2022-4654-9dbd-d769d5ab029d","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1480,1280]},{"parameters":{},"id":"7f527dc7-37a4-460a-95c2-46ace0619308","name":"Start Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-1020,940]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let message = [];\n\n  message.push(\n    `<b>${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n      data.transactionType.type\n    }) ${data.transactionAmount.amountText}VND</b>\\n`,\n    `<b>NgÃ¢n hÃ ng:</b> ${data.bankName.toUpperCase()}`,\n    `<b>Sá»‘ tÃ i khoáº£n:</b> ${data.receiverAccount}`,\n    `<b>Sá»‘ dÆ° thay Ä‘á»•i:</b> ${data.transactionType.type} ${data.transactionAmount.amountText} VND`\n  );\n\n  // Add balance\n  if ($input.item.json.enableBalance) {\n    message.push(`<b>Sá»‘ dÆ° táº¡m tÃ­nh:</b> ${data.balance.amountText} VND`);\n  }\n\n  message.push(`<b>Ná»™i dung:</b>\\n ${data.transactionMessage}`);\n\n  // Check transaction ID\n  if (data.transactionId) {\n    message.push(`<b>MÃ£ giao dá»‹ch:</b> ${data.transactionId}`);\n  }\n\n  message.push(`<b>Thá»i gian nháº­n:</b> ${data.receivedTime.text}`);\n\n  return {\n    json: {\n      isSend: true,\n      botToken: $input.item.json.botToken,\n      payload: {\n        chat_id: $input.item.json.chatId,\n        parse_mode: 'HTML',\n        text: message.join('\\n'),\n      },\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"12b16e1f-b70d-4143-9797-25661c109f22","name":"Create Telegram Message","type":"n8n-nodes-base.code","typeVersion":1,"position":[100,1440]},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot{{ $input.item.json.botToken }}/sendMessage ","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.payload) }}","options":{}},"id":"0fcc3083-9908-419e-8acf-9d71cfd5e3a7","name":"Send to Telegram chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[560,1360]},{"parameters":{"values":{"string":[{"name":"appId","value":"set-app-id"},{"name":"appSecret","value":"set-app-secret"}]},"options":{}},"id":"ad8e923d-5648-4962-9311-0950f0398395","name":"Set Lark Configs","type":"n8n-nodes-base.set","typeVersion":2,"position":[-580,700]},{"parameters":{"values":{"string":[{"name":"customBotURL","value":"set-bot-url"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP","value":true},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"d72a7281-3587-4773-9128-25cd6ac904cb","name":"Set Lark Mess Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[20,960]},{"parameters":{"values":{"string":[{"name":"baseId","value":"set-base-id"},{"name":"tableId","value":"set-table-id"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP","value":true},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"43eb81f9-a854-43ca-bef7-04977eae7f85","name":"Set Lark Base Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[40,560]},{"parameters":{},"id":"75e517f1-c911-42d2-acc3-8a646942a32a","name":"Start Lark Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-740,700]},{"parameters":{},"id":"8a501a60-ce4b-44fa-8b29-661f15c11c44","name":"Start Lark Base","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-180,560]},{"parameters":{},"id":"07f4fcd8-3c6c-42dc-9fcf-3b06fb249c4b","name":"Start Lark Mess","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-200,960]},{"parameters":{},"id":"9244b142-3f8a-4319-b2ff-ce9051e02ba9","name":"Start Telegram Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-700,1360]},{"parameters":{"values":{"string":[{"name":"botToken","value":"set-bot-token"},{"name":"chatId","value":"set-chat-id"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP","value":true},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"75bd554f-6d25-442e-97f6-62005e616b96","name":"Set Telegram Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[-500,1360]},{"parameters":{},"id":"035abbb9-d023-4cfc-a8fe-19bd9d6724fe","name":"Start Lark Base Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[260,540]},{"parameters":{},"id":"22f3ac8e-e555-416d-a701-329036157630","name":"Start Lark Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[240,940]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n// create message card\nlet result = {\n  msg_type: 'text',\n  content: {\n    text: `Tá»«: ${smsContent.from}\\n${smsContent.text.toString()}`,\n  },\n};\n\nreturn {\n  json: {\n    data: result,\n    customBotURL: $input.item.json.customBotURL,\n  },\n};\n"},"id":"c1903808-bfa8-4527-a03b-5a6cb0cfbbff","name":"Convert to Message Card for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,840]},{"parameters":{},"id":"310f8929-0676-4e12-8111-13dc4fbc9a9d","name":"Start Telegram Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-300,1360]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\nlet message = [];\n\nmessage.push(\n  `<b>${smsContent.from.toUpperCase()}</b>\\n`,\n  `${smsContent.text.toString()}`\n);\n\nreturn {\n  json: {\n    botToken: $input.item.json.botToken,\n    payload: {\n      chat_id: $input.item.json.chatId,\n      parse_mode: 'HTML',\n      text: message.join('\\n'),\n    },\n  },\n};\n"},"id":"ec0f7157-3b11-4db9-bbd8-e664347eda2c","name":"Create Telegram Message for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[100,1280]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"ed341278-c222-40ef-952a-89e7c0955b68","name":"ifSend","type":"n8n-nodes-base.if","typeVersion":1,"position":[860,1000]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"2eee82c9-2c72-456d-ace7-6ef5ea3ad215","name":"ifSend1","type":"n8n-nodes-base.if","typeVersion":1,"position":[820,600]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"e27c4145-6de2-4cbe-9623-afe4fcc85733","name":"ifSend2","type":"n8n-nodes-base.if","typeVersion":1,"position":[320,1440]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: smsContent.from,\n        Bank: smsContent.from,\n        'Transaction Type': 'OTP',\n        'Transaction Message': smsContent.text.toString(),\n        'Original Message': smsContent.text.toString(),\n        'Time received': smsContent.sentStamp,\n      },\n    },\n  ];\n\n  return {\n    json: {\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n"},"id":"466040ad-0739-42fd-bfd2-67c9cb97d7a6","name":"Convert to Lark Base format OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[640,360]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"de04eec1-0b3c-4ed8-89dd-0b6f59e0e1be","name":"ifOTPLarkBase","type":"n8n-nodes-base.if","typeVersion":1,"position":[440,540]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"5392e95a-ec78-46c5-8a5e-62bc2f6c87fc","name":"ifOTPLarkMess","type":"n8n-nodes-base.if","typeVersion":1,"position":[400,940]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"dbc5d368-6c20-4c25-a9b8-d88154871a2f","name":"ifOTPTelegram","type":"n8n-nodes-base.if","typeVersion":1,"position":[-120,1360]},{"parameters":{"url":"https://open.larksuite.com/anycross/trigger/callback/MGQ0Mzg1MDQ0OTQ5YmNkNzNlNWFmYzkyOTlhZDQ4OWJh","sendQuery":true,"queryParameters":{"parameters":[{"name":"originalMessage","value":"={{ $json[\"result\"][\"originalMessage\"] }}"}]},"options":{}},"id":"dbb60039-2b59-4e2c-8bd6-ef11d749d749","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1260,1280]}],"connections":{"Webhook":{"main":[[{"node":"getBankData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"ifSend","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Start Lark Base","type":"main","index":0},{"node":"Start Lark Mess","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"ifSend1","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"Start Actions","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Start Actions":{"main":[[{"node":"Start Telegram Actions","type":"main","index":0},{"node":"Start Lark Actions","type":"main","index":0}]]},"Create Telegram Message":{"main":[[{"node":"ifSend2","type":"main","index":0}]]},"Set Lark Configs":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Set Lark Mess Config":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]},"Set Lark Base Config":{"main":[[{"node":"Start Lark Base Actions","type":"main","index":0}]]},"Start Lark Actions":{"main":[[{"node":"Set Lark Configs","type":"main","index":0}]]},"Start Lark Base":{"main":[[{"node":"Set Lark Base Config","type":"main","index":0}]]},"Start Lark Mess":{"main":[[{"node":"Set Lark Mess Config","type":"main","index":0}]]},"Start Telegram Actions":{"main":[[{"node":"Set Telegram Config","type":"main","index":0}]]},"Set Telegram Config":{"main":[[{"node":"Start Telegram Mess Actions","type":"main","index":0}]]},"Start Lark Base Actions":{"main":[[{"node":"ifOTPLarkBase","type":"main","index":0}]]},"Start Lark Mess Actions":{"main":[[{"node":"ifOTPLarkMess","type":"main","index":0}]]},"Convert to Message Card for OTP":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"Start Telegram Mess Actions":{"main":[[{"node":"ifOTPTelegram","type":"main","index":0}]]},"Create Telegram Message for OTP":{"main":[[{"node":"Send to Telegram chat","type":"main","index":0}]]},"ifSend":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifSend1":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifSend2":{"main":[[{"node":"Send to Telegram chat","type":"main","index":0}]]},"Convert to Lark Base format OTP":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifOTPLarkBase":{"main":[[{"node":"Convert to Lark Base format OTP","type":"main","index":0}],[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"ifOTPLarkMess":{"main":[[{"node":"Convert to Message Card for OTP","type":"main","index":0}],[{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"ifOTPTelegram":{"main":[[{"node":"Create Telegram Message for OTP","type":"main","index":0}],[{"node":"Create Telegram Message","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"2449e842-fc52-4bce-b2bd-7f8d1a2b86c5","triggerCount":1,"tags":[]}
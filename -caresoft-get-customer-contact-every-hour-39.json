{"createdAt":"2023-03-01T04:19:30.800Z","updatedAt":"2023-03-10T07:38:06.000Z","id":"39","name":"[Caresoft] Get customer (contact) every hour","active":true,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"e7d9bb00-38bd-4e52-91c5-49c93eb718e6","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1,"position":[840,400]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"{\n    \"app_id\": \"cli_a372a34abe789010\",\n    \"app_secret\": \"DKmzzhZm18FAtMhlk2pLwczi6JVMvytI\"\n}","options":{}},"id":"6a80115e-8f14-48b1-b332-74c24788d6e4","name":"Get tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1600,400]},{"parameters":{"jsCode":"// Loop over input items and add a new field\n// called 'myNewField' to the JSON of each one\nlet startDate = new Date($('Schedule Trigger').first().json.timestamp);\nlet endDate = new Date($('Schedule Trigger').first().json.timestamp);\n\nstartDate.setHours(startDate.getHours() - 1);\n// startDate.setHours(startDate.getHours() - 720);\nstartDate.setMinutes(0);\nstartDate.setSeconds(1);\n\nreturn {\n  json: {\n    startDate: startDate.toISOString(),\n    endDate: endDate.toISOString(),\n  },\n};"},"id":"30657346-c877-40d0-bed4-5ed10eecedd1","name":"Get start time","type":"n8n-nodes-base.code","typeVersion":1,"position":[1000,400]},{"parameters":{"jsCode":"let input = $('Get customer in the last hour').first().json.contacts;\n\n// Get calls data\nlet records = input.map((contact) => {\n  let fields = {\n    id: contact.id,\n    username: contact.username,\n    phone_no:contact.phone_no, \n    updated_at: new Date(contact.updated_at).getTime(),\n    created_at: new Date(contact.created_at).getTime(),    \n  };\n  return { fields };\n});\n\nlet result = { json: { records } };\nreturn result;"},"id":"5cce7f5f-d67b-4337-976b-80224d7f4172","name":"Convert to Lark format","type":"n8n-nodes-base.code","typeVersion":1,"position":[1380,400]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/baslg7TBWBKBB5Bc5vJhovnm3Jc/tables/tbljzeaqj3GQGfGn/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('Convert to Lark format').first().json.records) }}}","options":{}},"id":"0eff6724-eca8-4b84-b0f0-410028594aec","name":"Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1800,400]},{"parameters":{"url":"https://web11.caresoft.vn/hsvn/api/v1/contacts","sendQuery":true,"queryParameters":{"parameters":[{"name":"created_since","value":"={{ $node[\"Get start time\"].json.startDate }}"},{"name":"created_to","value":"={{ $node[\"Get start time\"].json.endDate }}"},{"name":"count","value":"500"},{"name":"page","value":"1"},{"name":"order_by","value":"created_at"},{"name":"order_type","value":"desc"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"Bearer 1g6yF9w3pPbn-kc"}]},"options":{}},"id":"95f1b105-dae3-4d72-9a86-cae1cbebdfd9","name":"Get customer in the last hour","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1180,400]}],"connections":{"Schedule Trigger":{"main":[[{"node":"Get start time","type":"main","index":0}]]},"Get tenant access token":{"main":[[{"node":"Add records to Bitable","type":"main","index":0}]]},"Get start time":{"main":[[{"node":"Get customer in the last hour","type":"main","index":0}]]},"Convert to Lark format":{"main":[[{"node":"Get tenant access token","type":"main","index":0}]]},"Get customer in the last hour":{"main":[[{"node":"Convert to Lark format","type":"main","index":0}]]}},"settings":{},"staticData":{"node:Schedule Trigger":{"recurrencyRules":[]}},"pinData":{},"versionId":"7e1c9965-9a4c-490f-b84b-8213439549d1","triggerCount":1,"tags":[{"createdAt":"2023-02-27T05:42:03.910Z","updatedAt":"2023-02-27T05:42:03.910Z","id":"10","name":"Caresoft"}]}
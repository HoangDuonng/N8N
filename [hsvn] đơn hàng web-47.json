{"createdAt":"2023-03-09T04:15:49.349Z","updatedAt":"2023-03-09T06:53:39.000Z","id":"47","name":"[HSVN] ƒê∆°n h√†ng Web","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"hsvn-don-hang-web","options":{}},"id":"404cd10d-97d6-405f-832e-718f44d0ac65","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[1100,600],"webhookId":"3e7006f3-5ad9-4110-8a00-27db89f90e1f"},{"parameters":{"jsCode":"const data = $(\"Webhook\").first().json;\n\n// Order Info\nconst orderId = data.body.id;\nconst source = data.headers[\"x-wc-webhook-source\"]\n    .replace(\"http://\", \"\")\n    .replace(\"https://\", \"\")\n    .replace(\"www.\", \"\")\n    .split(/[/?#]/)[0]\n    .toUpperCase();\n\nconst modifiedDate = new Date(data.body.date_modified).toLocaleString('vi-VN');\n\nlet orderStatus = \"\";\nswitch (data.body.status) {\n    case \"pending\":\n        orderStatus = \"ƒêang ch·ªù\";\n        break;\n    case \"processing\":\n        orderStatus = \"ƒêang x·ª≠ l√Ω\";\n        break;\n    case \"on-hold\":\n        orderStatus = \"Gi·ªØ\";\n        break;\n    case \"completed\":\n        orderStatus = \"Ho√†n th√†nh\";\n        break;\n    case \"cancelled\":\n        orderStatus = \"ƒê√£ hu·ª∑\";\n        break;\n    case \"refunded\":\n        orderStatus = \"Ho√†n ti·ªÅn\";\n        break;\n    case \"failed\":\n        orderStatus = \"Th·∫•t b·∫°i\";\n        break;\n\n    case \"trash\":\n        orderStatus = \"ƒê√£ xo√°\";\n        break;\n\n    default:\n        orderStatus = \"-\";\n}\n\nconst paymentMethod = data.body.payment_method_title;\nconst discount =\n  Math.floor(+data.body.discount_total).toLocaleString(\"en-US\") + \" VND\";\nconst total = Math.floor(+data.body.total).toLocaleString(\"en-US\") + \" VND\";\n\n//Client info\nconst customerName = `${data.body.billing.last_name} ${data.body.billing.first_name}`;\nconst customerAddr = `${data.body.billing.address_1},  ${data.body.billing.city}`;\nconst customerEmail = data.body.billing.email;\nconst customerPhone = data.body.billing.phone;\nconst customerNote = data.body.customer_note;\n\n// Product info\nconst products = data.body.line_items.map((product) => {\n    const result = {\n        name: product.name,\n        quantity: product.quantity,\n        price: product.price.toLocaleString(\"en-US\") + \" VND\",\n        productTotal:\n            Math.floor(+product.total).toLocaleString(\"en-US\") + \" VND\",\n    };\n\n    return result;\n});\n\nlet result = {\n    orderId,\n    source,\n    modifiedDate,\n    orderStatus,\n    paymentMethod,\n    discount,\n    total,\n    customerName,\n    customerAddr,\n    customerEmail,\n    customerPhone,\n    customerNote,\n    products,\n};\n\nreturn result;\n"},"id":"56b9ea97-92ad-48ab-827f-03825292ba77","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[1320,600]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/02ed9414-8ff6-4013-b735-16d23d16cf3d","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Code1').first().json)}}","options":{}},"id":"7b21c048-078b-46c7-ac75-198fb869280a","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1760,600]},{"parameters":{"jsCode":"const data = $(\"Code\").first().json;\nconst products = data.products;\n\nlet elements = [];\n\n// Add products\nproducts.forEach((product) => {\n    elements.push({\n        tag: \"div\",\n        fields: [\n            {\n                is_short: false,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**S·∫£n ph·∫©m:** ${product.name}`,\n                },\n            },\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**S·ªë l∆∞·ª£ng:** ${product.quantity}`,\n                },\n            },\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**ƒê∆°n gi√°:** ${product.price}`,\n                },\n            },\n            {\n                is_short: false,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**T·∫°m t√≠nh:** ${product.productTotal}`,\n                },\n            },\n        ],\n    });\n    elements.push({\n        tag: \"hr\",\n    });\n});\n\n// Add Order Info\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**M√£ ƒë∆°n h√†ng:** ${data.orderId}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ng√†y thay ƒë·ªïi:** ${data.modifiedDate}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Tr·∫°ng th√°i:** ${data.orderStatus}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**PTTT:** ${data.paymentMethod}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Gi·∫£m gi√°:** ${data.discount}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Th√†nh ti·ªÅn:** ${data.total}`,\n            },\n        },\n    ],\n});\nelements.push({\n    tag: \"hr\",\n});\n\n// Add customer info\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**H·ªç v√† t√™n:** ${data.customerName}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**S·ªë ƒëi·ªán tho·∫°i:** ${data.customerPhone}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Email:** ${data.customerEmail}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**ƒê·ªãa ch·ªâ:** ${data.customerAddr}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ghi ch√∫:** ${data.customerNote}`,\n            },\n        },\n    ],\n});\n// elements.push({\n//     tag:'hr'\n//   })\n\n// Add action buttons\nelements.push({\n    tag: \"action\",\n    actions: [\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"X·ª≠ l√Ω ƒë∆°n h√†ng\",\n            },\n            url: `https://${data.source}/wp-admin/post.php?post=${data.orderId}&action=edit`,\n            type: \"primary\",\n        },\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"G·ªçi ƒëi·ªán t∆∞ v·∫•n\",\n            },\n            url: `tel:${data.customerPhone}`,\n            type: \"default\",\n        },\n    ],\n});\n\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"blue\",\n            title: {\n                content: `üõí M·ªòT C·∫¨P NH·∫¨T T·ª™ ${data.source} - ${data.orderId}`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\n\nreturn { json: result };"},"id":"ae6bf272-8b58-4e01-bab0-bbe89e739f92","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[1540,600]}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"WooCommerce/7.3.0 Hookshot (WordPress/6.1.1)","content-length":"2840","accept":"*/*","accept-encoding":"deflate, gzip, br","content-type":"application/json","referer":"https://app.n8n.vn/webhook-test/hsvn-don-hang-web","x-forwarded-for":"66.42.52.245","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"af4013275608","x-real-ip":"66.42.52.245","x-wc-webhook-delivery-id":"8a70d14fe7d1d84c70a7a10b1798bdd8","x-wc-webhook-event":"created","x-wc-webhook-id":"2","x-wc-webhook-resource":"order","x-wc-webhook-signature":"56L12YLGC2H0UvJnntp40uUWptMz9VxyWkVEgjItZeE=","x-wc-webhook-source":"https://vuabatmuoi.com/","x-wc-webhook-topic":"order.created"},"params":{},"query":{},"body":{"id":5972,"parent_id":0,"status":"processing","currency":"VND","version":"7.3.0","prices_include_tax":false,"date_created":"2023-03-09T11:18:37","date_modified":"2023-03-09T11:18:37","discount_total":"0","discount_tax":"0","shipping_total":"0","shipping_tax":"0","cart_tax":"0","total":"1212000","total_tax":"0","customer_id":30,"order_key":"wc_order_J9c8c5ufE9wCc","billing":{"first_name":"Tr·ª±c","last_name":"V≈© VƒÉn","company":"","address_1":"An Kh√°nh","address_2":"","city":"H√† N·ªôi","state":"","postcode":"","country":"VN","email":"lehien.adw@gmail.com","phone":"03012346845"},"shipping":{"first_name":"","last_name":"","company":"","address_1":"","address_2":"","city":"","state":"","postcode":"","country":"","phone":""},"payment_method":"cod","payment_method_title":"Thanh to√°n khi nh·∫≠n h√†ng","transaction_id":"","customer_ip_address":"117.5.76.36","customer_user_agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/110.0.0.0 Safari/537.36","created_via":"checkout","customer_note":"c·∫ßn g·ªçi l·∫°i t∆∞ v·∫•n","date_completed":null,"date_paid":null,"cart_hash":"41d0d85387f493fbbc40cd87837560d0","number":"5972","meta_data":[{"id":31015,"key":"is_vat_exempt","value":"no"}],"line_items":[{"id":220,"name":"ƒê√®n b·∫Øt mu·ªói v√† c√¥n tr√πng th√¥ng minh Nion GD04, c√¥ng su·∫•t 4W","product_id":4409,"variation_id":0,"quantity":3,"tax_class":"","subtotal":"1047000","subtotal_tax":"0","total":"1047000","total_tax":"0","taxes":[],"meta_data":[],"sku":"","price":349000,"image":{"id":"4412","src":"https://vuabatmuoi.com/wp-content/uploads/2022/11/GD14-2.jpg"},"parent_name":null},{"id":221,"name":"V·ª£t b·∫Øt mu·ªói v√† c√¥n tr√πng R·∫°ng ƒê√¥ng - Model RD.01","product_id":4816,"variation_id":0,"quantity":1,"tax_class":"","subtotal":"165000","subtotal_tax":"0","total":"165000","total_tax":"0","taxes":[],"meta_data":[],"sku":"","price":165000,"image":{"id":"4848","src":"https://vuabatmuoi.com/wp-content/uploads/2022/12/vot-muoi-rang-dong-2-1.jpg"},"parent_name":null}],"tax_lines":[],"shipping_lines":[],"fee_lines":[],"coupon_lines":[],"refunds":[],"payment_url":"https://vuabatmuoi.com/thanh-toan/order-pay/5972/?pay_for_order=true&key=wc_order_J9c8c5ufE9wCc","is_editable":false,"needs_payment":false,"needs_processing":true,"date_created_gmt":"2023-03-09T04:18:37","date_modified_gmt":"2023-03-09T04:18:37","date_completed_gmt":null,"date_paid_gmt":null,"currency_symbol":"‚Ç´","_links":{"self":[{"href":"https://vuabatmuoi.com/wp-json/wc/v3/orders/5972"}],"collection":[{"href":"https://vuabatmuoi.com/wp-json/wc/v3/orders"}],"customer":[{"href":"https://vuabatmuoi.com/wp-json/wc/v3/customers/30"}]}}}}]},"versionId":"99916087-fb8d-4f2c-aa79-29fc45c7b7b8","triggerCount":1,"tags":[]}
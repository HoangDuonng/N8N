{"createdAt":"2023-09-12T01:54:08.150Z","updatedAt":"2023-09-13T04:12:31.000Z","id":"523","name":"MieuFlow [restock]","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"mieu-restock-flow-91223","options":{}},"id":"762f9918-c698-4c52-a08f-f1f94047ed12","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-100,360],"webhookId":"185f303a-7599-4d6b-a50f-5f39c1027b62"},{"parameters":{"jsCode":"let htmlTables = '<div class=\"table-wrapper\">';\nlet tenXuongSX = \"\"; // T√™n X∆∞·ªüng SX\nlet tenSP = \"\"; // T√™n SP\nlet maRap = \"\"; // M√£ R·∫≠p\nlet lenhSXexport='';\n\nconst currentDate = new Date();\nconst month = currentDate.getMonth() + 1;\n// L·∫•y ng√†y ƒë·∫∑t h√†ng l√† ng√†y hi·ªán t·∫°i\nconst ngayDatHang = new Date();\n// S·ªë ng√†y l√†m vi·ªác c·∫ßn t√≠nh\nconst soNgayLamViec = 15;\n\n// T√≠nh to√°n ng√†y nh·∫≠n h√†ng d·ª± ki·∫øn\nlet ngayNhanHangDuKien = new Date(ngayDatHang); // Sao ch√©p ng√†y ƒë·∫∑t h√†ng\nlet countNgayLamViec = 0; // Bi·∫øn ƒë·∫øm s·ªë ng√†y l√†m vi·ªác\n\n// Ki·ªÉm tra t·ª´ng ng√†y, n·∫øu l√† ng√†y l√†m vi·ªác (t·ª´ th·ª© 2 ƒë·∫øn th·ª© 6), tƒÉng bi·∫øn ƒë·∫øm\nwhile (countNgayLamViec < soNgayLamViec) {\n  ngayNhanHangDuKien.setDate(ngayNhanHangDuKien.getDate() + 1); // TƒÉng ng√†y l√™n 1\n  const dayOfWeek = ngayNhanHangDuKien.getDay(); // L·∫•y s·ªë th·ª© t·ª± c·ªßa ng√†y trong tu·∫ßn (0: Ch·ªß nh·∫≠t, 1: Th·ª© 2, 2: Th·ª© 3, ..., 6: Th·ª© 7)\n  if (dayOfWeek > 0 && dayOfWeek < 6) { // Ki·ªÉm tra n·∫øu l√† ng√†y l√†m vi·ªác (t·ª´ th·ª© 2 ƒë·∫øn th·ª© 6)\n    countNgayLamViec++;\n  }\n}\n\n// Chu·∫©n b·ªã ƒë·ªãnh d·∫°ng ng√†y/th√°ng/nƒÉm (01/01/2023)\nconst options = { year: 'numeric', month: '2-digit', day: '2-digit' };\nconst ngayNhanHangDuKienFormatted = ngayNhanHangDuKien.toLocaleDateString('vi-VN', options);\nconst ngayDathangFormatted = ngayDatHang.toLocaleDateString('vi-VN', options);\n//xong ph·∫ßn ng√†y r·ªìi ƒë√≥\n\n// Lo·∫°i s·∫£n xu·∫•t \nlet loaisx = \"\"; // Lo·∫°i s·∫£n xu·∫•t\nfor (const item of $input.all()) {\n  for (const items of item.json.body.data.items) {\n    if (parseInt(items.fields[\"Lansx\"]) === 1) {\n      loaisx = \"M·ªõi\";\n    } else {\n      loaisx = \"Restock\";\n    }\n    // Th·ª±c hi·ªán c√°c l·ªánh kh√°c li√™n quan ƒë·∫øn l·∫ßn s·∫£n xu·∫•t t·∫°i ƒë√¢y\n  }\n}\n\nlet tongsp=0;\nfor (const item of $input.all()) {\n  for (const items of item.json.body.data.items) {\n    tongsp += parseInt(items.fields[\"üìù S\"]) || 0;;\n    tongsp += parseInt(items.fields[\"üìù M\"]) || 0;;\n    tongsp += parseInt(items.fields[\"üìù L\"]) || 0;;\n    tongsp += parseInt(items.fields[\"üìù XL\"]) || 0;;\n    tongsp += parseInt(items.fields[\"üìù FS\"]) || 0;;\n    \n  }\n}\n\n\nfor (const item of $input.all()) {\n  for (const items of item.json.body.data.items) {\n    tenXuongSX = items.fields[\"üìùT√™n X∆∞·ªüng SX\"]|| \"\";\n    tenSP = items.fields[\"T√™n SP Cha\"]?.[0]?.text || \"\";\n    const MaCha = items.fields[\"M√£ cha\"] || \"\";;\n    const maRapArray = items.fields[\"‚õî M√£ R·∫≠p\"];\n    if (Array.isArray(maRapArray) && maRapArray.length > 0) {\n      maRap = maRapArray[0]?.text || \"\";\n    }\n      // L·∫•y hai k√Ω t·ª± cu·ªëi c·ªßa M√£ nh√† cung c·∫•p\nconst maNCC = items.fields[\"M√£ NCC\"][0].text;\nconst kyTuCuoi = maNCC.slice(-2);\nconst dathangne = ngayDatHang.toLocaleDateString(\"vi-VN\", {\n  day: \"2-digit\",\n  month: \"2-digit\",\n  year: \"numeric\"\n});\n\nconst maLenhSX = `${maRap}/${kyTuCuoi}/${dathangne.replace(/\\//g, \"\")}`;\nlenhSXexport+= maLenhSX;\n\nhtmlTables += `<p>Th√°ng: ${month}</p><table><thead><tr><th class=\"bentrai bold-big\"><span style=\"color:red; font-weight:bold;\"> ${maRap}</span></th><th colspan=\"2\"><span style=\"color:red; font-weight:bold;\"> ${MaCha}</th> <th><span  class=\"bold-big\">${tenSP}</span></th></tr></thead><tbody><tr><td class=\"bentrai\">X∆∞·ªüng gia c√¥ng</td><td class=\"bold-big maudo\" style=\"color:red; font-weight:bold;\">${tenXuongSX}</td>\n      <td>S·ªë l∆∞·ª£ng SX</td>\n      <td class=\"bold-big\">${tongsp}</td>\n    </tr>\n    <tr>\n      <td class=\"bentrai\">Ng√†y ƒë·∫∑t h√†ng</td>\n      <td style=\"color:red; font-weight:bold;\">${ngayDathangFormatted}</td>\n      <td>L·ªánh SX</td>\n      <td>${maLenhSX}</td>\n    </tr>\n    <tr>\n      <td class=\"bentrai\">Ng√†y giao d·ª± ki·∫øn</td>\n      <td class=\"bold-big\">${ngayNhanHangDuKienFormatted}</td>\n      <td>Lo·∫°i SX</td>\n      <td>${loaisx}</td>\n    </tr>\n  </tbody>\n</table>\n`;\n  break; // Tho√°t kh·ªèi v√≤ng l·∫∑p sau khi l·∫•y gi√° tr·ªã ƒë·∫ßu ti√™n\n  }\n}\nfor (const item of $input.all()) {\n  for (const items of item.json.body.data.items) {\n    const MaVaiChinh = items.fields[\"M√£ V·∫£i Ch√≠nh\"] || \"\";;\n    const sizeS = items.fields[\"üìù S\"] || \"\";;\n    const sizeM = items.fields[\"üìù M\"] || \"\";;\n    const sizeL = items.fields[\"üìù L\"] || \"\";;\n    const sizeXL = items.fields[\"üìù XL\"] || \"\";;\n    const sizeFS = items.fields[\"üìù FS\"] || \"0\";;\n    const DinhMuc = items.fields[\"‚õî ƒê·ªãnh m·ª©c\"] || \"\";;\n    const SoMet = items.fields[\"T·ªïng Slg V·∫£i Ch√≠nh (m)\"] || \"\";;\n    const MaVaiPhu = items.fields[\"üìùM√£ V·∫£i ph·ª•\"] || \"\";;\n    const DinhMucPhu = items.fields[\"‚õî ƒê·ªãnh m·ª©c v·∫£i ph·ª•\"] || \"\";;\n    const TongMetPhu = items.fields[\"T·ªïng Slg V·∫£i ph·ª• (m)\"] || \"\";;  \n    const TongSML = items.fields[\"T·ªïng Slg\"] || \"\";;  \n\n        htmlTables += `\n<table>\n  <thead>\n    <tr>\n      <td colspan=\"2\" class=\"bentrai bold-big\">V·∫£i ch√≠nh:</td>\n      <td class=\"bold-big\">ƒê·ªãnh m·ª©c</td>\n      <td class=\"bold-big\">S·ªë m√©t</td>\n      <td class=\"bold-big\">S</td>\n      <td class=\"bold-big\">M</td>\n      <td class=\"bold-big\">L</td>\n      <td class=\"bold-big\">XL</td>\n      <td class=\"bold-big\">FS</td>\n      <td class=\"bold-big cot-cuoi\">T·ªïng SL</td>\n    </tr>\n  </thead>\n  <tbody>\n    <tr>\n      <td class=\"cot-1 bentrai bold-big\" rowspan=\"2\">${MaVaiChinh}</td>\n      <td class=\"cot-2\" style=\"font-weight:bold;\">Y√™u c·∫ßu</td>\n      <td class=\"cot-3 bold-big\">${DinhMuc}</td>\n      <td class=\"cot-4 bold-big\">${SoMet}</td>\n      <td class=\"cot-5 bold-big\">${sizeS}</td>\n      <td class=\"cot-5 bold-big\">${sizeM}</td>\n      <td class=\"cot-5 bold-big\">${sizeL}</td>\n      <td class=\"cot-5 bold-big\">${sizeXL}</td>\n      <td class=\"cot-5 bold-big\">${sizeFS}</td>\n      <td class=\"cot-5 bold-big\">${TongSML}</td>\n    </tr>\n    <tr>\n      <td>Th·ª±c c·∫Øt</td>\n      <td></td>\n      <td></td>\n      <td></td>\n      <td></td>\n      <td></td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <td class=\"bentrai bold-big\">V·∫£i l√≥t</td>\n      <td>${MaVaiPhu}</td>\n      <td>${DinhMucPhu}</td>\n      <td>${TongMetPhu}</td>\n      <td class=\"ghichu\" colspan=\"3\" rowspan=\"3\">*Ghi ch√∫ n·ªôi b·ªô</td>\n      <td class=\"ghichu\" colspan=\"3\" rowspan=\"3\">*Ghi ch√∫ x∆∞·ªüng</td>\n    </tr>\n    <tr>\n      <td class=\"bentrai bold-big\">N√∫t</td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n    <tr>\n      <td class=\"bentrai bold-big\">Ph·ª• li·ªáu kh√°c</td>\n      <td></td>\n      <td></td>\n      <td></td>\n    </tr>\n  </tbody>\n</table></br>\n`;\n  }\n}\n\nhtmlTables += `</div>`;\nreturn {\n  htmlTables: htmlTables,\n  lenhsx: lenhSXexport\n};"},"id":"a7d9067f-5b38-4498-b85d-506bd3e87a30","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[560,360]},{"parameters":{"html":"<!DOCTYPE html>\n\n<html>\n<head>\n  <meta charset=\"UTF-8\" />\n  <title>ƒê∆°n ƒë·∫∑t h√†ng Mieu</title>\n</head>\n<body>\n  <div class=\"container\">\n    <h1><img src=\"https://theme.hstatic.net/200000561729/1000985167/14/logo.png?v=311\" width=\"18%\"/></h1>\n    <p>  ƒê·ªãa ch·ªâ: 400/2 L√™ VƒÉn S·ªπ, Q3 </p>\n    <p>  Tel: 0902.303.006 </p>\n    <h2 style=\"text-align:center;font-size:2em;font-weight:bold;\">ƒê∆†N ƒê·∫∂T H√ÄNG</h2>\n    {{ $node[\"Code\"].json[\"htmlTables\"] }}\n    <div class=\"table-wrapper\">\n  <table class=\"bang-luu-y\">\n    <thead>\n      <tr>\n        <th>L∆∞u √Ω ph·ª• li·ªáu</th>\n        <th></th>\n        <th></th>\n        <th></th>\n      </tr>\n    </thead>\n    <tbody>\n      <tr>\n        <td>1/ D√πng keo l·ª•a/tƒÉng ƒë∆° s·∫Øt</td>\n        <td>4/ V·∫Øt s·ªï ch·ªâ Cotton</td>\n        <td></td>\n        <td></td>\n      </tr>\n      <tr>\n        <td>2/ L·∫•y k√©o ƒë·∫ßm 60cm</td>\n        <td>5/ Ch·ªâ, d√¢y k√©o, n√∫t ph·ª• li·ªáu ti·ªáp m√†u v·∫£i</td>\n        <td></td>\n        <td></td>\n      </tr>\n      <tr>\n        <td colspan=\"4\">3/ Mocking tr√™n thun d∆∞·ªõi thun</td>\n      </tr>\n    </tbody>\n  </table>\n</div>\n\n  </div>\n</body>\n</html>\n\n<style>\n.container {\n  background-color: #ffffff;\n  /*text-align: center;*/\n  padding: 16px;\n  border-radius: 8px;\n}\n\nbody{\n  text-align:left;\n}\n  .bentrai{\n  text-align:left!important;    \n  }\nh1 {\n  color: #ff6d5a;\n  font-size: 24px;\n  font-weight: bold;\n  padding: 8px;\n}\n\nh2 {\n  color: #909399;\n  font-size: 18px;\n  font-weight: bold;\n  padding: 8px;\n}\n.table-wrapper {\n    display: flex;\n    flex-direction: column;\n  }\n\n  .table-wrapper table {\n    width: 100%;\n    border-collapse: collapse;\n    font-family: Arial, sans-serif;\n    margin-bottom: 20px;\n  }\n\n  .table-wrapper th,\n  .table-wrapper td {\n    border: 1px solid #ddd;\n    padding: 8px;\n    text-align: center;\n  }\n\n  .table-wrapper th {\n    background-color: #f2f2f2;\n    font-weight: bold;\n  }\n\n  .table-wrapper tbody tr:nth-child(even) {\n    background-color: #f9f9f9;\n  }\n  .bentrai{\n    text-align: left;\n  }\n  .cot-1{\n    width:20%;\n  }\n  .cot-2,.cot-3,.cot-4{\n    width:15%;\n  }\n  .cot-5{\n   width:8%; \n  }\n  .bold-big{\n    text-transform: uppercase;\n    font-weight:bold;\n  }\n  .table-wrapper {\n  width: 100%;\n  overflow-x: auto;\n}\n\n.bang-luu-y {\n  border-collapse: collapse;\n  width: 100%;\n}\n\n.bang-luu-y th,\n.bang-luu-y td {\n  padding: 8px;\n  text-align: left;\n}\n\n.bang-luu-y th {\n  font-weight: bold;\n  background-color: #f2f2f2;\n}\n\n.bang-luu-y td {\n  border-bottom: 1px solid #ddd;\n}\n\n\n\n/* Lo·∫°i b·ªè ƒë∆∞·ªùng vi·ªÅn b·∫£ng */\n.bang-luu-y {\n  border: none;\n}\n\n.bang-luu-y th,\n.bang-luu-y td {\n  border: none;\n  \n}\n  .cot-cuoi{\n    width:20%!important;\n  }\n  .ghichu{\n    vertical-align: top;\n    text-align:left!important;\n  }\n\n</style>"},"id":"5c1e9190-541d-41cf-993d-985afcad6e04","name":"HTML","type":"n8n-nodes-base.html","typeVersion":1,"position":[800,360]},{"parameters":{"method":"POST","url":"https://hcti.io/v1/image","sendHeaders":true,"headerParameters":{"parameters":[{"name":"authorization","value":"Basic MGRiNWY0ODgtODRmNC00YzgyLTlmNWQtNDdjMWE3ZDIyNjVkOjNhNjg2NTQwLWUzNjYtNDE2ZC1hYTk0LWI0YWNmNTBkODZjYw=="}]},"sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"html","value":"={{ $json[\"html\"] }}"},{"name":"ms_delay","value":"1000"}]},"options":{}},"id":"997d16fb-6df4-4059-8a95-458706b14dfb","name":"HTTP Request2","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1240,360]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/QncPb90v9azHZRsiBsMutNctsrY/tables/tbl6zFuG4NPzXdKv/records/{{ $node[\"Webhook\"].json[\"body\"][\"record_id\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"tenantAccess\"].json[\"body\"][\"tenant_access_token\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"fields\":{\"M√£ LSX\":\"{{ $('Code').item.json[\"lenhsx\"] }}\",\"H√¨nh ƒë∆°n ƒë·∫∑t h√†ng\":{\"link\":\"{{ $json[\"url\"] }}\",\"text\":\"{{ $('Code').item.json[\"lenhsx\"] }}\"}}}","options":{"response":{"response":{"fullResponse":true}}}},"id":"4d62af54-f038-43e1-bfeb-96883ef03fa4","name":"HTTP Request3","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1460,360]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a4d6c704d9b85009"},{"name":"app_secret","value":"mY1fnsO5t2PvCRhKV6TxLfYuO5Iw57zh"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"af34837b-58f3-4fad-824f-6732695c78cf","name":"tenantAccess","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[120,360]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/QncPb90v9azHZRsiBsMutNctsrY/tables/tblhACxIpRdT4oN2/records","sendQuery":true,"queryParameters":{"parameters":[{"name":"filter","value":"=CurrentValue.[M√£ cha]=\"{{ $node[\"Webhook\"].json[\"body\"][\"macha\"] }}\"&&CurrentValue.[Lansx]=\"{{ $('Webhook').item.json.body.lansx }}\""},{"name":"page_size","value":"20"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json[\"body\"][\"tenant_access_token\"] }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"9e133571-de94-43ef-9c89-28b907db904f","name":"GetInfor","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[340,360]}],"connections":{"Webhook":{"main":[[{"node":"tenantAccess","type":"main","index":0}]]},"Code":{"main":[[{"node":"HTML","type":"main","index":0}]]},"HTML":{"main":[[{"node":"HTTP Request2","type":"main","index":0}]]},"HTTP Request2":{"main":[[{"node":"HTTP Request3","type":"main","index":0}]]},"tenantAccess":{"main":[[{"node":"GetInfor","type":"main","index":0}]]},"GetInfor":{"main":[[{"node":"Code","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"HTTP Request2":[{"json":{"url":"https://hcti.io/v1/image/51ec49c8-6afb-4262-824b-098d019a2a7d"},"pairedItem":{"item":0}}],"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"Go-http-client/2.0","content-length":"50","accept-encoding":"gzip","content-type":"application/json","x-forwarded-for":"3.211.55.69","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"3.211.55.69","x-tt-env":"prod","x-tt-logid":"02169077598240900000000000000000000ffff7002484b0d727c"},"params":{},"query":{},"body":{"macha":"D2023186","record_id":"recHN5kYIj"}}}]},"versionId":"1eea1b62-e338-40d3-b7d6-bbad60b788a7","triggerCount":1,"tags":[]}
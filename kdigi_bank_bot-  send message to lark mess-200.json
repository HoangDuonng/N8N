{"createdAt":"2023-07-19T04:40:00.876Z","updatedAt":"2023-07-29T04:57:27.000Z","id":"200","name":"KDIGI_BANK_BOT:  send message to Lark Mess","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"v2/kdigi-bank-bot-lark-mess-send-message","responseMode":"responseNode","options":{}},"id":"f97b49d3-73d6-4605-af75-ba940e1dfe6d","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[520,440],"webhookId":"8064ad7a-47a0-498c-b3f4-18a3afa54439"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $('Webhook').item.json.body.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $('Webhook').item.json.body.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let elements = [];\n\n  elements.push({\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số tài khoản**: ${data.receiverAccount}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Nội dung:** ${data.transactionMessage}`,\n        },\n      },\n    ],\n  });\n\n  // Append transaction ID if exist\n  if (data.transactionId) {\n    elements[0].fields.push({\n      is_short: false,\n      text: {\n        tag: 'lark_md',\n        content: `**Mã giao dịch:** ${data.transactionId}`,\n      },\n    });\n  }\n\n  // Append received time\n  elements[0].fields.push({\n    is_short: false,\n    text: {\n      tag: 'lark_md',\n      content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n    },\n  });\n\n  // Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\n  if ($('Webhook').item.json.body.enableBalance) {\n    const balanceIndex = elements[0].fields.findIndex((field) =>\n      field?.text?.content?.includes('Số dư thay đổi')\n    );\n    if (balanceIndex !== -1) {\n      elements[0].fields.splice(balanceIndex + 1, 0, {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n        },\n      });\n    }\n  }\n\n  // create message card\n  let result = {\n    msg_type: 'interactive',\n    card: {\n      config: {\n        wide_screen_mode: true,\n      },\n      header: {\n        template: data.larkMessConfig?.cardColor ?? 'blue',\n        title: {\n          content: `${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n            data.transactionType.type\n          }) ${data.transactionAmount.amountText}VND`,\n          tag: 'plain_text',\n        },\n      },\n      elements,\n    },\n  };\n\n  return {\n    json: {\n      isSend: true,\n      data: result,\n      customBotURL: $('Webhook').item.json.body.customBotURL,\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"347acb37-e7df-44db-9d2b-3caff1b566d9","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[1840,480]},{"parameters":{"method":"POST","url":"={{ $input.item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.data)}}","options":{}},"id":"e1646f99-14c0-43fa-98ab-520cb4368481","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2220,340]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').item.json.body;\n\n// create message card\nlet result = {\n  msg_type: 'text',\n  content: {\n    text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`,\n  },\n};\n\nreturn {\n  json: {\n    data: result,\n    customBotURL: $('Webhook').item.json.body.customBotURL,\n  },\n};\n"},"id":"f8f37b86-c2fb-4925-ae49-284161851171","name":"Convert to Message Card for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[1840,320]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"90b9eb75-3b63-4144-9f6d-e24c28c6e40c","name":"ifSend","type":"n8n-nodes-base.if","typeVersion":1,"position":[2040,480]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $('Webhook').item.json.body.enableOTP }}","value2":true}]}},"id":"10161f19-8400-4e43-89f6-4f081a7046b9","name":"ifOTPLarkMess","type":"n8n-nodes-base.if","typeVersion":1,"position":[1620,400]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"06bc057b-99f4-463a-b08e-3bfac946bbbd","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[940,440]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/v2/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"94272f69-3d6d-462f-825a-13cf125950b3","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[740,440]},{"parameters":{},"id":"6a9463bf-1fd9-43ca-ad78-2bf04b85d267","name":"Start Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1400,400]},{"parameters":{"respondWith":"json","responseBody":"{\"result\": \"Success\"}","options":{}},"id":"a8ea915d-94de-41b1-abf4-b1f5482e3312","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[2440,340]},{"parameters":{"respondWith":"json","responseBody":"{\"result\": \"Error: Bank Not Supported\"}","options":{}},"id":"1856fd31-a658-4cf4-b8f3-c1900f2c3482","name":"Respond Bank not Support","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1120,660]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $('getBankData').first().json.isBankAccepted }}","value2":true}]}},"id":"5be66fad-4f26-4afc-8b2d-bf9ba62cc860","name":"ifBankAccepted","type":"n8n-nodes-base.if","typeVersion":1,"position":[1160,420]},{"parameters":{"respondWith":"json","responseBody":"{\"result\": \"Canceled: Bank Not Accepted\"}","options":{}},"id":"5ef5873f-21cb-4514-8d09-dc9fadbd8b79","name":"Respond Bank not accepted","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[1320,580]}],"connections":{"Convert to Lark Message Card":{"main":[[{"node":"ifSend","type":"main","index":0}]]},"Convert to Message Card for OTP":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifSend":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifOTPLarkMess":{"main":[[{"node":"Convert to Message Card for OTP","type":"main","index":0}],[{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"ifBankAccepted","type":"main","index":0}],[{"node":"Respond Bank not Support","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"Webhook":{"main":[[{"node":"getBankData","type":"main","index":0}]]},"[Lark] Send noti to group chat":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]},"ifBankAccepted":{"main":[[{"node":"Start Actions","type":"main","index":0}],[{"node":"Respond Bank not accepted","type":"main","index":0}]]},"Start Actions":{"main":[[{"node":"ifOTPLarkMess","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"axios/0.21.4","content-length":"615","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","content-type":"application/json","x-forwarded-for":"172.23.0.1","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"172.23.0.1","accept-encoding":"gzip"},"params":{},"query":{},"body":{"from":"Techcombank","text":"Ma OTP cho giao dich truc tuyen cua the 4...3961 la: 742691. Ma OTP co hieu luc trong 10 phut. Vui long bao mat thong tin. Hotline: 1800588822.","sentStamp":1689410517000,"receivedStamp":1689410517697,"sim":"sim1","appId":"cli_a33cd37530b8900a","appSecret":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD","enableBalance":true,"enableOTP":true,"enableOutgoing":false,"enableIncoming":true,"customBotURL":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}}}]},"versionId":"a0207bd3-6a70-4c70-b9ab-fd5760573255","triggerCount":1,"tags":[{"createdAt":"2023-07-15T01:37:36.669Z","updatedAt":"2023-07-15T01:37:36.669Z","id":"27","name":"KDIGI"}]}
{"createdAt":"2023-07-15T12:57:02.403Z","updatedAt":"2023-07-15T12:57:28.000Z","id":"178","name":"bankbot guide","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"bank-bot-68","options":{}},"id":"422424e5-d23c-4fd1-97dd-7eccb637b004","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-660,560],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"jsCode":"const data = $(\"getBankData\").first().json.result;\n\nlet elements = [];\n\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số tài khoản**: ${data.receiverAccount}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nội dung:** ${data.transactionMessage}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã giao dịch:** ${data.transactionId}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n            },\n        },\n    ],\n});\n\n// Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\nif ($('setData').first().json.enableBalance) {\n  const balanceIndex = elements[0].fields.findIndex(\n    (field) => field?.text?.content?.includes(\"Số dư thay đổi\")\n  );\n  if (balanceIndex !== -1) {\n    elements[0].fields.splice(balanceIndex + 1, 0, {\n      is_short: false,\n      text: {\n        tag: \"lark_md\",\n        content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n      },\n    });\n  }\n}\n\n// create message card\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"blue\",\n            title: {\n                content: `${data.bankName.toUpperCase()}-${\n                    data.receiverAccount\n                } (${data.transactionType.type}) ${\n                    data.transactionAmount.amountText\n                }VND`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\n\nreturn { json: result };\n"},"id":"af8b2db4-50c2-4115-b501-61dcdbac6723","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[460,660]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $('setData').item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $('setData').item.json[\"appSecret\"] }}\" }","options":{}},"id":"927e2295-95b1-4b8d-b430-a5a818c45fcd","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[460,460]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Lark Message Card').first().json)}}","options":{}},"id":"ed5575b5-498a-4537-ba4f-0931c7cd7867","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[660,660]},{"parameters":{"jsCode":"const data = $('getBankData').first().json.result;\n\n// Convert to Lark Base format\nconst records = [\n  {\n    fields: {\n      'ID': data.bankName + '-' + data.receiverAccount,\n      'Bank': data.bankName,\n      'Account': data.receiverAccount,\n      'Transaction Type': data.transactionType.typeText,\n      'Debit':\n        data.transactionType.type === '+'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Credit':\n        data.transactionType.type === '-'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Balance': data.balance.amount,\n      'Transaction ID': data.transactionId,\n      'Transaction Message': data.transactionMessage,\n      'Original Message': data.originalMessage,\n      'Time received': data.receivedTime.timestamp,\n    },\n  },\n];\n\nconst result = { json: { records } };\nreturn result;\n"},"id":"4ce31b20-c763-4c52-b28f-37223496fd90","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[640,460]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('setData').item.json[\"baseId\"] }}/tables/{{ $('setData').item.json[\"tableId\"] }}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('Convert to Lark Base format').first().json.records) }}}","options":{}},"id":"cea83190-b135-4010-8e77-46d2a3121132","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[840,460]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"0464feed-96e0-4e34-94b7-3ee757eecf83","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[20,560]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"1fbf2bfe-754b-47b9-9d54-febafe5a8cc9","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-200,560]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $json.enableOTP }}","value2":true}]}},"id":"11e0b8be-84ec-4f32-b99f-054cbe1767f5","name":"ifOTP","type":"n8n-nodes-base.if","typeVersion":1,"position":[-200,800]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Message Card 2').first().json)}}","options":{}},"id":"57a72a75-1b58-4262-b81f-2113d3b7f1cb","name":"[Lark] Send OTP to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[240,780]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a33cd37530b8900a"},{"name":"appSecret","value":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD"},{"name":"baseId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"}]},"options":{}},"id":"9afbaddf-510f-4e63-8384-d94b43f2bea1","name":"setData","type":"n8n-nodes-base.set","typeVersion":2,"position":[-400,560]},{"parameters":{"jsCode":"const smsContent = $('Webhook').first().json.body\n\n// create message card\nlet result = {\n    msg_type: \"text\",\n    content: {\n        text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`\n    },\n};\n\nreturn { json: result };"},"id":"553c2b8b-114e-4544-a139-89dd83a3cdfd","name":"Convert to Message Card 2","type":"n8n-nodes-base.code","typeVersion":1,"position":[20,780]}],"connections":{"Webhook":{"main":[[{"node":"setData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0},{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"ifOTP":{"main":[[{"node":"Convert to Message Card 2","type":"main","index":0}]]},"setData":{"main":[[{"node":"ifOTP","type":"main","index":0},{"node":"getBankData","type":"main","index":0}]]},"Convert to Message Card 2":{"main":[[{"node":"[Lark] Send OTP to group chat","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"618d2183-2adf-46de-ba1b-588a0be9cf4f","triggerCount":1,"tags":[]}
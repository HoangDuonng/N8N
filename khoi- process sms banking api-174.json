{"createdAt":"2023-07-15T04:33:17.561Z","updatedAt":"2023-07-15T04:57:47.000Z","id":"174","name":"khoi: process SMS banking API","active":true,"nodes":[{"parameters":{"dataType":"string","value1":"={{ $('Webhook').first().json.body.from.toLowerCase()}}","rules":{"rules":[{"value2":"ocb"}]},"fallbackOutput":3},"id":"b89ea191-e8c7-435e-b2fd-680de4e1a7c1","name":"Check bank name","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1960,280]},{"parameters":{"jsCode":"const data = $('Webhook').first().json.body;\nconst splittedMsg = data.text.split('\\n');\n\nconst deeplinkSearchKeywords = {\n  ios: { search: 'oceanbank' },\n  android: { search: 'oceanbank' },\n};\n\n// Main logic\nlet result = {\n  // common info\n  bankName: getBankName(data.from),\n  receivedTime: getReceivedTime(data.sentStamp),\n  receiverAccount: getReceiverAccount(splittedMsg[1]),\n  senderAccount: getSenderAccount(splittedMsg[0]),\n\n  //transaction info\n  transactionType: getTransactionType(splittedMsg[2]),\n  transactionAmount: getTransactionAmount(splittedMsg[2]),\n  balance: getBalance(splittedMsg[4]),\n  transactionId: getTransactionId(splittedMsg[0]),\n  transactionMessage: getTransactionMessage(splittedMsg[3]),\n\n  // additional info\n  originalMessage: data.text,\n  deepLinks: deeplinkSearchKeywords,\n};\n\nreturn {\n  json: {\n    data: result,\n  },\n};\n\n/**\n * Process & Get bank name\n * @param {string} msg SMS message\n */\nfunction getBankName(msg) {\n  return msg;\n}\n\n/**\n * Convert received timestamp value\n * @param {Date} timestamp received timestamp\n */\nfunction getReceivedTime(timestamp) {\n  return {\n    text: new Date(timestamp).toLocaleString('vi-VN', {\n      timeZone: 'Asia/Ho_Chi_Minh',\n    }),\n    timestamp: timestamp,\n  };\n}\n/**\n * Get receiver account from the message\n * @param {string} msg SMS message\n */\nfunction getReceiverAccount(msg) {\n  const regex = /TK (\\d+)/;\n  const match = msg.match(regex);\n\n  if (match) {\n    return match[1];\n  }\n\n  return undefined;\n}\n\n/**\n * Get sender account from the message\n * @param {string} msg SMS message\n */\nfunction getSenderAccount(msg) {\n  return undefined;\n}\n\n/**\n * Get transaction type (deposit/withdrawal) from the message\n * @param {string} msg SMS message\n */\nfunction getTransactionType(msg) {\n  const regex = /\\(\\+\\)/;\n  const match = msg.match(regex);\n\n  if (match) {\n    const text = match[0];\n    if (text === '(+)') {\n      return {\n        text: '+',\n        type: 1,\n      };\n    } else {\n      return {\n        text: '-',\n        type: 0,\n      };\n    }\n  }\n\n  return undefined;\n}\n\n/**\n * Get transaction amount from the message\n * @param {string} msg SMS message\n */\nfunction getTransactionAmount(msg) {\n  const regex = /\\(\\+\\) (.*?) VND/;\n  const match = msg.match(regex);\n\n  if (match) {\n    const text = match[1];\n    const amount = +text.replace(/,/g, '');\n    return {\n      text,\n      amount,\n    };\n  }\n\n  return undefined;\n}\n\n/**\n * Get balance from the message\n * @param {string} msg SMS message\n */\nfunction getBalance(msg) {\n  const regex = /So du: (.*?) VND/;\n  const match = msg.match(regex);\n\n  if (match) {\n    const text = match[1];\n    const amount = +text.replace(/,/g, '');\n    return {\n      text,\n      amount,\n    };\n  }\n\n  return undefined;\n}\n\n/**\n * Get transaction ID from the message\n * @param {string} msg SMS message\n */\nfunction getTransactionId(msg) {\n  return undefined;\n}\n\n/**\n * Get transaction message from the message\n * @param {string} msg SMS message\n */\nfunction getTransactionMessage(msg) {\n  const regex = /N\\/dung: (.*)/;\n  const match = msg.match(regex);\n\n  if (match) {\n    return match[1];\n  }\n\n  return msg;\n}\n"},"id":"0c463932-24cf-47bb-a332-0184b8451937","name":"OCB","type":"n8n-nodes-base.code","typeVersion":1,"position":[2360,120]},{"parameters":{"dataType":"string","value1":"={{ $('Webhook').first().json.body.from.toLowerCase()}}","rules":{"rules":[{"value2":"ocb"}]}},"id":"13fe7a7e-f97d-42f4-a822-fa8500034241","name":"Check bank name 2","type":"n8n-nodes-base.switch","typeVersion":1,"position":[1960,600]},{"parameters":{},"id":"186bc853-5f5c-4b0f-aa78-867be6f61c70","name":"Merge deeplinks","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[1440,440]},{"parameters":{},"id":"941339df-b3c0-4b2a-b7f3-146b6104bac9","name":"Start process SMS message","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1640,440]},{"parameters":{"jsCode":"const iosLinks = $('Merge deeplinks').first().json.apps;\nconst androidLinks = $('Merge deeplinks').last().json.apps;\n\nconst extractedData = $input.first().json.data;\n\nconst deepLinks = {\n  ios: {\n    link: iosLinks.find(\n      (app) => app.appId === extractedData.deepLinks.ios.search\n    )?.deeplink,\n    search: extractedData.deepLinks.ios.search,\n  },\n  android: {\n    link: androidLinks.find(\n      (app) => app.appId === extractedData.deepLinks.android.search\n    )?.deeplink,\n    search: extractedData.deepLinks.android.search,\n  },\n};\n\nreturn {\n  json: {\n    data: {\n      ...$input.first().json.data,\n      deepLinks: { ...deepLinks },\n    },\n  },\n};\n"},"id":"8d2de57c-7c91-42de-a344-5f57b516953e","name":"Add deeplinks","type":"n8n-nodes-base.code","typeVersion":1,"position":[2660,420]},{"parameters":{"url":"https://api.vietqr.io/v2/ios-app-deeplinks","options":{}},"id":"e182f1de-af30-4593-9390-c81b9e2a3798","name":"Fetch iOS deeplinks","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1200,320]},{"parameters":{"url":"https://api.vietqr.io/v2/android-app-deeplinks","options":{}},"id":"4e873dbe-ea12-4b22-8665-a07231131a32","name":"Fetch android deeplinks","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1200,580]},{"parameters":{"httpMethod":"POST","path":"kdigi-process-sms-banking","responseMode":"responseNode","options":{"ignoreBots":true}},"id":"2d64834f-4a05-43e3-b606-1babd5edaf7a","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[940,480],"webhookId":"24dab9fe-807c-46b7-8a29-62e9d225b8ba"},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($json) }}","options":{}},"id":"ee0af9b2-c7cb-4d24-acae-f1f6227a12fd","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[2880,420]}],"connections":{"Check bank name":{"main":[[{"node":"OCB","type":"main","index":0}],[],[],[{"node":"Check bank name 2","type":"main","index":0}]]},"OCB":{"main":[[{"node":"Add deeplinks","type":"main","index":0}]]},"Merge deeplinks":{"main":[[{"node":"Start process SMS message","type":"main","index":0}]]},"Start process SMS message":{"main":[[{"node":"Check bank name","type":"main","index":0}]]},"Fetch iOS deeplinks":{"main":[[{"node":"Merge deeplinks","type":"main","index":0}]]},"Fetch android deeplinks":{"main":[[{"node":"Merge deeplinks","type":"main","index":1}]]},"Webhook":{"main":[[{"node":"Fetch iOS deeplinks","type":"main","index":0},{"node":"Fetch android deeplinks","type":"main","index":0}]]},"Add deeplinks":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"08a06fa2-13fb-479f-87ca-b3ce76a5735d","triggerCount":1,"tags":[{"createdAt":"2023-07-15T01:37:36.669Z","updatedAt":"2023-07-15T01:37:36.669Z","id":"27","name":"KDIGI"}]}
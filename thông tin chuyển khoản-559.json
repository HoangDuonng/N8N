{"createdAt":"2023-10-03T08:14:52.538Z","updatedAt":"2023-10-10T14:26:42.000Z","id":"559","name":"Thông tin chuyển khoản","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"kimhuyebanking-sms-bank-bot-api","options":{}},"id":"4e018a31-3716-42b9-8ea5-6a7ab8d2b9d8","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1840,800],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let elements = [];\n\n  elements.push({\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số tài khoản**: ${data.receiverAccount}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Nội dung:** ${data.transactionMessage}`,\n        },\n      },\n    ],\n  });\n\n  // Append transaction ID if exist\n  if (data.transactionId) {\n    elements[0].fields.push({\n      is_short: false,\n      text: {\n        tag: 'lark_md',\n        content: `**Mã giao dịch:** ${data.transactionId}`,\n      },\n    });\n  }\n\n  // Append received time\n  elements[0].fields.push({\n    is_short: false,\n    text: {\n      tag: 'lark_md',\n      content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n    },\n  });\n\n  // Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\n  if ($input.item.json.enableBalance) {\n    const balanceIndex = elements[0].fields.findIndex((field) =>\n      field?.text?.content?.includes('Số dư thay đổi')\n    );\n    if (balanceIndex !== -1) {\n      elements[0].fields.splice(balanceIndex + 1, 0, {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n        },\n      });\n    }\n  }\n\n  // create message card\n  let result = {\n    msg_type: 'interactive',\n    card: {\n      config: {\n        wide_screen_mode: true,\n      },\n      header: {\n        template: data.larkMessConfig?.cardColor ?? 'blue',\n        title: {\n          content: `${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n            data.transactionType.type\n          }) ${data.transactionAmount.amountText}VND`,\n          tag: 'plain_text',\n        },\n      },\n      elements,\n    },\n  };\n\n  return {\n    json: {\n      isSend: true,\n      data: result,\n      customBotURL: $input.item.json.customBotURL,\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"0243040e-f9ad-4fe6-b9ca-9f65adbd5f94","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[480,800]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $input.item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $input.item.json[\"appSecret\"] }}\" }","options":{}},"id":"f44f5a2f-8265-47e2-a72a-5b74372d7adf","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[-600,540]},{"parameters":{"method":"POST","url":"={{ $input.item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.data)}}","options":{}},"id":"8ffc61c6-accf-4e6d-8427-3c8d1c8a7ec4","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[860,660]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: data.bankName + '-' + data.receiverAccount,\n        Bank: data.bankName.toUpperCase(),\n        Account: data.receiverAccount,\n        'Transaction Type': data.transactionType.typeText,\n        Debit:\n          data.transactionType.type === '-'\n            ? data.transactionAmount.amount\n            : undefined,\n        Credit:\n          data.transactionType.type === '+'\n            ? data.transactionAmount.amount\n            : undefined,\n        'Transaction ID': data.transactionId,\n        'Transaction Message': data.transactionMessage,\n        'Original Message': data.originalMessage,\n        'Transaction Time': data.transactionTime.timestamp,\n        'Time received': data.receivedTime.timestamp,\n      },\n    },\n  ];\n\n  // Kiểm tra enableBalance nếu true thì thêm phần tử \"Balance\" vào mảng fields\n  if ($input.item.json.enableBalance) {\n    records[0].fields = {\n      ...records[0].fields,\n      Balance: data.balance.amount,\n    };\n  }\n\n  return {\n    json: {\n      isSend: true,\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"09887da1-05a4-4d78-8753-da8e845ed6b8","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[440,440]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $json[\"configs\"][\"baseId\"] }}/tables/{{  $json[\"configs\"][\"tableId\"]}}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($json[\"records\"]) }}}","options":{}},"id":"def3f699-559c-4965-a021-96fd233d437c","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[820,360]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"ddb03512-fbc7-42c6-9f69-2e2ffec12407","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1420,800]},{"parameters":{"method":"POST","url":"https://vn1.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"f596a682-dbb5-4ffa-a98e-395c5297f723","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1640,800]},{"parameters":{},"id":"53e89929-9104-4ea7-8890-bb3fa51fcc6f","name":"Start Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-1220,780]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a590ff0733789010"},{"name":"appSecret","value":"IOBVXyEaMXjurn1XFvqXVhlazKWsCgvB"}]},"options":{}},"id":"41ea322c-0b27-4df1-a346-4a10ff0b813f","name":"Set Lark Configs","type":"n8n-nodes-base.set","typeVersion":2,"position":[-780,540]},{"parameters":{"values":{"string":[{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/376e940f-1f97-4156-a33a-077a94561ffc"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming","value":true}]},"options":{}},"id":"5cdb717b-3883-4a4c-912c-ee328c8f38e5","name":"Set Lark Mess Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[-160,780]},{"parameters":{"values":{"string":[{"name":"baseId","value":"D98obKHmYamim8sGTgMlYR8igBe"},{"name":"tableId","value":"tblrDNv2opzOJZ3S"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP"},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"532ef467-baf9-4cd2-bc43-34b0cf0ec4bd","name":"Set Lark Base Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[-160,380]},{"parameters":{},"id":"632d4ea9-aa25-405b-9375-e173bd979ace","name":"Start Lark Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-940,540]},{"parameters":{},"id":"4ef5df54-22af-49ae-b825-0908aedbd4e8","name":"Start Lark Base","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-380,400]},{"parameters":{},"id":"5aa374e7-309e-4aeb-a475-fa7823bfa65b","name":"Start Lark Mess","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-380,760]},{"parameters":{},"id":"1f17d7bd-0a3d-4a67-a684-c438148f24cf","name":"Start Lark Base Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[60,380]},{"parameters":{},"id":"a4a4728e-c6ee-4b71-825c-0606981b003a","name":"Start Lark Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[60,740]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n// create message card\nlet result = {\n  msg_type: 'text',\n  content: {\n    text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`,\n  },\n};\n\nreturn {\n  json: {\n    data: result,\n    customBotURL: $input.item.json.customBotURL,\n  },\n};\n"},"id":"328ff714-d984-4190-8c07-2ed2f97b9374","name":"Convert to Message Card for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[480,640]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"e4f4126c-f175-4f54-bd8c-7d044e8ede8d","name":"ifSend","type":"n8n-nodes-base.if","typeVersion":1,"position":[680,800]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"9af6be42-60cc-4ac6-8bb5-5dab60e6d4d8","name":"ifSend1","type":"n8n-nodes-base.if","typeVersion":1,"position":[620,440]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: smsContent.from,\n        Bank: smsContent.from,\n        'Transaction Type': 'OTP',\n        'Transaction Message': smsContent.text.toString(),\n        'Original Message': smsContent.text.toString(),\n        'Time received': smsContent.sentStamp,\n      },\n    },\n  ];\n\n  return {\n    json: {\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n"},"id":"014dbbc9-a74d-4a27-96d9-1d35b0e45116","name":"Convert to Lark Base format OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[440,200]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"701725b3-9972-4e58-bad0-71ce72d1d8b9","name":"ifOTPLarkBase","type":"n8n-nodes-base.if","typeVersion":1,"position":[240,380]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"fb84f3bd-f322-46d6-a68a-d180e1f66394","name":"ifOTPLarkMess","type":"n8n-nodes-base.if","typeVersion":1,"position":[220,740]}],"connections":{"Webhook":{"main":[[{"node":"getBankData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"ifSend","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Start Lark Base","type":"main","index":0},{"node":"Start Lark Mess","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"ifSend1","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"Start Actions","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"Set Lark Configs":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Set Lark Mess Config":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]},"Set Lark Base Config":{"main":[[{"node":"Start Lark Base Actions","type":"main","index":0}]]},"Start Lark Actions":{"main":[[{"node":"Set Lark Configs","type":"main","index":0}]]},"Start Lark Base":{"main":[[{"node":"Set Lark Base Config","type":"main","index":0}]]},"Start Lark Mess":{"main":[[{"node":"Set Lark Mess Config","type":"main","index":0}]]},"Start Lark Base Actions":{"main":[[{"node":"ifOTPLarkBase","type":"main","index":0}]]},"Start Lark Mess Actions":{"main":[[{"node":"ifOTPLarkMess","type":"main","index":0}]]},"Convert to Message Card for OTP":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifSend":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifSend1":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"Convert to Lark Base format OTP":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifOTPLarkBase":{"main":[[{"node":"Convert to Lark Base format OTP","type":"main","index":0}],[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"ifOTPLarkMess":{"main":[[{"node":"Convert to Message Card for OTP","type":"main","index":0}],[{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"Start Actions":{"main":[[{"node":"Start Lark Actions","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"SMS Forwarder App","transfer-encoding":"chunked","accept-encoding":"gzip","content-type":"application/json; charset=utf-8","x-forwarded-for":"14.179.3.141","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"14.179.3.141"},"params":{},"query":{},"body":{"from":"SEABANK","text":"15/07/23 12:10 TK 887888 phat sinh +5,432VND. SD: 5,910VND. ND: MBVCB.3857128806.038966.LE QUOC KHO I chuyen tien abc.CT tu 6681888888 LE QUOC KHOI toi 88788...","sentStamp":1689410517000,"receivedStamp":1689410517697,"sim":"sim1"}}}],"Set Lark Mess Config":[{"json":{"name":"First item","code":1}},{"json":{"name":"Second item","code":2}}],"Set Lark Base Config":[{"json":{"name":"First item","code":1}},{"json":{"name":"Second item","code":2}}]},"versionId":"bd8c2933-f837-41ef-adb4-eb4d2e9cd28c","triggerCount":1,"tags":[]}
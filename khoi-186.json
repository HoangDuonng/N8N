{"createdAt":"2023-07-17T22:26:41.596Z","updatedAt":"2023-07-17T23:16:58.000Z","id":"186","name":"khoi","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"template-kdigi-bank-bot-api","options":{}},"id":"7229ee87-dd8a-4f8a-a750-b88894672e50","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-880,520],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"jsCode":"const data = $(\"getBankData\").first().json.result;\n\nlet elements = [];\n\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số tài khoản**: ${data.receiverAccount}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nội dung:** ${data.transactionMessage}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã giao dịch:** ${data.transactionId}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n            },\n        },\n    ],\n});\n\n// Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\nif ($('setData').first().json.enableBalance) {\n  const balanceIndex = elements[0].fields.findIndex(\n    (field) => field?.text?.content?.includes(\"Số dư thay đổi\")\n  );\n  if (balanceIndex !== -1) {\n    elements[0].fields.splice(balanceIndex + 1, 0, {\n      is_short: false,\n      text: {\n        tag: \"lark_md\",\n        content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n      },\n    });\n  }\n}\n\n// create message card\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"blue\",\n            title: {\n                content: `${data.bankName.toUpperCase()}-${\n                    data.receiverAccount\n                } (${data.transactionType.type}) ${\n                    data.transactionAmount.amountText\n                }VND`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\n\nreturn { json: result };\n"},"id":"d3003d3a-87d8-4901-a62c-a5c648ff3cbf","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[300,420]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $('setData').item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $('setData').item.json[\"appSecret\"] }}\" }","options":{}},"id":"77a0473f-8061-4147-8601-8b7dcd34832f","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[300,200]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Lark Message Card').first().json)}}","options":{}},"id":"0bc070d9-aeae-40fd-8cb3-71bfccdbc05c","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[480,420]},{"parameters":{"jsCode":"const data = $('getBankData').first().json.result;\n\n// Convert to Lark Base format\nconst records = [\n  {\n    fields: {\n      'ID': data.bankName + '-' + data.receiverAccount,\n      'Bank': data.bankName,\n      'Account': data.receiverAccount,\n      'Transaction Type': data.transactionType.typeText,\n      'Debit':\n        data.transactionType.type === '+'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Credit':\n        data.transactionType.type === '-'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Balance': data.balance.amount,\n      'Transaction ID': data.transactionId,\n      'Transaction Message': data.transactionMessage,\n      'Original Message': data.originalMessage,\n      'Time received': data.receivedTime.timestamp,\n    },\n  },\n];\n\nconst result = { json: { records } };\nreturn result;\n"},"id":"dfab3664-f373-4454-afcf-37ba81e7e4f2","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[460,200]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('setData').item.json[\"baseId\"] }}/tables/{{ $('setData').item.json[\"tableId\"] }}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('Convert to Lark Base format').first().json.records) }}}","options":{}},"id":"f83a4a91-81fc-4a97-9400-fb0d82a03954","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[640,200]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"ac04b62c-6ef3-40b3-b85f-843032809b3c","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[-200,520]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"6752d6a5-08dd-4b3b-bfee-bf257648840f","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-420,520]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $json.enableOTP }}","value2":true}]}},"id":"aa36414f-b21c-4259-9c38-5298db3da5a5","name":"ifOTP","type":"n8n-nodes-base.if","typeVersion":1,"position":[-420,760]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Message Card 2').first().json)}}","options":{}},"id":"0b94a462-de4b-4b9b-9126-d77c2b0c57f5","name":"[Lark] Send OTP to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[20,740]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a33cd37530b8900a"},{"name":"appSecret","value":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD"},{"name":"baseId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing","value":true}]},"options":{}},"id":"eaca57f2-2329-4c12-b2f5-70e8e345874c","name":"setData","type":"n8n-nodes-base.set","typeVersion":2,"position":[-620,520]},{"parameters":{"jsCode":"const smsContent = $('Webhook').first().json.body\n\n// create message card\nlet result = {\n    msg_type: \"text\",\n    content: {\n        text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`\n    },\n};\n\nreturn { json: result };"},"id":"e1b36fc1-4b1f-4a62-bc53-0eed005140e1","name":"Convert to Message Card 2","type":"n8n-nodes-base.code","typeVersion":1,"position":[-200,740]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('getBankData').item.json.result.transactionType.type }}","value2":"-"}],"boolean":[{"value1":"={{ $('setData').item.json.enableOutgoing }}","value2":true}]}},"id":"31153763-4bf8-41c3-a4d3-11f346915f04","name":"ifOutGoingEnable","type":"n8n-nodes-base.if","typeVersion":1,"position":[40,220]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('getBankData').item.json.result.transactionType.type }}","value2":"+"}]}},"id":"78e00a1e-9c52-4896-9510-196b2a48e2fe","name":"ifIncoming","type":"n8n-nodes-base.if","typeVersion":1,"position":[40,400]}],"connections":{"Webhook":{"main":[[{"node":"setData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"ifOutGoingEnable","type":"main","index":0},{"node":"ifIncoming","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"ifOTP":{"main":[[{"node":"Convert to Message Card 2","type":"main","index":0}]]},"setData":{"main":[[{"node":"ifOTP","type":"main","index":0},{"node":"getBankData","type":"main","index":0}]]},"Convert to Message Card 2":{"main":[[{"node":"[Lark] Send OTP to group chat","type":"main","index":0}]]},"ifOutGoingEnable":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0},{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"ifIncoming":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0},{"node":"Convert to Lark Message Card","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"aa653087-d1c0-494f-8b0f-b86758997697","triggerCount":0,"tags":[]}
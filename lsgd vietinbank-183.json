{"createdAt":"2023-07-17T11:08:02.944Z","updatedAt":"2023-07-18T04:36:09.000Z","id":"183","name":"LSGD Vietinbank","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"template-kdigi-bank-bot-api","options":{}},"id":"e17829d5-2830-45d6-adf4-6b3c9c41ffb2","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-720,780],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"jsCode":"const data = $(\"getBankData\").first().json.result;\n\nlet elements = [];\n\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số tài khoản**: ${data.receiverAccount}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nội dung:** ${data.transactionMessage}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã giao dịch:** ${data.transactionId}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n            },\n        },\n    ],\n});\n\n// Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\nif ($('setData').first().json.enableBalance) {\n  const balanceIndex = elements[0].fields.findIndex(\n    (field) => field?.text?.content?.includes(\"Số dư thay đổi\")\n  );\n  if (balanceIndex !== -1) {\n    elements[0].fields.splice(balanceIndex + 1, 0, {\n      is_short: false,\n      text: {\n        tag: \"lark_md\",\n        content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n      },\n    });\n  }\n}\n\n// create message card\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"blue\",\n            title: {\n                content: `${data.bankName.toUpperCase()}-${\n                    data.receiverAccount\n                } (${data.transactionType.type}) ${\n                    data.transactionAmount.amountText\n                }VND`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\n\nreturn { json: result };\n"},"id":"d13cfab5-19b4-4988-ac0a-1a1fca4d1d7d","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[460,680]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $('setData').item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $('setData').item.json[\"appSecret\"] }}\" }","options":{}},"id":"2fa53e0b-8607-48e5-8f81-1d059ebcb25c","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[460,460]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Lark Message Card').first().json)}}","options":{}},"id":"cfb2124c-82a8-49bd-ac2a-622923beed53","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[640,680]},{"parameters":{"jsCode":"const data = $('getBankData').first().json.result;\n\n// Convert to Lark Base format\nconst records = [\n  {\n    fields: {\n      'ID': data.bankName + '-' + data.receiverAccount,\n      'Bank': data.bankName,\n      'Account': data.receiverAccount,\n      'Transaction Type': data.transactionType.typeText,\n      'Debit':\n        data.transactionType.type === '+'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Credit':\n        data.transactionType.type === '-'\n          ? data.transactionAmount.amount\n          : undefined,\n      'Balance': data.balance.amount,\n      'Transaction ID': data.transactionId,\n      'Transaction Message': data.transactionMessage,\n      'Original Message': data.originalMessage,\n      'Time received': data.receivedTime.timestamp,\n    },\n  },\n];\n\nconst result = { json: { records } };\nreturn result;\n"},"id":"51cb1b2d-3227-4f86-bfa3-5764058e2e3c","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[620,460]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('setData').item.json[\"baseId\"] }}/tables/{{ $('setData').item.json[\"tableId\"] }}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('Convert to Lark Base format').first().json.records) }}}","options":{}},"id":"1c62a4de-057b-4fcf-9d52-3192f0fe1c36","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[800,460]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"c7c5e121-c468-43ba-8015-9e96fcf7042e","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[-40,780]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"14ea6c0b-eb12-4c8d-9365-859e814601ea","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-260,780]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $json.enableOTP }}","value2":true}]}},"id":"c66c1951-4e9a-4dc0-af49-dd0d657def36","name":"ifOTP","type":"n8n-nodes-base.if","typeVersion":1,"position":[-260,1020]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Message Card 2').first().json)}}","options":{}},"id":"f4f7f84d-344d-4f50-854f-d62137cbe7c7","name":"[Lark] Send OTP to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[180,1000]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a33cd37530b8900a"},{"name":"appSecret","value":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD"},{"name":"baseId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing","value":true}]},"options":{}},"id":"13eb80ad-a898-4cb5-827d-ddec37e802ec","name":"setData","type":"n8n-nodes-base.set","typeVersion":2,"position":[-460,780]},{"parameters":{"jsCode":"const smsContent = $('Webhook').first().json.body\n\n// create message card\nlet result = {\n    msg_type: \"text\",\n    content: {\n        text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`\n    },\n};\n\nreturn { json: result };"},"id":"a3502fa8-c502-4a11-a863-035d8a74413d","name":"Convert to Message Card 2","type":"n8n-nodes-base.code","typeVersion":1,"position":[-40,1000]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('getBankData').item.json.result.transactionType.type }}","value2":"-"}],"boolean":[{"value1":"={{ $('setData').item.json.enableOutgoing }}","value2":true}]}},"id":"0a8ba921-561e-47cd-9bd6-c122c44380d3","name":"ifOutGoingEnable","type":"n8n-nodes-base.if","typeVersion":1,"position":[200,480]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('getBankData').item.json.result.transactionType.type }}","value2":"+"}]}},"id":"7760f1c6-526e-4af5-8d62-d004f56d2db7","name":"ifIncoming","type":"n8n-nodes-base.if","typeVersion":1,"position":[200,660]}],"connections":{"Webhook":{"main":[[{"node":"setData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"ifOutGoingEnable","type":"main","index":0},{"node":"ifIncoming","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"ifOTP":{"main":[[{"node":"Convert to Message Card 2","type":"main","index":0}]]},"setData":{"main":[[{"node":"ifOTP","type":"main","index":0},{"node":"getBankData","type":"main","index":0}]]},"Convert to Message Card 2":{"main":[[{"node":"[Lark] Send OTP to group chat","type":"main","index":0}]]},"ifOutGoingEnable":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0},{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"ifIncoming":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0},{"node":"Convert to Lark Message Card","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"b2d7d346-ebbc-4217-9712-e18e4835dfbe","triggerCount":0,"tags":[]}
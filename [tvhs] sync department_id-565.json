{"createdAt":"2023-10-22T09:50:34.032Z","updatedAt":"2023-10-22T11:53:29.000Z","id":"565","name":"[TVHs] Sync department_id","active":true,"nodes":[{"parameters":{"content":"CẬP NHẬT DỮ LIỆU NGƯỜI DÙNG","height":112.38076641835649,"width":2711.969770520628},"id":"0710fdd2-5bc1-41a8-b9cd-7b4f4b3ccc4a","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4580,980]},{"parameters":{"method":"POST","url":"\t https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a5be1ab736b8d010"},{"name":"app_secret","value":"3lezUeP1xJ4DlnQuMpbSUbmYv45LzUXd"}]},"options":{}},"id":"ff4631c9-6427-42b7-bc7d-c9022a1102b3","name":"tenant_access_token1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-5494,2820]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.data.items.length }}","operation":"largerEqual","value2":1}]}},"id":"34b17d47-b050-4e16-8511-79ae03509c4b","name":"Has children_department?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1860,2100]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst input = $('Get parent department info').item.json.data.items;\nconst arr=[]\nfor (const item of input)\n  {\n    // const jsonValue = JSON.parse();\n    arr.push({'open_department_id': item.open_department_id});\n  }\nreturn arr;\n"},"id":"5e657493-fbfa-4c49-9da7-ce03dc6d3621","name":"get open_parent_department_id1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2400,2420]},{"parameters":{"batchSize":1,"options":{}},"id":"f7a545ef-3229-4ec3-8557-d739291c9c74","name":"Split open_parent_department_id1","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-2360,2120]},{"parameters":{},"id":"9ce59c9e-8b0c-4047-861f-bbe1d5d11c76","name":"Merge1","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[-1160,2480]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n// const list_department = $items('get open_parent_department_id1');\nconst input = $('Has children_department?1').item.json.data.items;\nconst arr=[]\nfor (const item of input)\n  {\n    arr.push({'open_department_id': item.open_department_id});\n  }\n\nreturn arr;\n"},"id":"890d94e0-4475-414c-a8a7-83aacfdd14f5","name":"Get children_open_department_id1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1600,2080]},{"parameters":{"batchSize":1,"options":{"reset":false}},"id":"c09360b5-ad68-4d83-bf34-907471f68e7a","name":"Split In Batches","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-4160,2340],"disabled":true},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/FeLlbhoTCagj3UsV87ll1gUlgrh/tables/tblYM24P512SjPfP/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token1').item.json.tenant_access_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"1747bc02-b030-4dd2-b464-b446d4fc1690","name":"Add record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-3360,2040],"disabled":true},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst output = $input.item.json;\nreturn {'fields': {'department_id': output.open_department_id, 'department_name': output.name}};"},"id":"a1b43b7a-a475-4431-8fa9-88ecfa6e25ba","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[-3840,2040],"disabled":true},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst output = $('Get parent department info').item.json.data.items;\nreturn {'output': output};"},"id":"73fb4499-dfd3-4c10-8afb-1ac2c9215a12","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[-4760,2820]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst output = $('Get children department info').item.json.data.items;\nreturn output;"},"id":"911b3c68-640a-4ff1-a4a1-da7a510d9289","name":"Code2","type":"n8n-nodes-base.code","typeVersion":1,"position":[-2540,2020]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.data.items.length }} > 0","value2":"=True"}]}},"id":"e3652385-f048-43c8-b7f9-dd637331d2e6","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[-2820,2040]},{"parameters":{"batchSize":1,"options":{}},"id":"c72234f4-8fca-4a99-bc9f-15ee7f66b79d","name":"Split In Batches1","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-2340,2020]},{"parameters":{"conditions":{"boolean":[{"value1":"={{$node[\"Split In Batches1\"].context[\"noItemsLeft\"]}}","value2":true}]}},"id":"986919fd-4920-43d2-92a3-e4386d7ca562","name":"IF batch over","type":"n8n-nodes-base.if","typeVersion":1,"position":[-2100,2000]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n$(\"Set department_id_list\").json[\"department_id_list\"] += $('Split In Batches').itemt.json.department_id + ',';\n"},"id":"05651f55-a3ba-40c7-95b7-23576c48f946","name":"Code3","type":"n8n-nodes-base.code","typeVersion":1,"position":[-3620,2040]},{"parameters":{"values":{"string":[{"name":"department_id_list"}]},"options":{"dotNotation":false}},"id":"380253c0-ea5c-4c6b-9d08-3019953e9d2e","name":"Set department_id_list","type":"n8n-nodes-base.set","typeVersion":2,"position":[-5000,2820]},{"parameters":{"url":"https://open.larksuite.com/open-apis/contact/v3/departments/0/children","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.tenant_access_token }}"}]},"options":{}},"id":"a5c507db-453d-46a5-8034-ffd82abc423d","name":"Get parent department info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-5240,2820]},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":1}]}},"id":"d0cdbfa6-9077-40db-8899-ae41a0c68566","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-5800,2820]},{"parameters":{"fieldToSplitOut":"output","options":{}},"id":"008266ad-fa04-4494-865e-005f08070bdb","name":"Item Lists","type":"n8n-nodes-base.itemLists","typeVersion":2.1,"position":[-4540,2820],"alwaysOutputData":true},{"parameters":{"keepOnlySet":true,"values":{"string":[{"name":"open_department_id","value":"={{ $json.open_department_id }}"},{"name":"name","value":"={{ $json.name }}"}]},"options":{}},"id":"f5bd50d6-e7bb-478d-8ec9-8a2ff831e5eb","name":"Set department info","type":"n8n-nodes-base.set","typeVersion":2,"position":[-4320,2820]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.data.items.length }} >0","value2":"true"}]}},"id":"d74c58de-eb34-4299-ac7d-be36f35adecd","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-3820,2820]},{"parameters":{"fieldToSplitOut":"output","options":{}},"id":"840c5bad-b5ab-4a48-bf6b-e2df62abccca","name":"Item Lists1","type":"n8n-nodes-base.itemLists","typeVersion":2.1,"position":[-3260,2560],"alwaysOutputData":true},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst output = $('Get childern department info').item.json.data.items;\nreturn {'output': output};"},"id":"b0c97ecb-7431-43f7-a1e8-5f9568d97ffb","name":"Code4","type":"n8n-nodes-base.code","typeVersion":1,"position":[-3540,2560]},{"parameters":{"url":"=https://open.larksuite.com/open-apis/contact/v3/departments/{{ $json.open_department_id }}/children   ","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token1').item.json.tenant_access_token }}"}]},"options":{}},"id":"0b836a37-b066-42fc-b1ea-574be98cd19a","name":"Get children department info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-4040,2820]}],"connections":{"tenant_access_token1":{"main":[[{"node":"Get parent department info","type":"main","index":0}]]},"Has children_department?1":{"main":[[{"node":"Get children_open_department_id1","type":"main","index":0}],[{"node":"Split open_parent_department_id1","type":"main","index":0}]]},"get open_parent_department_id1":{"main":[[{"node":"Split open_parent_department_id1","type":"main","index":0},{"node":"Merge1","type":"main","index":1}]]},"Get children_open_department_id1":{"main":[[{"node":"Merge1","type":"main","index":0},{"node":"Split open_parent_department_id1","type":"main","index":0}]]},"Split In Batches":{"main":[[{"node":"Code","type":"main","index":0},{"node":"Code3","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Item Lists","type":"main","index":0}]]},"IF":{"main":[[{"node":"Code2","type":"main","index":0}],[{"node":"Split In Batches1","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Split In Batches1","type":"main","index":0}]]},"Split In Batches1":{"main":[[{"node":"IF batch over","type":"main","index":0}],[{"node":"IF batch over","type":"main","index":0}]]},"IF batch over":{"main":[[{"node":"Split In Batches","type":"main","index":0}],[{"node":"Code","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Add record","type":"main","index":0}]]},"Set department_id_list":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Get parent department info":{"main":[[{"node":"Set department_id_list","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"tenant_access_token1","type":"main","index":0}]]},"Item Lists":{"main":[[{"node":"Set department info","type":"main","index":0}]]},"Set department info":{"main":[[{"node":"Get children department info","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Code4","type":"main","index":0}]]},"Get children department info":{"main":[[{"node":"IF1","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Item Lists1","type":"main","index":0}]]},"Item Lists1":{"main":[[{"node":"Set department info","type":"main","index":0}]]}},"settings":{},"staticData":{"node:Schedule Trigger":{"recurrencyRules":[]},"node:Schedule Trigger1":{"recurrencyRules":[]}},"pinData":{},"versionId":"39fa89b8-b283-44a4-b679-861ba00a6376","triggerCount":1,"tags":[]}
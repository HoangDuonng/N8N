{"createdAt":"2023-07-19T04:28:38.533Z","updatedAt":"2023-07-26T03:43:04.000Z","id":"198","name":"KDIGI_BANK_BOT: webhook catch balance sms & extract data version 2","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"v2/template-kdigi-bank-bot-api","options":{}},"id":"1cd2f688-1eee-4f5a-937a-14986e1675c5","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-720,2620],"webhookId":"4dc22ead-b2fa-4fcd-aab6-92ef44495c3b"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: data.bankName + '-' + data.receiverAccount,\n        Bank: data.bankName.toUpperCase(),\n        Account: data.receiverAccount,\n        'Transaction Type': data.transactionType.typeText,\n        Debit:\n          data.transactionType.type === '+'\n            ? data.transactionAmount.amount\n            : undefined,\n        Credit:\n          data.transactionType.type === '-'\n            ? data.transactionAmount.amount\n            : undefined,\n        'Transaction ID': data.transactionId,\n        'Transaction Message': data.transactionMessage,\n        'Original Message': data.originalMessage,\n        'Time received': data.receivedTime.timestamp,\n      },\n    },\n  ];\n\n  // Kiểm tra enableBalance nếu true thì thêm phần tử \"Balance\" vào mảng fields\n  if ($input.item.json.enableBalance) {\n    records[0].fields = {\n      ...records[0].fields,\n      Balance: data.balance.amount,\n    };\n  }\n\n  return {\n    json: {\n      isSend: true,\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"e9a19e49-b1a0-42ce-b0da-afcc27b05d25","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[1340,2280]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $json[\"configs\"][\"baseId\"] }}/tables/{{  $json[\"configs\"][\"tableId\"]}}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($json[\"records\"]) }}}","options":{}},"id":"dd8b6d70-796d-4017-ae95-0613486efd8d","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1720,2200]},{"parameters":{},"id":"10eb935b-5804-4a17-b089-1319fe9666ad","name":"Start Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-280,2620]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let message = [];\n\n  message.push(\n    `<b>${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n      data.transactionType.type\n    }) ${data.transactionAmount.amountText}VND</b>\\n`,\n    `<b>Ngân hàng:</b> ${data.bankName.toUpperCase()}`,\n    `<b>Số tài khoản:</b> ${data.receiverAccount}`,\n    `<b>Số dư thay đổi:</b> ${data.transactionType.type} ${data.transactionAmount.amountText} VND`\n  );\n\n  // Add balance\n  if ($input.item.json.enableBalance) {\n    message.push(`<b>Số dư tạm tính:</b> ${data.balance.amountText} VND`);\n  }\n\n  message.push(`<b>Nội dung:</b>\\n ${data.transactionMessage}`);\n\n  // Check transaction ID\n  if (data.transactionId) {\n    message.push(`<b>Mã giao dịch:</b> ${data.transactionId}`);\n  }\n\n  message.push(`<b>Thời gian nhận:</b> ${data.receivedTime.text}`);\n\n  return {\n    json: {\n      isSend: true,\n      botToken: $input.item.json.botToken,\n      payload: {\n        chat_id: $input.item.json.chatId,\n        parse_mode: 'HTML',\n        text: message.join('\\n'),\n      },\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"8c220139-51d0-453c-8107-f10d1dcecf64","name":"Create Telegram Message","type":"n8n-nodes-base.code","typeVersion":1,"position":[520,3240]},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot{{ $input.item.json.botToken }}/sendMessage ","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.payload) }}","options":{}},"id":"0f3ebdaf-a996-4d48-bc50-59c29889cd0e","name":"Send to Telegram chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[980,3160]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a33cd37530b8900a"},{"name":"appSecret","value":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD"}]},"options":{}},"id":"9766a687-db80-4b31-a523-f252edb552d1","name":"Set Lark Configs","type":"n8n-nodes-base.set","typeVersion":2,"position":[180,2380]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv,vib"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming","value":true}]},"options":{}},"id":"63dba413-0a96-4296-8e4b-86c6aa6c7fe0","name":"Set Lark Mess Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[740,2520]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv"},{"name":"baseId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP","value":true},{"name":"enableOutgoing"},{"name":"enableIncoming","value":true}]},"options":{}},"id":"fa2f9b7d-1cf7-45db-8b97-b70e5c9644db","name":"Set Lark Base Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[740,2120]},{"parameters":{},"id":"905bb864-4fad-48bd-8db1-1f570031d24b","name":"Start Lark Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-40,2380]},{"parameters":{},"id":"3245c741-6c5e-44b4-ad76-145066faf385","name":"Start Lark Base","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[520,2240]},{"parameters":{},"id":"33b310c4-822c-4b4c-851a-70719abe17c8","name":"Start Lark Mess","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[520,2600]},{"parameters":{},"id":"6d711d20-b8f9-4dab-9ff0-c15b4176d206","name":"Start Telegram Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-280,3160]},{"parameters":{"values":{"string":[{"name":"botToken","value":"6141412510:AAEVEPZcCa7Hehbb9pfnX7M9cpd0f5rK1q4"},{"name":"chatId","value":"-1001958985351"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming"}]},"options":{}},"id":"f1ddd135-ebb4-4710-b4d4-7a444fab95c8","name":"Set Telegram Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[-80,3040]},{"parameters":{},"id":"164b5b3c-eaf3-45b9-9295-5a16002f30c4","name":"Start Lark Base Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[960,2220]},{"parameters":{},"id":"496485af-d420-447d-b5d1-39bfaea0090d","name":"Start Lark Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[960,2580]},{"parameters":{},"id":"699b97b7-de7d-4ad7-88d5-07c07190d653","name":"Start Telegram Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[120,3160]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\nlet message = [];\n\nmessage.push(\n  `<b>${smsContent.from.toUpperCase()}</b>\\n`,\n  `${smsContent.text.toString()}`\n);\n\nreturn {\n  json: {\n    botToken: $input.item.json.botToken,\n    payload: {\n      chat_id: $input.item.json.chatId,\n      parse_mode: 'HTML',\n      text: message.join('\\n'),\n    },\n  },\n};\n"},"id":"c824b5ce-a945-4f68-883d-122b6319f1ec","name":"Create Telegram Message for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[520,3080]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv,vib"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/e992e2f1-ab1d-42fd-b217-2277b9df58aa"}],"boolean":[{"name":"enableBalance","value":true},{"name":"enableOTP"},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"abec4885-55af-416a-9027-df3164555235","name":"Set Lark Mess Config1","type":"n8n-nodes-base.set","typeVersion":2,"position":[740,2700]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"c03ede41-0e04-4a28-9bf2-0a343fcc2019","name":"ifSend1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1520,2280]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv"},{"name":"baseId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming"}]},"options":{}},"id":"63e8f1db-13c1-4933-938f-a0828b0adcf9","name":"Set Lark Base Config1","type":"n8n-nodes-base.set","typeVersion":2,"position":[740,2280]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv"},{"name":"botToken","value":"6380831923:AAFzYGZTFmXbqKWgNu6Drj6IbERm2j9XYQ8"},{"name":"chatId","value":"-1001958985351"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming"}]},"options":{}},"id":"9549f654-8bb2-44b3-b106-1838a74424b1","name":"Set Telegram Config1","type":"n8n-nodes-base.set","typeVersion":2,"position":[-80,3280]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"6c2dc765-c600-41e4-8234-63bf3cc1786c","name":"ifSend2","type":"n8n-nodes-base.if","typeVersion":1,"position":[740,3240]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv"},{"name":"botToken","value":"6319174707:AAGXbX_bYMcHUTK0gD6WT159QUL3RqMJ_lo"},{"name":"chatId","value":"-1001958985351"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing"},{"name":"enableIncoming"}]},"options":{}},"id":"f376f57e-f43a-4fe6-aaca-1d3df70e6a26","name":"Set Telegram Config2","type":"n8n-nodes-base.set","typeVersion":2,"position":[-80,3480]},{"parameters":{"values":{"string":[{"name":"acceptedBanks","value":"vietcombank,bidv,vib"},{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/3b18fb71-01b6-4429-8ff7-ab87c12cdad0"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP","value":true},{"name":"enableOutgoing"},{"name":"enableIncoming","value":true}]},"options":{}},"id":"4cf9022a-f45b-4170-85c2-1975070b1c85","name":"Set Lark Mess Config2","type":"n8n-nodes-base.set","typeVersion":2,"position":[740,2860]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n  // Convert to Lark Base format\n  const records = [\n    {\n      fields: {\n        ID: smsContent.from,\n        Bank: smsContent.from,\n        'Transaction Type': 'OTP',\n        'Transaction Message': smsContent.text.toString(),\n        'Original Message': smsContent.text.toString(),\n        'Time received': smsContent.sentStamp,\n      },\n    },\n  ];\n\n  return {\n    json: {\n      records,\n      configs: {\n        baseId: $input.item.json.baseId,\n        tableId: $input.item.json.tableId,\n      },\n    },\n  };\n"},"id":"8b90bceb-f4b3-4ef4-a9fe-913a0c3d3539","name":"Convert to Lark Base format OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[1340,2040]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"03e7691a-ff41-45dd-a10c-be0df0380e4c","name":"ifOTPLarkBase","type":"n8n-nodes-base.if","typeVersion":1,"position":[1140,2220]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"a2341d1d-ed1a-47f6-85c9-74e14da8cadf","name":"ifOTPTelegram","type":"n8n-nodes-base.if","typeVersion":1,"position":[300,3160]},{"parameters":{"jsCode":"return $input.first().json.body"},"id":"47a72a87-1d16-42aa-838b-baea19e1b0e7","name":"Get SMS data","type":"n8n-nodes-base.code","typeVersion":1,"position":[-500,2620]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/v2/kdigi-bank-bot-lark-mess-send-message","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json) }}","options":{}},"id":"4eb81524-8fb2-4fe7-8ae2-f57260f60b54","name":"Call KDIGI Lark Mess API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1180,2580]}],"connections":{"Webhook":{"main":[[{"node":"Get SMS data","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"ifSend1","type":"main","index":0}]]},"Start Actions":{"main":[[{"node":"Start Lark Actions","type":"main","index":0}]]},"Create Telegram Message":{"main":[[{"node":"ifSend2","type":"main","index":0}]]},"Set Lark Configs":{"main":[[{"node":"Start Lark Mess","type":"main","index":0}]]},"Set Lark Mess Config":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]},"Set Lark Base Config":{"main":[[{"node":"Start Lark Base Actions","type":"main","index":0}]]},"Start Lark Actions":{"main":[[{"node":"Set Lark Configs","type":"main","index":0}]]},"Start Lark Base":{"main":[[{"node":"Set Lark Base Config","type":"main","index":0},{"node":"Set Lark Base Config1","type":"main","index":0}]]},"Start Lark Mess":{"main":[[{"node":"Set Lark Mess Config","type":"main","index":0},{"node":"Set Lark Mess Config1","type":"main","index":0},{"node":"Set Lark Mess Config2","type":"main","index":0}]]},"Start Telegram Actions":{"main":[[{"node":"Set Telegram Config","type":"main","index":0},{"node":"Set Telegram Config1","type":"main","index":0},{"node":"Set Telegram Config2","type":"main","index":0}]]},"Set Telegram Config":{"main":[[{"node":"Start Telegram Mess Actions","type":"main","index":0}]]},"Start Lark Base Actions":{"main":[[{"node":"ifOTPLarkBase","type":"main","index":0}]]},"Start Lark Mess Actions":{"main":[[{"node":"Call KDIGI Lark Mess API","type":"main","index":0}]]},"Start Telegram Mess Actions":{"main":[[{"node":"ifOTPTelegram","type":"main","index":0}]]},"Create Telegram Message for OTP":{"main":[[{"node":"Send to Telegram chat","type":"main","index":0}]]},"ifSend1":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"Set Lark Base Config1":{"main":[[{"node":"Start Lark Base Actions","type":"main","index":0}]]},"Set Telegram Config1":{"main":[[{"node":"Start Telegram Mess Actions","type":"main","index":0}]]},"ifSend2":{"main":[[{"node":"Send to Telegram chat","type":"main","index":0}]]},"Set Telegram Config2":{"main":[[{"node":"Start Telegram Mess Actions","type":"main","index":0}]]},"Convert to Lark Base format OTP":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"ifOTPLarkBase":{"main":[[{"node":"Convert to Lark Base format OTP","type":"main","index":0}],[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"ifOTPTelegram":{"main":[[{"node":"Create Telegram Message for OTP","type":"main","index":0}],[{"node":"Create Telegram Message","type":"main","index":0}]]},"Get SMS data":{"main":[[{"node":"Start Actions","type":"main","index":0}]]},"Set Lark Mess Config1":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]},"Set Lark Mess Config2":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"SMS Forwarder App","transfer-encoding":"chunked","accept-encoding":"gzip","content-type":"application/json; charset=utf-8","x-forwarded-for":"14.179.3.141","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"14.179.3.141"},"params":{},"query":{},"body":{"from":"Vietcombank","text":"SD TK 0691000313660 +770,007,700VND luc 17-07-2023 16:55:16. SD 9,414,532VND. Ref IBVCB.1707230013982001.XN3 THEP HA NOI TRA THEP HOA PHAT HUNG YEN","sentStamp":1689410517000,"receivedStamp":1689410517697,"sim":"sim1"}}}]},"versionId":"9910dfdd-c1e9-4d3e-8a8d-15f3853d88b5","triggerCount":1,"tags":[{"createdAt":"2023-01-05T09:55:57.214Z","updatedAt":"2023-01-05T09:55:57.214Z","id":"1","name":"Lark"},{"createdAt":"2023-07-15T01:37:36.669Z","updatedAt":"2023-07-15T01:37:36.669Z","id":"27","name":"KDIGI"}]}
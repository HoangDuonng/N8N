{"createdAt":"2023-06-19T06:13:47.369Z","updatedAt":"2023-08-03T01:34:04.000Z","id":"134","name":"[Preorder áo] Khi nhận được thanh toán","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"/dcgr/preorder2023/nhan-chuyen-khoan","options":{}},"id":"ebc7e8a7-f7a4-40fc-a154-e3892768a8fd","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[700,340],"webhookId":"9a277f0a-b949-4995-9e42-1076d9f3b44d"},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isValidRecordId }}","value2":"={{ true }}"}]}},"id":"60aecf3a-2d18-4617-8a25-2510c6129b18","name":"check_found_order","type":"n8n-nodes-base.if","typeVersion":1,"position":[2440,320]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.moneyPayment }}","operation":"largerEqual","value2":"={{ $json.moneyTotal }}"}]}},"id":"1c02b750-6c88-4b34-91ab-ae67e6629537","name":"check-full-payment","type":"n8n-nodes-base.if","typeVersion":1,"position":[2700,-380]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/dcgr/preorder2023/email-thanh-toan-full","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"order_id\": \"{{ $('check_found_order').item.json[\"order_id\"] }}\",\n    \"moneyReceive\": {{ $('check_found_order').item.json[\"moneyReceive\"] }},\n    \"moneyPayment\": {{ $('check_found_order').item.json[\"moneyPayment\"] }},\n    \"moneyRest\": {{ $('check_found_order').item.json[\"moneyRest\"] }},\n    \"moneyTotal\": {{ $('check_found_order').item.json[\"moneyTotal\"] }},\n    \"price\": {{ $('check_found_order').item.json[\"price\"] }},\n    \"amount\": {{ $('check_found_order').item.json[\"amount\"] }},\n    \"total\": {{ $('check_found_order').item.json[\"total\"] }},\n    \"email\": \"{{ $('check_found_order').item.json[\"email\"] }}\",\n    \"name\": \"{{ $('check_found_order').item.json[\"name\"] }}\",\n    \"phone\": \"{{ $('check_found_order').item.json[\"phone\"] }}\",\n    \"address\": \"{{ $('check_found_order').item.json[\"address\"] }}\",\n    \"size\": \"{{ $('check_found_order').item.json[\"size\"] }}\",\n    \"style\": \"{{ $('check_found_order').item.json[\"style\"] }}\",\n    \"status\": \"{{ $('check_found_order').item.json[\"statusPayment\"] }}\"\n}","options":{}},"id":"5dfc8d66-3614-4c39-b12a-e3d6ee612de5","name":"send_email_thanh_toan_full","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2980,-540]},{"parameters":{"jsCode":"const data = $('Webhook').first().json.body\nconsole.log(data)\nlet order_id\nlet is_true_tx = false\nlet regex = /DCGR\\d{5}/\nlet match = data.description.match(regex)\n\n\n\nconst bankAccount = '98415021998'\nconst isBankAccount = data.bank_sub_acc_id == bankAccount ? true: false\n\nconsole.log(data.bank_sub_acc_id == bankAccount)\n\nif (match && isBankAccount) {\n  is_true_tx = true\n  order_id = match[0]\n}\n\nlet total_receive = data.amount\nreturn {\n  is_true_tx,\n  order_id,\n  total_receive\n}"},"id":"d371d9d2-682e-470c-8a20-670305112629","name":"get_order_id_from_tx","type":"n8n-nodes-base.code","typeVersion":1,"position":[920,340]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.is_true_tx }}","value2":"={{ true }}"}]}},"id":"04de5d40-6e88-4be5-9fb2-1feb14cdcf2f","name":"check_is_true_tx","type":"n8n-nodes-base.if","typeVersion":1,"position":[1140,340]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a4054c355978d009"},{"name":"app_secret","value":"gIBdgOBBQVCQeRpQw1y7Zencd2sOqigf"}]},"options":{}},"id":"9d16e868-e764-4cd7-9a7c-70edc2cff299","name":"get_access_token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1420,320]},{"parameters":{"url":"={{ $('config_url_get_list').first().json.url }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('get_access_token').item.json.tenant_access_token }}"}]},"options":{}},"id":"58f2cbf3-55e2-4498-ba73-7d2fb6b10ba4","name":"get_list_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1920,320]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $('get_list_record').item.json.data.has_more }}","value2":true}]}},"id":"4155531d-0429-41fe-8fa0-56250d6a1897","name":"if_has_more_list","type":"n8n-nodes-base.if","typeVersion":1,"position":[2640,580]},{"parameters":{"jsCode":"const dataFromBase = $('get_list_record').first().json.data\nconst tx = $('get_order_id_from_tx').first().json\n\n// lấy order object bằng order_id\nconst order = dataFromBase.items.find(forItem => forItem.fields.order_id === tx.order_id)\n\nlet isValidRecordId = !!order\n\n// nếu không có order thì return false\nif (!order) return {isValidRecordId}\n\n// lấy order_id từ order object\nlet order_id = order?.fields.order_id\n\n// lấy record_id bảng ghi từ order object\nlet record_id = order?.record_id\n\n// lấy email khách hàng\nlet email = order?.fields.email\n\n// lấy tổng giá trị đơn hàng\nlet moneyTotal = order?.fields.total\n\n// lấy số tiền khách hàng đã thanh toán\nlet rest = order?.fields.rest\n\n// lấy số tiền còn lại cần thanh toán\n// let rest = order?.fields.rest\n\n// lấy số tiền vừa nhận được\nlet moneyReceive = tx.total_receive\n\n// tính số tiền còn lại cần thanh toán lần này: (số tiền còn lại cần thanh toán) - (số tiền nhận được)\nlet moneyRest = rest - moneyReceive\n\n// tính số tiền đã thanh toán\nlet moneyPayment = moneyTotal - moneyRest\n\n// lấy price từ order object\nlet price = order?.fields.price[0]\n\n// lấy amount từ order object\nlet amount = order?.fields.amount\n\n// lấy total từ order object\nlet total = order?.fields.total\n\n// lấy name từ order object\nlet name = order?.fields.name\n\n// lấy phone từ order object\nlet phone = order?.fields.phone\n\n// lấy address từ order object\nlet address = order?.fields.address\n\n// lấy size từ order object\nlet size = order?.fields.size\n\n// lấy style từ order object\nlet style = order?.fields.style\n\n// tình trạng thanh toán\nlet statusPayment = ''\nif (moneyRest === 0) {\n  statusPayment = 'completed'\n} else if (moneyRest < 0) {\n  statusPayment = 'overpayment'\n} else {\n  statusPayment = 'on-hold'\n}\n\nreturn {\n  isValidRecordId,\n  record_id,\n  order_id,\n  moneyReceive,\n  moneyPayment,\n  moneyRest,\n  moneyTotal,\n  price,\n  amount,\n  total,\n  email,\n  name,\n  phone,\n  address,\n  size,\n  style,\n  statusPayment,\n  order_data: order?.fields\n}"},"id":"c5bf3005-9a55-44ca-acae-3101bc4fea64","name":"handle_record_id","type":"n8n-nodes-base.code","typeVersion":1,"position":[2180,320]},{"parameters":{"jsCode":"if (items[0].json?.pageToken){\n  return {\n    url: `https://open.larksuite.com/open-apis/bitable/v1/apps/JxmFbMji9a8sGHs8KrfuAkkfsgf/tables/tblNSWaikG3Anktj/records?page_size=10&page_token=${items[0].json?.pageToken}&sort=%5B%22created_at+DESC%22%5D`\n  }\n}\n\nreturn {\n  url: 'https://open.larksuite.com/open-apis/bitable/v1/apps/JxmFbMji9a8sGHs8KrfuAkkfsgf/tables/tblNSWaikG3Anktj/records?page_size=5&sort=%5B%22created_at+DESC%22%5D'\n}"},"id":"60dd73be-9f1b-4703-b2bc-57a0141e94be","name":"config_url_get_list","type":"n8n-nodes-base.code","typeVersion":1,"position":[1660,320]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/d6f7a37d-123f-4e99-bba6-04ab8110e166","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('prepare_json_bot').first().json)}}","options":{}},"id":"c245e58d-2b2c-4b6c-a408-626a7c3b61ab","name":"send_message_to_lark_group","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2920,100]},{"parameters":{"jsCode":"const data = $(\"check_found_order\").first().json;\nconst orders = [data.order_data];\nconsole.log(orders);\n\nlet elements = [];\n\n// Add products\norders.forEach((order) => {\n    elements.push({\n        tag: \"div\",\n        fields: [\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**Mẫu áo:** ${order.style}`,\n                },\n            },\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**Size áo:** ${order.size}`,\n                },\n            },\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**Số lượng:** ${order.amount}`,\n                },\n            },\n            {\n                is_short: true,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**Đơn giá:** ${\n                        order.price[0].toLocaleString(\"en-US\") + \" VND\"\n                    }`,\n                },\n            },\n            {\n                is_short: false,\n                text: {\n                    tag: \"lark_md\",\n                    content: `**Giá trị đơn hàng:** ${\n                        order.total.toLocaleString(\"en-US\") + \" VND\"\n                    }`,\n                },\n            },\n        ],\n    });\n    elements.push({\n        tag: \"hr\",\n    });\n});\n\n// Add Order Info\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã đơn hàng:** ${data.order_id}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Trạng thái thanh toán:** ${data.statusPayment}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Tổng tiền đã thanh toán:** ${\n                    data.moneyPayment.toLocaleString(\"en-US\") + \" VND\"\n                }`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Tổng tiền còn lại:** ${\n                    data.moneyRest.toLocaleString(\"en-US\") + \" VND\"\n                }`,\n            },\n        },\n    ],\n});\nelements.push({\n    tag: \"hr\",\n});\n\n// Add customer info\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Họ và tên:** ${data.order_data.name}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số điện thoại:** ${data.order_data.phone}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Email:** ${data.order_data.email}`,\n            },\n        },\n        {\n            is_short: false,\n            text: {\n                tag: \"lark_md\",\n                content: `**Địa chỉ:** ${data.order_data.address}`,\n            },\n        },\n    ],\n});\n\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"blue\",\n            title: {\n                content: `🛒  MỘT CẬP NHẬT TỪ PRE-ORDER ÁO DCGR - ${data.order_id}`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\n\nreturn { json: result };\n"},"id":"d7a6a63c-a195-43a0-8fd6-36e8661deae3","name":"prepare_json_bot","type":"n8n-nodes-base.code","typeVersion":1,"position":[2720,100]},{"parameters":{"values":{"string":[{"name":"pageToken","value":"={{ $('get_list_record').item.json.data.page_token }}"}]},"options":{}},"id":"dbd357d0-e3c4-4ca0-b90d-f50c62450ba8","name":"set_page_token","type":"n8n-nodes-base.set","typeVersion":2,"position":[2880,560]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/JxmFbMji9a8sGHs8KrfuAkkfsgf/tables/tblNSWaikG3Anktj/records/{{ $('check_found_order').item.json.record_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('get_access_token').item.json.tenant_access_token }}"}]},"sendBody":true,"contentType":"raw","rawContentType":"application/json","body":"={{JSON.stringify( $('prepare_base').item.json )}}","options":{}},"id":"648e644d-5283-4cd8-a99a-7b1d98deba76","name":"change_status_in_base","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2960,-100]},{"parameters":{"jsCode":"const data = $('check_found_order').first().json\nreturn {\n  fields: {\n    status_payment: data.statusPayment,\n    payment: data.moneyPayment\n  }\n}"},"id":"dc984775-5af6-4f57-ac01-f312e3c34aca","name":"prepare_base","type":"n8n-nodes-base.code","typeVersion":1,"position":[2720,-100]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/dcgr/preorder2023/email-thanh-toan-mot-phan","sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"order_id\": \"{{ $('check_found_order').item.json[\"order_id\"] }}\",\n    \"moneyReceive\": {{ $('check_found_order').item.json[\"moneyReceive\"] }},\n    \"moneyPayment\": {{ $('check_found_order').item.json[\"moneyPayment\"] }},\n    \"moneyRest\": {{ $('check_found_order').item.json[\"moneyRest\"] }},\n    \"moneyTotal\": {{ $('check_found_order').item.json[\"moneyTotal\"] }},\n    \"price\": {{ $('check_found_order').item.json[\"price\"] }},\n    \"amount\": {{ $('check_found_order').item.json[\"amount\"] }},\n    \"email\": \"{{ $('check_found_order').item.json[\"email\"] }}\",\n    \"name\": \"{{ $('check_found_order').item.json[\"name\"] }}\",\n    \"phone\": \"{{ $('check_found_order').item.json[\"phone\"] }}\",\n    \"address\": \"{{ $('check_found_order').item.json[\"address\"] }}\",\n    \"size\": \"{{ $('check_found_order').item.json[\"size\"] }}\",\n    \"style\": \"{{ $('check_found_order').item.json[\"style\"] }}\",\n    \"status\": \"{{ $('check_found_order').item.json[\"statusPayment\"] }}\"\n}","options":{}},"id":"a60bd823-0de7-4241-98d7-8edee37f8916","name":"send_email_thanh_toan_1_phan","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2980,-320]},{"parameters":{"values":{"string":[{"name":"botToken","value":"6141412510:AAEVEPZcCa7Hehbb9pfnX7M9cpd0f5rK1q4"},{"name":"chatId","value":"-1001958985351"}]},"options":{}},"id":"27d3bd4f-ac7f-4a10-ac85-e6a1d880ebca","name":"Set Telegram Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[2680,300]},{"parameters":{"method":"POST","url":"=https://api.telegram.org/bot{{ $input.item.json.botToken }}/sendMessage ","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.payload) }}","options":{}},"id":"fb7e98aa-a98c-4b0a-a070-c24cdce1d7b8","name":"Send to Telegram chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[3100,300]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const data = $('check_found_order').first().json;\nconst orders = [data.order_data];\n\nlet message = [];\n\norders.forEach((order) => {\n  message.push(\n    `<b>MỘT CẬP NHẬT TỪ PRE-ORDER ÁO DCGR - ${data.order_id}</b>\\n`,\n    `<b>Mẫu áo:</b> ${order.style}`,\n    `<b>Size áo:</b> ${order.size}`,\n    `<b>Số lượng:</b> ${order.amount}`,\n    `<b>Đơn giá:</b> ${order.price[0].toLocaleString('en-US') + ' VND'}`,\n    `<b>Giá trị đơn hàng:</b> ${order.total.toLocaleString('en-US') + ' VND'}\\n`\n  );\n});\n\nmessage.push(\n  `<b>Mã đơn hàng:</b> ${data.order_id}`,\n  `<b>Trạng thái thanh toán:</b> ${data.statusPayment}`,\n  `<b>Tổng tiền đã thanh toán:</b> ${\n    data.moneyPayment.toLocaleString('en-US') + ' VND'\n  }`,\n  `<b>Tổng tiền còn lại:</b> ${\n    data.moneyRest.toLocaleString('en-US') + ' VND'\n  }\\n`,\n\n  `<b>Họ và tên:</b> ${data.order_data.name}`,\n  `<b>Số điện thoại:</b> ${data.order_data.phone}`,\n  `<b>Email:</b> ${data.order_data.email}`,\n  `<b>Địa chỉ:</b> ${data.order_data.address}`\n);\n\nreturn {\n  json: {\n    botToken: $input.item.json.botToken,\n    payload: {\n      chat_id: $input.item.json.chatId,\n      parse_mode: 'HTML',\n      text: message.join('\\n'),\n    },\n  },\n};\n"},"id":"a34ad274-a57d-4ea6-b2b8-f6fa2cd5e529","name":"prepare_html_telegram","type":"n8n-nodes-base.code","typeVersion":1,"position":[2900,300]}],"connections":{"Webhook":{"main":[[{"node":"get_order_id_from_tx","type":"main","index":0}]]},"check_found_order":{"main":[[{"node":"Set Telegram Config","type":"main","index":0},{"node":"prepare_json_bot","type":"main","index":0},{"node":"prepare_base","type":"main","index":0},{"node":"check-full-payment","type":"main","index":0}],[{"node":"if_has_more_list","type":"main","index":0}]]},"check-full-payment":{"main":[[{"node":"send_email_thanh_toan_full","type":"main","index":0}],[{"node":"send_email_thanh_toan_1_phan","type":"main","index":0}]]},"get_order_id_from_tx":{"main":[[{"node":"check_is_true_tx","type":"main","index":0}]]},"check_is_true_tx":{"main":[[{"node":"get_access_token","type":"main","index":0}]]},"get_access_token":{"main":[[{"node":"config_url_get_list","type":"main","index":0}]]},"get_list_record":{"main":[[{"node":"handle_record_id","type":"main","index":0}]]},"if_has_more_list":{"main":[[{"node":"set_page_token","type":"main","index":0}]]},"handle_record_id":{"main":[[{"node":"check_found_order","type":"main","index":0}]]},"config_url_get_list":{"main":[[{"node":"get_list_record","type":"main","index":0}]]},"prepare_json_bot":{"main":[[{"node":"send_message_to_lark_group","type":"main","index":0}]]},"set_page_token":{"main":[[{"node":"config_url_get_list","type":"main","index":0}]]},"prepare_base":{"main":[[{"node":"change_status_in_base","type":"main","index":0}]]},"Set Telegram Config":{"main":[[{"node":"prepare_html_telegram","type":"main","index":0}]]},"prepare_html_telegram":{"main":[[{"node":"Send to Telegram chat","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"axios/0.21.4","content-length":"168","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","content-type":"application/json","x-forwarded-for":"172.23.0.1","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"172.23.0.1","accept-encoding":"gzip"},"params":{},"query":{},"body":{"bankName":"vietcombank","bank_sub_acc_id":"98415021998","amount":10000,"cusum_balance":23191071,"description":"073193.200723.233452.DCGR00055","when":"12:46:52, 20/7/2023"}}}]},"versionId":"8ec80b94-6624-48fd-a773-d8fe91ba7187","triggerCount":1,"tags":[{"createdAt":"2023-07-14T18:38:08.838Z","updatedAt":"2023-07-14T18:38:08.838Z","id":"26","name":"dcgr"}]}
{"createdAt":"2023-10-02T04:38:04.292Z","updatedAt":"2023-10-02T14:20:38.000Z","id":"557","name":"Workflow test bank","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"KHS-Banking-kdigi-bank-bot-api","options":{}},"id":"4232a707-e543-451a-aa2a-f46577734135","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[-1660,780],"webhookId":"b459d9da-c462-43e0-880c-12b8d6304763"},{"parameters":{"mode":"runOnceForEachItem","jsCode":"if (\n  ($('getBankData').item.json.result.transactionType.type === '-' &&\n    $input.item.json.enableOutgoing) ||\n  ($('getBankData').item.json.result.transactionType.type === '+' &&\n    $input.item.json.enableIncoming)\n) {\n  const data = $('getBankData').first().json.result;\n\n  let elements = [];\n\n  elements.push({\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Ngân hàng**: ${data.bankName.toUpperCase()}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số tài khoản**: ${data.receiverAccount}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư thay đổi:** ${data.transactionType.type} ${data.transactionAmount.amountText} VND`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Nội dung:** ${data.transactionMessage}`,\n        },\n      },\n    ],\n  });\n\n  // Append transaction ID if exist\n  if (data.transactionId) {\n    elements[0].fields.push({\n      is_short: false,\n      text: {\n        tag: 'lark_md',\n        content: `**Mã giao dịch:** ${data.transactionId}`,\n      },\n    });\n  }\n\n  // Append received time\n  elements[0].fields.push({\n    is_short: false,\n    text: {\n      tag: 'lark_md',\n      content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n    },\n  });\n\n  // Kiểm tra enableBalance nếu true thì thêm phần tử \"Số dư tạm tính\" vào mảng fields\n  if ($input.item.json.enableBalance) {\n    const balanceIndex = elements[0].fields.findIndex((field) =>\n      field?.text?.content?.includes('Số dư thay đổi')\n    );\n    if (balanceIndex !== -1) {\n      elements[0].fields.splice(balanceIndex + 1, 0, {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư tạm tính**: ${data.balance.amountText} VND`,\n        },\n      });\n    }\n  }\n\n  // create message card\n  let result = {\n    msg_type: 'interactive',\n    card: {\n      config: {\n        wide_screen_mode: true,\n      },\n      header: {\n        template: data.larkMessConfig?.cardColor ?? 'blue',\n        title: {\n          content: `${data.bankName.toUpperCase()}-${data.receiverAccount} (${\n            data.transactionType.type\n          }) ${data.transactionAmount.amountText}VND`,\n          tag: 'plain_text',\n        },\n      },\n      elements,\n    },\n  };\n\n  return {\n    json: {\n      isSend: true,\n      data: result,\n      customBotURL: $input.item.json.customBotURL,\n    },\n  };\n}\n\nreturn {\n  json: {\n    isSend: false,\n  },\n};\n"},"id":"5748ebea-048a-4c5f-afb1-74ad3ea48207","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,780]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $input.item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $input.item.json[\"appSecret\"] }}\" }","options":{}},"id":"d0ee5083-5c88-4e10-bfc8-e28415d0410a","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[-420,520]},{"parameters":{"method":"POST","url":"={{ $input.item.json.customBotURL }}","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.item.json.data)}}","options":{}},"id":"7e66019f-e6d7-4a54-b84d-6d1f20efd465","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1040,640]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isBankSupport }}","value2":true}]}},"id":"082897b2-fe71-4098-a90f-942bb9486eab","name":"ifBankSupport","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1240,780]},{"parameters":{"method":"POST","url":"https://vn1.n8n.vn/webhook/kdigi-bank-bot-process-data","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"3bff9d7b-5077-48c0-853f-d64a80311694","name":"getBankData","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1460,780]},{"parameters":{},"id":"6ceb3102-83ac-4999-866e-28f17a883d2b","name":"Start Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-1040,760]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a590ff0733789010"},{"name":"appSecret","value":"IOBVXyEaMXjurn1XFvqXVhlazKWsCgvB"}]},"options":{}},"id":"297bf336-2302-44f1-ba64-56f8cebf8eeb","name":"Set Lark Configs","type":"n8n-nodes-base.set","typeVersion":2,"position":[-600,540]},{"parameters":{"keepOnlySet":true,"values":{"string":[{"name":"customBotURL","value":"https://open.larksuite.com/open-apis/bot/v2/hook/376e940f-1f97-4156-a33a-077a94561ffc"}],"boolean":[{"name":"enableBalance"},{"name":"enableOTP"},{"name":"enableOutgoing","value":true},{"name":"enableIncoming","value":true}]},"options":{}},"id":"37bb743a-4f50-4939-bbda-198aedb32069","name":"Set Lark Mess Config","type":"n8n-nodes-base.set","typeVersion":2,"position":[20,660]},{"parameters":{},"id":"48456da4-fa9c-49cb-9973-2a1618306bff","name":"Start Lark Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-760,520]},{"parameters":{},"id":"4f902454-911c-4cab-970d-b0200068c83b","name":"Start Lark Mess","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[-200,740]},{"parameters":{},"id":"53005d40-2140-4b17-b456-37b5abe226d4","name":"Start Lark Mess Actions","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[240,720]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"const smsContent = $('Webhook').first().json.body;\n\n// create message card\nlet result = {\n  msg_type: 'text',\n  content: {\n    text: `Từ: ${smsContent.from}\\n${smsContent.text.toString()}`,\n  },\n};\n\nreturn {\n  json: {\n    data: result,\n    customBotURL: $input.item.json.customBotURL,\n  },\n};\n"},"id":"f5c19ccf-4744-4b43-a89c-348f5f3e25e0","name":"Convert to Message Card for OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,620]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $input.item.json.isSend }}","value2":true}]}},"id":"59054ad2-a779-41c6-ab18-274b163a5617","name":"ifSend","type":"n8n-nodes-base.if","typeVersion":1,"position":[860,780]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Webhook').item.json.body.text }}","operation":"contains","value2":"OTP"}],"boolean":[{"value1":"={{ $input.item.json.enableOTP }}","value2":true}]}},"id":"f7d188fd-2717-4ffc-ba74-348b52b90923","name":"ifOTPLarkMess","type":"n8n-nodes-base.if","typeVersion":1,"position":[400,720]}],"connections":{"Webhook":{"main":[[{"node":"getBankData","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"ifSend","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Start Lark Mess","type":"main","index":0}]]},"ifBankSupport":{"main":[[{"node":"Start Actions","type":"main","index":0}]]},"getBankData":{"main":[[{"node":"ifBankSupport","type":"main","index":0}]]},"Set Lark Configs":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Set Lark Mess Config":{"main":[[{"node":"Start Lark Mess Actions","type":"main","index":0}]]},"Start Lark Actions":{"main":[[{"node":"Set Lark Configs","type":"main","index":0}]]},"Start Lark Mess":{"main":[[{"node":"Set Lark Mess Config","type":"main","index":0}]]},"Start Lark Mess Actions":{"main":[[{"node":"ifOTPLarkMess","type":"main","index":0}]]},"Convert to Message Card for OTP":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifSend":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"ifOTPLarkMess":{"main":[[{"node":"Convert to Message Card for OTP","type":"main","index":0}],[{"node":"Convert to Lark Message Card","type":"main","index":0}]]},"Start Actions":{"main":[[{"node":"Start Lark Actions","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"cde7025b-5549-494c-b3aa-025dc4a75e7f","triggerCount":1,"tags":[]}
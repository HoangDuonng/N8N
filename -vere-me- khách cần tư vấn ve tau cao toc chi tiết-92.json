{"createdAt":"2023-05-10T16:56:40.835Z","updatedAt":"2023-05-14T04:58:09.000Z","id":"92","name":"[Vere.me] Khách cần tư vấn ve tau cao toc chi tiết","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"vere-dat-ve-full","options":{}},"id":"dad457b1-f8e0-4a29-a741-8b49f55596e9","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[820,500],"webhookId":"14831f6a-82d3-4f5a-9f66-40764af62be8"},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/12319b57-14ab-4066-ae74-2837f7c98e50","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Code1').first().json)}}","options":{}},"id":"c97fc63f-04bd-48f3-98cf-f3d6d07a8dd8","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1480,500]},{"parameters":{"jsCode":"const data = $('Webhook').first().json.body;\n\nlet ten_ve = data.ten_ve || '-';\nten_ve = ten_ve.replace(/\\n/g, \", \");\n\nlet fullname = data.fullname || '-';\nfullname = fullname.replace(/\\n/g, \", \");\n\nlet phone = data.phone || '-';\nphone = phone.replace(/\\n/g, \", \");\n\nlet sdtZalo = '84' + phone.slice(1);\n\nlet nhieu_thong_tin = false;\nif (data.nhieu_thong_tin !== '') nhieu_thong_tin = true;\n\nlet so_chieu = 2;\nif (data.so_chieu == 'Một chiều') so_chieu = 1;\n\nlet ngay_khoi_hanh = (data.ngay_khoi_hanh === '') ? '-' : new Date(data.ngay_khoi_hanh).toLocaleDateString('en-GB');\n\nlet ngay_tro_ve = (data.ngay_tro_ve === '') ? '-' : new Date(data.ngay_tro_ve).toLocaleDateString('en-GB');\n\nlet so_luong_khach = data.so_luong_khach || 0;\n\nlet hang = data.hang || '-';\nhang = hang.replace(/\\n/g, \", \");\n\nlet noi_khoi_hanh = data.noi_khoi_hanh || '-';\nnoi_khoi_hanh = noi_khoi_hanh.replace(/\\n/g, \", \");\n\nlet diem_den = data.diem_den || '-';\ndiem_den = diem_den.replace(/\\n/g, \", \");\n\nlet chatcode = Math.floor(Math.random() * 101);\n\nconst source_title = data.source_title;\nconst source_url = data.source_url;\n\nif (nhieu_thong_tin === false) {\n  ngay_khoi_hanh = '-';\n  ngay_tro_ve = '-';\n  hang = '-';\n  so_chieu = '-';\n  so_luong_khach = '-';\n  noi_khoi_hanh = '-';\n  diem_den = '-';\n}\n\nif (so_chieu === 1) {\n  ngay_tro_ve = '-';\n}\nreturn {\n  chatcode,\n  fullname,\n  phone,\n  sdtZalo,\n  nhieu_thong_tin,\n  ten_ve,\n  so_chieu,\n  ngay_khoi_hanh,\n  ngay_tro_ve,\n  so_luong_khach,\n  hang,\n  noi_khoi_hanh,\n  diem_den,\n  source_title,\n  source_url\n}\n\n\n\n"},"id":"dae0b198-dd59-486e-b2c3-f325de7e057a","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[1040,500]},{"parameters":{"jsCode":"const data = $(\"Code\").first().json;\n\nlet elements = [];\n\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Họ và tên:** ${data.fullname}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số điện thoại:** ${data.phone}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã đặt vé:** ${data.chatcode}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Hãng:** ${data.hang}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nơi khởi hành:** ${data.noi_khoi_hanh}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nơi đến:** ${data.diem_den}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngày khởi hành:** ${data.ngay_khoi_hanh}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngày trở về:** ${data.ngay_tro_ve}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số chiều:** ${data.so_chieu}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số khách:** ${data.so_luong_khach}`,\n            },\n        },\n    ],\n});\n\n// Add action buttons\nelements.push({\n    tag: \"action\",\n    actions: [\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Chat Zalo cá nhân\",\n            },\n            url: `https://zalo.me/${data.phone}`,\n            type: \"primary\",\n        },\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Gọi điện cá nhân\",\n            },\n            url: `tel:${data.phone}`,\n            type: \"default\",\n        },\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Xem trên web\",\n            },\n            url: `${data.source_url}`,\n            type: \"default\",\n        }\n    ],\n});\n\n\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"green\",\n            title: {\n                content: `Yêu cầu tư vấn ${data.source_title}`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\nreturn { json: result };"},"id":"37879033-15fb-472e-8ca8-d13e297279b8","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[1260,500]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.msg }}","value2":"success"}]}},"id":"af1976ab-35cd-4686-a62e-9696c3c462ad","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[1700,500]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $node.Code.json.nhieu_thong_tin }}","value2":"={{ true }}"}]}},"id":"867bbb73-38ff-4697-ac94-68af3163b736","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1880,360]},{"parameters":{"application":{"__rl":true,"value":"appg7xGBQYqUYbJAr","mode":"id"},"table":{"__rl":true,"value":"tblWAtHbJemABDvCG","mode":"id"},"id":"recqr9eRsaI69jq2D"},"id":"b4922fdf-32cc-43e2-927b-70168c0f4197","name":"Airtable","type":"n8n-nodes-base.airtable","typeVersion":1,"position":[2100,360],"credentials":{"airtableApi":{"id":"20","name":"Airtable: lekhoi456@gmail.com"}}},{"parameters":{"method":"POST","url":"https://business.openapi.zalo.me/message/template","sendHeaders":true,"headerParameters":{"parameters":[{"name":"access_token","value":"={{ $node.Airtable.json.fields.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"phone\": \"{{$node[\"Code\"].json[\"sdtZalo\"]}}\",\n    \"template_id\": \"259151\",\n    \"template_data\": {\n        \"loai_ve\": \"{{$node[\"Webhook\"].json[\"body\"][\"so_chieu\"]}}\",\n        \"ngay_tro_ve\": \"{{$node[\"Code\"].json[\"ngay_tro_ve\"]}}\",\n        \"diem_den\": \"{{$node[\"Code\"].json[\"diem_den\"]}}\",\n        \"hang\": \"{{$node[\"Code\"].json[\"hang\"]}}\",\n        \"ngay_khoi_hanh\": \"{{$node[\"Code\"].json[\"ngay_khoi_hanh\"]}}\",\n        \"ma_dat_ve\": \"{{$node[\"Code\"].json[\"chatcode\"]}}\",\n        \"ten_ve\": \"{{$node[\"Code\"].json[\"ten_ve\"]}}\",\n        \"noi_khoi_hanh\": \"{{$node[\"Code\"].json[\"noi_khoi_hanh\"]}}\",\n        \"trang_thai\": \"Đang kiểm tra vé\",\n        \"so_luong_khach\": {{$node[\"Code\"].json[\"so_luong_khach\"]}},\n        \"ho_va_ten\": \"{{$node[\"Code\"].json[\"fullname\"]}}\"\n    },\n    \"tracking_id\": \"ncmk_phong_ve_khach_de_lai_thong_tin\"\n}","options":{}},"id":"10d7936e-80d3-4046-9e2b-a9dc478fe32a","name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,160]},{"parameters":{"conditions":{"number":[{"value1":"={{ $node.Code.json.so_chieu }}","operation":"equal","value2":2}]}},"id":"d422e729-bac2-4b01-bec9-5821bef59cea","name":"IF2","type":"n8n-nodes-base.if","typeVersion":1,"position":[2320,360]},{"parameters":{"method":"POST","url":"https://business.openapi.zalo.me/message/template","sendHeaders":true,"headerParameters":{"parameters":[{"name":"access_token","value":"={{ $node.Airtable.json.fields.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"phone\": \"{{$node[\"Code\"].json[\"sdtZalo\"]}}\",\n    \"template_id\": \"259152\",\n    \"template_data\": {\n        \"loai_ve\": \"{{$node[\"Webhook\"].json[\"body\"][\"so_chieu\"]}}\",\n        \"diem_den\": \"{{$node[\"Code\"].json[\"diem_den\"]}}\",\n        \"hang\": \"{{$node[\"Code\"].json[\"hang\"]}}\",\n        \"ngay_khoi_hanh\": \"{{$node[\"Code\"].json[\"ngay_khoi_hanh\"]}}\",\n        \"ma_dat_ve\": \"{{$node[\"Code\"].json[\"chatcode\"]}}\",\n        \"ten_ve\": \"{{$node[\"Code\"].json[\"ten_ve\"]}}\",\n        \"noi_khoi_hanh\": \"{{$node[\"Code\"].json[\"noi_khoi_hanh\"]}}\",\n        \"trang_thai\": \"Đang kiểm tra vé\",\n        \"so_luong_khach\": {{$node[\"Code\"].json[\"so_luong_khach\"]}},\n        \"ho_va_ten\": \"{{$node[\"Code\"].json[\"fullname\"]}}\"\n    },\n    \"tracking_id\": \"ncmk_phong_ve_khach_de_lai_thong_tin\"\n}","options":{}},"id":"0492dd88-647b-4012-8543-424067713a8c","name":"HTTP Request2","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,380]}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"IF1","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Airtable","type":"main","index":0}]]},"Airtable":{"main":[[{"node":"IF2","type":"main","index":0}]]},"IF2":{"main":[[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"HTTP Request2","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"WordPress/6.2; https://vere.me","content-length":"623","accept":"*/*","accept-encoding":"deflate, gzip, br","content-type":"application/json; charset=UTF-8","x-forwarded-for":"103.175.248.236","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"422302823b8a","x-real-ip":"103.175.248.236"},"params":{},"query":{},"body":{"fullname":"Trần Thanh Thái","phone":"0979234234","nhieu_thong_tin":["Tôi sẽ cung cấp nhiều thông tin hơn"],"so_chieu":"Khứ hồi","ngay_khoi_hanh":"2023-05-13","ngay_tro_ve":"2023-05-14","so_luong_khach":"4","ten_ve":"Superdong: Phan Thiết - Phú Quý","hang":"Superdong","noi_khoi_hanh":"Phan Thiết","diem_den":"Phú Quý","source_title":"Vé tàu cao tốc Phan Thiết đi Phú Quý giá rẻ - Tàu cao tốc Superdong","source_url":"https://vere.me:443/ve-tau-cao-toc/phan-thiet-phu-quy-superdong"}}}]},"versionId":"0a6979b6-93cf-4c17-85b2-f32a3d62f192","triggerCount":1,"tags":[]}
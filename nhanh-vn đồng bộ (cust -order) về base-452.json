{"createdAt":"2023-08-04T09:06:39.525Z","updatedAt":"2023-08-30T02:03:02.000Z","id":"452","name":"NHANH.VN Đồng bộ (Cust -Order) về Base","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"mieuvn-nhanh-sync-base-06-08-2023mieumieumieu","options":{}},"id":"27b6e25f-37f4-4e67-8f50-8f1a30b91953","name":"webhook-nhanh","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[540,960],"webhookId":"d44e3fdf-5027-4515-8ab7-6efe1029de87"},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a4cc02cf28b8900a"},{"name":"appSecret","value":"pePaQtC2jGkf0hnIXVdebfaWSQTeEYnR"},{"name":"baseId","value":"BhkfbXGVMaxInqscv4YuzZxGsbU"},{"name":"tableId","value":"tblGuAVUp5qPNwXQ"}]},"options":{}},"id":"e8945b60-509c-400d-9be8-9595c2102fe4","name":"Set-Order","type":"n8n-nodes-base.set","typeVersion":2,"position":[1240,800]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('webhook-nhanh').item.json.body.event }}","value2":"orderAdd"},{"value1":"={{ $('webhook-nhanh').item.json.body.event }}","value2":"orderUpdate"}]},"combineOperation":"any"},"id":"faf6ffac-c46a-4f6b-a6e9-eed1719fc478","name":"check-order-or-product","type":"n8n-nodes-base.if","typeVersion":1,"position":[1000,960]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/app_access_token/internal","sendBody":true,"specifyBody":"json","jsonBody":"={\n\"app_id\": \"{{ $('Luồng Sản Phẩm').item.json[\"appId\"] }}\",\n\"app_secret\": \"{{ $('Luồng Sản Phẩm').item.json[\"appSecret\"] }}\"\n}","options":{}},"id":"f8f5e97c-b053-440d-a38b-f110a5f55900","name":"app_access_token_product","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1420,1160]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/app_access_token/internal","sendBody":true,"specifyBody":"json","jsonBody":"={\n\"app_id\": \"{{ $('Set-Order').item.json[\"appId\"] }}\",\n\"app_secret\": \"{{ $('Set-Order').item.json[\"appSecret\"] }}\"\n}","options":{}},"id":"e0184b9b-146f-4f73-ad1b-da72f2229ffc","name":"app_access_token_order","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1420,800]},{"parameters":{},"id":"75266b75-6571-48ea-b985-0fe0f7391552","name":"push base order","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,800]},{"parameters":{},"id":"521215b9-60a7-4b03-90f9-5f29b526acb0","name":"push base product","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1600,1160]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('webhook-nhanh').item.json.body.event }}","value2":"orderAdd"}]}},"id":"3b877651-6a6a-4f22-b328-22e57af793a1","name":"IF-order-base1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1760,800]},{"parameters":{"conditions":{"string":[{"value1":"={{ $('webhook-nhanh').item.json.body.event }}","value2":"productAdd"}]}},"id":"2a7228b3-0a03-4591-8f79-97e79a7df1ff","name":"IF-product-base1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1760,1160]},{"parameters":{"url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('Luồng Sản Phẩm').item.json[\"baseId\"] }}/tables/{{ $('Luồng Sản Phẩm').item.json[\"tableId\"] }}/records?filter=CurrentValue.[Product ID] = \"{{ $('webhook-nhanh').item.json[\"body\"][\"data\"][\"code\"] }}\"","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('app_access_token_product').item.json[\"app_access_token\"] }}"}]},"options":{}},"id":"48a1ca29-fc45-445b-924e-9958a2eb3126","name":"get-records-product1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2000,1340]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('Set-Order').item.json[\"baseId\"] }}/tables/{{ $('Set-Order').item.json[\"tableId\"] }}/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('app_access_token_order').item.json[\"app_access_token\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"fields\":\n{\n\"Số tiền\":{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"moneyTransfer\"] }},\n\"Địa chỉ\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerAddress\"] }}\",\n\"Phường\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerWard\"] }}\",\n\"Quận\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerDistrict\"] }}\",\n\"Thành phố\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerCity\"] }}\",\n\"Email\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerEmail\"] }}\",\n\"Tên Khách hàng\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerName\"] }}\",\n\"Số điện thoại\":\"{{$node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"customerMobile\"]}}\",\n\"ID Đơn hàng\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"orderId\"] }}\",\n\"Trạng thái\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"statusDescription\"] }}\",\n  \"Mã sản phẩm\": \"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][0][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][1][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][2][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][3][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][4][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][5][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][6][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][7][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][8][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][9][\"id\"] }}-{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"products\"][10][\"id\"] }}\",\n\n\"Kênh bán\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"saleChannel\"] }}\"\n}\n}","options":{}},"id":"c304a61a-9661-496d-9349-1ae4939dee7c","name":"Add Base Record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2240,640]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/BhkfbXGVMaxInqscv4YuzZxGsbU/tables/tblGuAVUp5qPNwXQ/records","sendQuery":true,"queryParameters":{"parameters":[{"name":"filter","value":"=CurrentValue.[ID đơn hàng]= {{ $('Code1').item.json.records[0].fields.orderId }}"},{"name":"page_size","value":"20"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.tenant_access_token }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"3bc569d1-4b6e-4152-8b2a-61e1f28bc674","name":"Lookup Record tồn tại","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2240,900]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/BhkfbXGVMaxInqscv4YuzZxGsbU/tables/tblGuAVUp5qPNwXQ/records/{{ $json.body.data.page_token }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Wi-Token').item.json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"fields\":{\"Trạng thái\":\"{{ $('Code1').item.json.records[0].fields.status }}\"}}","options":{"response":{"response":{"fullResponse":true}}}},"id":"a0ef74cd-613a-4954-ae57-13651d96596c","name":"Update Record cũ","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2460,900]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a4cc02cf28b8900a"},{"name":"appSecret","value":"pePaQtC2jGkf0hnIXVdebfaWSQTeEYnR"},{"name":"baseId","value":"BhkfbXGVMaxInqscv4YuzZxGsbU"},{"name":"tableId","value":"tblAL3yZ1perEApu"}]},"options":{}},"id":"0212cfa8-3e07-40cf-a6f2-a556893e2e9b","name":"Luồng Sản Phẩm","type":"n8n-nodes-base.set","typeVersion":2,"position":[1240,1160]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('Luồng Sản Phẩm').item.json[\"baseId\"] }}/tables/{{ $('Luồng Sản Phẩm').item.json[\"tableId\"] }}/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('app_access_token_product').item.json[\"app_access_token\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"fields\":\n{\n\"Product ID\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"code\"] }}\",\n\"Mã SKU Cha\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"brandId\"] }}\",\n\"Tên Sản phẩm\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"name\"] }}\",\n\"Gía vốn\":{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"importPrice\"] }},\n\"Link hình\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"image\"] }}\",\n\"Trạng thái SP\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"status\"] }}\",\n\"Tồn Kho\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"inventory\"] }}\",\n\"Gía bán\":{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"price\"] }}\n\n}\n}","options":{}},"id":"6ea01f7a-ce79-4905-a340-5b2533bce973","name":"Add Lark - Product","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2000,1140]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('Luồng Sản Phẩm').item.json[\"baseId\"] }}/tables/{{ $('Luồng Sản Phẩm').item.json[\"tableId\"] }}/records/{{ $node[\"get-records-product1\"].json[\"data\"][\"items\"][0][\"record_id\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('app_access_token_product').item.json[\"app_access_token\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n  \"fields\":\n{\n\"Tồn Kho\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"inventory\"] }}\",\n\"Trạng thái SP\":\"{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"status\"] }}\",\n\"Gía bán\":{{ $node[\"webhook-nhanh\"].json[\"body\"][\"data\"][\"price\"] }}\n}\n}","options":{}},"id":"2827f1eb-0d53-41ba-a45f-c6f009d5e5b7","name":"Update Product cũ","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2260,1340]},{"parameters":{"method":"POST","url":"https://nhanh.vn/oauth/access_token","sendQuery":true,"queryParameters":{"parameters":[{"name":"version","value":"2.0"},{"name":"appId","value":" 73690"},{"name":"accessCode","value":"solcZod7oSNLxhXLZa9fn7q1T5GF5J0Ex92pCOdiQCKabi8hU7Vs7L0L4fBBuAXM"},{"name":"secretKey","value":"D9XuOtpLCESSwmXce7BE6swNEanZojoG6BuZrepvYwjsdXEkJCU8q5Z3zWsQJSHRpuILm74qOASIVjEM6Uyo44JYGtoYpfGGtNEVtg8D2bICxBj5z5O8hS0eooeW9ajo"}]},"options":{}},"id":"dcb2f41e-9f9d-48c1-88e5-2c0985bb526a","name":"Kích hoạt APP","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[780,840]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  const data = input.body.json;\n  const records = [];\n  const field = {\n    \n  }\n}\n\nreturn data;"},"id":"f657a44f-7a2f-4d50-81b3-aa257e54abd3","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[2000,680]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst records = [];\nconst data = $('webhook-nhanh').first(); \nconst datanew = data.json.body;\n\nconst fields = {\n  orderId : datanew.data.orderId,\n  status :datanew.data.statusDescription,\n};\n\nrecords.push({ fields });\n\nlet result = { json: { records } };\nreturn result;\n"},"id":"29840a3d-8e15-4118-9a58-7743a3609285","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[1980,900]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/app_access_token/internal","sendBody":true,"specifyBody":"json","jsonBody":"{ \"app_id\": \"cli_a4d6c704d9b85009\", \"app_secret\": \"mY1fnsO5t2PvCRhKV6TxLfYuO5Iw57zh\" }","options":{}},"id":"4e810b61-dea6-4bc3-b110-a124394e693d","name":"Wi-Token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2100,900]}],"connections":{"webhook-nhanh":{"main":[[{"node":"check-order-or-product","type":"main","index":0}]]},"Set-Order":{"main":[[{"node":"app_access_token_order","type":"main","index":0}]]},"check-order-or-product":{"main":[[{"node":"Set-Order","type":"main","index":0}],[{"node":"Luồng Sản Phẩm","type":"main","index":0}]]},"app_access_token_order":{"main":[[{"node":"push base order","type":"main","index":0}]]},"app_access_token_product":{"main":[[{"node":"push base product","type":"main","index":0}]]},"push base order":{"main":[[{"node":"IF-order-base1","type":"main","index":0}]]},"push base product":{"main":[[{"node":"IF-product-base1","type":"main","index":0}]]},"IF-order-base1":{"main":[[{"node":"Code","type":"main","index":0}],[{"node":"Code1","type":"main","index":0}]]},"IF-product-base1":{"main":[[{"node":"Add Lark - Product","type":"main","index":0}],[{"node":"get-records-product1","type":"main","index":0}]]},"get-records-product1":{"main":[[{"node":"Update Product cũ","type":"main","index":0}]]},"Lookup Record tồn tại":{"main":[[{"node":"Update Record cũ","type":"main","index":0}]]},"Luồng Sản Phẩm":{"main":[[{"node":"app_access_token_product","type":"main","index":0}]]},"Code":{"main":[[{"node":"Add Base Record","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Wi-Token","type":"main","index":0}]]},"Wi-Token":{"main":[[{"node":"Lookup Record tồn tại","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"webhook-nhanh":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"Nhanh.vn Open API v2.0","content-length":"263","accept":"*/*","content-type":"application/json","x-forwarded-for":"34.80.32.50","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"34.80.32.50","accept-encoding":"gzip"},"params":{},"query":{},"body":{"event":"orderUpdate","businessId":35195,"data":{"orderId":283286737,"shopOrderId":"230825HC0SHH7F","status":"Confirmed","statusDescription":"Đã xác nhận","depotId":31858},"webhooksVerifyToken":"mieuvn-nhanh-sync-base-06-08-2023mieumieumieu"}}}]},"versionId":"51f5d99e-d65f-4792-980e-93a8ee3f8b8a","triggerCount":1,"tags":[]}
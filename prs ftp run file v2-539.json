{"createdAt":"2023-09-23T07:01:19.311Z","updatedAt":"2023-09-23T10:29:45.000Z","id":"539","name":"PRS FTP Run File v2","active":false,"nodes":[{"parameters":{"protocol":"sftp","operation":"list","path":"={{ $json.path }}"},"id":"67233dbd-8f84-49dd-80ff-b8b6f22a3a3d","name":"Quét file trong folder","type":"n8n-nodes-base.ftp","typeVersion":1,"position":[1600,920],"retryOnFail":true,"maxTries":5,"waitBetweenTries":5000,"credentials":{"sftp":{"id":"128","name":"SFTP PRS"}}},{"parameters":{"conditions":{"dateTime":[{"value1":"={{ $json.modifyTime }}","value2":"={{ $('setData').item.json.cutOffTime }}"}]}},"id":"adbf83f4-3f8d-4837-a476-422ac4df57af","name":"Lọc file hôm nay","type":"n8n-nodes-base.filter","typeVersion":1,"position":[1840,920]},{"parameters":{"protocol":"sftp","path":"={{ $json.body.data.path }}/{{ $json.body.data.filename }}"},"id":"7881427f-b479-4afe-b883-43a33454e23d","name":"Down file","type":"n8n-nodes-base.ftp","typeVersion":1,"position":[2760,640],"alwaysOutputData":true,"retryOnFail":true,"waitBetweenTries":3000,"credentials":{"sftp":{"id":"128","name":"SFTP PRS"}}},{"parameters":{"options":{"normalize":true}},"id":"b4de5f8f-8b21-414b-bda5-24019c0be05d","name":"Chuyển sang json","type":"n8n-nodes-base.xml","typeVersion":1,"position":[3200,640],"alwaysOutputData":false,"executeOnce":false},{"parameters":{"setAllData":false,"options":{"encoding":"utf8"}},"id":"09b88179-a215-4366-bd0c-ecedf91b205a","name":"Chuyển dữ liệu ra xml","type":"n8n-nodes-base.moveBinaryData","typeVersion":1,"position":[2980,640]},{"parameters":{"keepOnlySet":true,"values":{"string":[{"name":"data","value":"={{ Object.values($json.Data)[0] }}"}]},"options":{}},"id":"36e4f63b-71c2-4ac3-8741-c25b0deca26d","name":"Làm sạch data","type":"n8n-nodes-base.set","typeVersion":2,"position":[3880,620]},{"parameters":{"fieldToSplitOut":"data","options":{}},"id":"47a10588-f8bc-48cb-8cab-8b2781228fd6","name":"Chuyển data sang List","type":"n8n-nodes-base.itemLists","typeVersion":2.1,"position":[4340,620],"executeOnce":false},{"parameters":{"jsCode":"return $input.first();"},"id":"d7f0f16d-131c-4931-b3cd-a9a495033b7b","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[3420,640]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.Data }}","operation":"isNotEmpty"}]}},"id":"671b88b0-7ab1-46f7-ba6a-624364e7377a","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[3640,640]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.apiUrl }}/workflow/save-content","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('setData').item.json.apiToken }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $json }}","options":{}},"id":"8317ff8f-5aed-43ec-8582-2f469a479937","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[5040,360],"retryOnFail":true,"waitBetweenTries":5000,"maxTries":5},{"parameters":{"url":"={{ $('setData').item.json.apiUrl }}/workflow/save-file-v2","sendQuery":true,"queryParameters":{"parameters":[{"name":"full_path","value":"={{ $json.path }}"},{"name":"filename","value":"={{ $json.name }}"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('setData').item.json.apiToken }}"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"513500d3-edc7-48eb-a1fa-1ce53a7c4609","name":"Check File","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2320,900]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.code }}","value2":"success"}]}},"id":"a7652a1c-d58b-4ca7-9e4d-23c5d62af05f","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[2540,900]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.datafile = $('Check File').item.json.body.data;\n  \n}\nreturn $input.all();"},"id":"09006ee9-613e-48e4-a439-668bf0d949a7","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[4760,360]},{"parameters":{"fieldToSplitOut":"body.link_summary","options":{"destinationFieldName":"link"}},"id":"3f804a15-620e-4be7-8a24-9abf735c4da6","name":"Item Lists","type":"n8n-nodes-base.itemLists","typeVersion":2.1,"position":[5340,660]},{"parameters":{"batchSize":1,"options":{"reset":"={{ $node[\"Split In Batches\"].context[\"noItemsLeft\"] }}"}},"id":"4dce37f2-56f7-4feb-89bc-df41f5245c6b","name":"Split In Batches","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[5300,1380]},{"parameters":{"method":"POST","url":"={{ $('setData').item.json.apiUrl }}/workflow/save-filename","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('setData').item.json.apiToken }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={{ $('Check File').item.json[\"body\"][\"data\"] }}","options":{"response":{"response":{"fullResponse":true}}}},"id":"164a820d-ca52-4712-973d-b3c492e5e777","name":"Đánh dấu file đã xong","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[4880,680],"retryOnFail":true,"waitBetweenTries":5000},{"parameters":{"url":"={{ $json.link }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"token","value":"={{ $('setData').item.json.apiToken }}"}]},"options":{}},"id":"5316dd9c-1d66-437f-950b-87121aca711d","name":"Tổng hợp BC","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[5560,1360],"retryOnFail":true,"waitBetweenTries":3000,"continueOnFail":true},{"parameters":{"conditions":{"string":[{"value1":"body.link_summary","operation":"isNotEmpty"}]}},"id":"fea75b6b-a9e6-4749-bd65-fde1d8d8b34c","name":"IF2","type":"n8n-nodes-base.if","typeVersion":1,"position":[5100,680]},{"parameters":{"conditions":{"boolean":[{"value1":true,"value2":"={{ $('Split In Batches').context[\"noItemsLeft\"] }}"}]}},"id":"6278df9c-051c-4498-ac48-5e74af7c8559","name":"IF4","type":"n8n-nodes-base.if","typeVersion":1,"position":[5740,1080]},{"parameters":{"batchSize":"1","options":{"reset":"={{$node[\"SplitOnceItem\"].context[\"noItemsLeft\"]}}"}},"id":"e8b38cff-b947-4d0d-8d1b-1bf9cd45f2e2","name":"SplitOnceItem","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[4500,380],"alwaysOutputData":false},{"parameters":{"batchSize":1,"options":{"reset":"={{ $node[\"SplitFileInFolder\"].context[\"noItemsLeft\"] }}"}},"id":"a4caedc9-a47a-4b8c-b8ae-0e5ef8f3bb2e","name":"SplitFileInFolder","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[2080,920]},{"parameters":{"conditions":{"boolean":[{"value1":true,"value2":"={{$node[\"SplitOnceItem\"].context[\"noItemsLeft\"]}}"}]}},"id":"ead487cd-fa36-4f6b-90ff-cc47aab7e595","name":"IF5","type":"n8n-nodes-base.if","typeVersion":1,"position":[5260,360]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.data.SoChungTu }}","operation":"isNotEmpty"},{"value1":"={{ $json.data.MaDonVi }}","operation":"isNotEmpty"}]},"combineOperation":"any"},"id":"01eea288-12e4-4432-89b2-2aa2135fcd91","name":"ifOnceItem","type":"n8n-nodes-base.if","typeVersion":1,"position":[4100,620]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n//  $('Check File').item.json.body.data;\n$json.data.datafile = $('Check File').item.json.body.data;\nreturn $json.data;"},"id":"fa221a1a-5298-4507-911e-89fef3812811","name":"Code2","type":"n8n-nodes-base.code","typeVersion":1,"position":[4500,140]},{"parameters":{},"id":"e650f226-5435-48b6-a34b-04253ae3eda7","name":"Execute Workflow Trigger","type":"n8n-nodes-base.executeWorkflowTrigger","typeVersion":1,"position":[1140,920],"alwaysOutputData":false},{"parameters":{"values":{"boolean":[{"name":"debug"}],"string":[{"name":"apiUrl","value":"https://dstt.postmart.com.vn/api/prs"},{"name":"apiToken","value":"7a51b166dfe235dfec2901a24ed2f671"},{"name":"cutOffTime","value":"={{$today.minus({days: 22})}}"}]},"options":{}},"id":"3b70f130-7da9-4d8c-b18e-828a93c5d684","name":"setData","type":"n8n-nodes-base.set","typeVersion":2,"position":[1380,920]},{"parameters":{},"id":"9862dd0b-fc24-437d-9cec-068df6adae24","name":"No Operation, do nothing","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1020,120]}],"connections":{"Quét file trong folder":{"main":[[{"node":"Lọc file hôm nay","type":"main","index":0}]]},"Lọc file hôm nay":{"main":[[{"node":"SplitFileInFolder","type":"main","index":0}]]},"Down file":{"main":[[{"node":"Chuyển dữ liệu ra xml","type":"main","index":0}]]},"Chuyển dữ liệu ra xml":{"main":[[{"node":"Chuyển sang json","type":"main","index":0}]]},"Làm sạch data":{"main":[[{"node":"ifOnceItem","type":"main","index":0}]]},"Chuyển data sang List":{"main":[[{"node":"SplitOnceItem","type":"main","index":0}]]},"Code":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"Làm sạch data","type":"main","index":0}],[{"node":"SplitFileInFolder","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"IF5","type":"main","index":0}]]},"Check File":{"main":[[{"node":"IF1","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Down file","type":"main","index":0}],[{"node":"SplitFileInFolder","type":"main","index":0}]]},"Code1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Item Lists":{"main":[[{"node":"Split In Batches","type":"main","index":0}]]},"Đánh dấu file đã xong":{"main":[[{"node":"IF2","type":"main","index":0}]]},"Split In Batches":{"main":[[{"node":"Tổng hợp BC","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"Tổng hợp BC":{"main":[[{"node":"IF4","type":"main","index":0}]]},"IF2":{"main":[[{"node":"Item Lists","type":"main","index":0}],[{"node":"SplitFileInFolder","type":"main","index":0}]]},"IF4":{"main":[[{"node":"SplitFileInFolder","type":"main","index":0}],[{"node":"Split In Batches","type":"main","index":0}]]},"SplitOnceItem":{"main":[[{"node":"Code1","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"SplitFileInFolder":{"main":[[{"node":"Check File","type":"main","index":0}],[{"node":"No Operation, do nothing","type":"main","index":0}]]},"IF5":{"main":[[{"node":"Đánh dấu file đã xong","type":"main","index":0}],[{"node":"SplitOnceItem","type":"main","index":0}]]},"ifOnceItem":{"main":[[{"node":"Code2","type":"main","index":0}],[{"node":"Chuyển data sang List","type":"main","index":0}]]},"Code2":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Chuyển sang json":{"main":[[{"node":"Code","type":"main","index":0}]]},"Execute Workflow Trigger":{"main":[[{"node":"setData","type":"main","index":0}]]},"setData":{"main":[[{"node":"Quét file trong folder","type":"main","index":0}]]}},"settings":{},"staticData":{"node:Schedule Trigger":{"recurrencyRules":[10]}},"pinData":{},"versionId":"9cda001b-9d83-4233-8bd9-c94f3d1fa6f0","triggerCount":1,"tags":[]}
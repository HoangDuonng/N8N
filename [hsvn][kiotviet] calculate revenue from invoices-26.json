{"createdAt":"2023-02-03T07:16:37.982Z","updatedAt":"2023-06-19T10:11:52.000Z","id":"26","name":"[HSVN][KiotViet] Calculate revenue from invoices","active":false,"nodes":[{"parameters":{"path":"hsvn-kiotviet","options":{}},"id":"5e0202dd-a8e6-406b-b30b-a8c6dc448e31","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[440,500],"webhookId":"d7e63753-bd37-410c-80e9-a6be56b4f36b"},{"parameters":{"conditions":{"number":[{"value1":"={{ $node[\"Invoices data\"].json[\"total\"] }}","operation":"larger","value2":"={{ $node[\"Invoices data\"].json[\"pageSize\"] + ($node[\"Config request\"].json['data'][\"currentItem\"]) }}"}]}},"id":"282d9723-57d6-47a4-a591-462fc81acf7b","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[1540,500]},{"parameters":{"method":"POST","url":"https://id.kiotviet.vn/connect/token","sendBody":true,"contentType":"form-urlencoded","bodyParameters":{"parameters":[{"name":"scopes","value":"PublicApi.Access"},{"name":"grant_type","value":"client_credentials"},{"name":"client_id"},{"name":"client_secret"}]},"options":{}},"id":"f79f94ab-ab02-48ae-853c-15392b2a1aa8","name":"Get access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[640,500]},{"parameters":{"url":"={{ $json[\"data\"][\"endpoint\"] }}&currentItem={{ $json[\"data\"][\"currentItem\"] }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get access token\"].json[\"access_token\"] }}"},{"name":"Retailer","value":"hsvn"}]},"options":{}},"id":"802bd778-8da5-4718-8013-3b977885820b","name":"Invoices data","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1100,500]},{"parameters":{"jsCode":"const allData = []\n\nlet counter = 0;\n\ndo {\n  try {\n    const data = $('Flatten list data').all(0, counter);\n    allData.push(...data);\n  } catch (error) {\n    return allData.map(data => ({ json: data.json}));\n  }\n\n  counter++;\n} while(true);"},"id":"5173ce4d-b6d8-4871-a12f-2204f65c85d1","name":"Merge data","type":"n8n-nodes-base.code","typeVersion":1,"position":[1820,480]},{"parameters":{"jsCode":"const reducedData = $('Merge data').all().reduce((acc, cur) => {\n  return cur.json.total + acc\n}, 0)\n\nreturn {total: reducedData};"},"id":"dbf95d4c-b05d-4079-9e46-84e60af8858f","name":"Calculate Revenue","type":"n8n-nodes-base.code","typeVersion":1,"position":[2020,480]},{"parameters":{"jsCode":"const now = new Date();\n\nconst firstDay = new Date(now.getFullYear(), now.getMonth(), 1);\n\nlet lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);\nlastDay.setSeconds(lastDay.getSeconds() - 1);\n\nreturn (\n  (items[0].json?.data && { data: items[0].json?.data }) || {\n    data: {\n      endpoint: `https://public.kiotapi.com/invoices?fromPurchaseDate=${firstDay.toISOString()}&toPurchaseDate=${lastDay.toISOString()}&orderBy=createdDate&orderDirection=asc`,\n      currentItem: 0,\n    },\n  }\n);"},"id":"1745ac40-44a2-4e79-a517-e7bf494ec275","name":"Config request","type":"n8n-nodes-base.code","typeVersion":1,"position":[860,500]},{"parameters":{"jsCode":"const result = $('Config request').all()[0].json;\n\nresult.data.currentItem += $('Invoices data').first().json.pageSize;\n\nreturn result;"},"id":"174894da-fa03-4791-b127-3855e61c401c","name":"Set next page number","type":"n8n-nodes-base.code","typeVersion":1,"position":[1540,680]},{"parameters":{"fieldToSplitOut":"=data","options":{}},"id":"d0e5aaad-98dc-4178-a09d-da72fbd61c8e","name":"Flatten list data","type":"n8n-nodes-base.itemLists","typeVersion":1,"position":[1320,500]}],"connections":{"Webhook":{"main":[[{"node":"Get access token","type":"main","index":0}]]},"IF":{"main":[[{"node":"Set next page number","type":"main","index":0}],[{"node":"Merge data","type":"main","index":0}]]},"Get access token":{"main":[[{"node":"Config request","type":"main","index":0}]]},"Invoices data":{"main":[[{"node":"Flatten list data","type":"main","index":0}]]},"Merge data":{"main":[[{"node":"Calculate Revenue","type":"main","index":0}]]},"Config request":{"main":[[{"node":"Invoices data","type":"main","index":0}]]},"Set next page number":{"main":[[{"node":"Config request","type":"main","index":0}]]},"Flatten list data":{"main":[[{"node":"IF","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"PostmanRuntime/7.30.0","accept":"*/*","accept-encoding":"gzip, deflate, br","cache-control":"no-cache","postman-token":"153f5454-73a2-4780-8cca-f335b423b475","x-forwarded-for":"125.235.236.102","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"af4013275608","x-real-ip":"125.235.236.102"},"params":{},"query":{},"body":{}}}],"Get access token":[{"json":{"access_token":"eyJhbGciOiJSUzI1NiIsInR5cCI6ImF0K2p3dCJ9.eyJuYmYiOjE2NzU0MDg5MTYsImV4cCI6MTY3NTQ5NTMxNiwiaXNzIjoiaHR0cDovL2lkLmtpb3R2aWV0LnZuIiwiY2xpZW50X2lkIjoiZmQ3YTUyYjEtZDJkYS00YzgzLWFlY2ItYWViODA5YzE1NWFkIiwiY2xpZW50X1JldGFpbGVyQ29kZSI6Imhzdm4iLCJjbGllbnRfUmV0YWlsZXJJZCI6IjgyNjcxIiwiY2xpZW50X1VzZXJJZCI6IjMyODAzMyIsImNsaWVudF9TZW5zaXRpdmVBcGkiOiJUcnVlIiwiaWF0IjoxNjc1NDA4OTE2LCJzY29wZSI6WyJQdWJsaWNBcGkuQWNjZXNzIl19.JiWJuOLssMC6I41AIi3evD6RaGGGEiBVgafjwmL9P_0RmLuVb1XowiyOtS7J5c2r0i-iC86kytRphTbf6Xe25ynmhrAA0hB2TsD6fmuUSBBsz9ImOZjVIqxf3yTz9b6zHGG2DMzgxW6RwTKZ8oKbYlmDhVSStOBAqjyO0JyU-xmSoyJ7Aod8F8445hgq06Lf1LRnR3hn33zQwQBIuTr1u4KQvalT2c7u7gP0tVLaUlsrYEdRvjWk2BXpu_EWceX-_KPfXdkhcn-WuHGrMPfnAMAfiXcr4plpZwpHKVJeCxm2cSZ55vU8XyDAwUYmvSMvUabDJt0Tj57qCcABnf2_rQ","expires_in":86400,"token_type":"Bearer","scope":"PublicApi.Access"}}]},"versionId":"d09d4865-9615-4846-a745-e70e1b161157","triggerCount":0,"tags":[]}
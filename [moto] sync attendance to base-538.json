{"createdAt":"2023-09-20T00:47:09.096Z","updatedAt":"2023-09-20T00:50:03.000Z","id":"538","name":"[Moto] Sync Attendance to Base","active":false,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":21}]}},"id":"caecffe9-e0a8-4dd9-a579-66820d22505d","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-2600,1500]},{"parameters":{"method":"POST","url":"\t https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a4f2f2539db8d02f"},{"name":"app_secret","value":"nnuHqN4YPTlQcGOduU0C6gpQtgpMkVNk"}]},"options":{}},"id":"9d55667b-d6ff-49c0-9d06-60effeb044de","name":"tenant_access_token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2380,1500]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tblczYjBlnB2AZJv/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.tenant_access_token }}"}]},"options":{}},"id":"c1101591-a407-46bf-90e2-6712076788d7","name":"user_access_token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2160,1500]},{"parameters":{"url":"\thttps://open.larksuite.com/open-apis/contact/v3/departments/0/children","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.data.items[0].fields.user_access_token }}"}]},"options":{}},"id":"39bdda2f-2843-4586-acdd-6e1a98f93b34","name":"sub_departments","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1920,1500]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst input = $('sub_departments').item.json.data.items;\nconst arr=[]\nfor (const item of input)\n  {\n    // const jsonValue = JSON.parse();\n    arr.push({'open_department_id': item.open_department_id});\n  }\nreturn arr;\n"},"id":"f83a2bcc-a969-40ea-b6a4-d79393ab1c86","name":"open_department_id","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1700,1500]},{"parameters":{"url":"https://open.larksuite.com/open-apis/contact/v3/users/find_by_department","sendQuery":true,"queryParameters":{"parameters":[{"name":"department_id","value":"={{ $json.open_department_id }}"},{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('user_access_token').item.json.data.items[0].fields.user_access_token }} "}]},"options":{}},"id":"0bfe6e47-6a9f-4a00-9b5a-6ff5b111b336","name":"users_by_department","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1080,820]},{"parameters":{"jsCode":"const input =  $node[\"users_by_department\"].json;\nconst user_infos = [];\nfor (const item of input.data.items){\n  user_infos.push(item);\n};\n\n\n\nreturn user_infos;\n"},"id":"0dbbcc92-70b2-44b3-b630-bfcaa6e4a61c","name":"user_info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-780,820]},{"parameters":{"batchSize":1,"options":{}},"id":"1269903e-0fe4-454e-b765-f719c68e8b32","name":"Split user_info","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-540,820]},{"parameters":{"jsCode":"function findKeyByValue(obj, value) {\n  for (let key in obj) {\n    if (obj.hasOwnProperty(key) && obj[key] === value) {\n      return key;\n    }\n  }\n  return null; // Return null if the value is not found\n}\n\nconst status = $('Split user_info').item.json.status;\nconst value_status = findKeyByValue(status, true)\n\n\n\nconst jsonValue = {\n    fields: {  \n  \"user_id\":$('Split user_info').item.json.user_id,\n  \"name\":$('Split user_info').item.json.name,\n  \"department\": $('Split user_info').item.json.department_path\n[0].department_name.name,\n  \"job_title\": $('Split user_info').item.json.job_title,\n  \"job_title\": $('Split user_info').item.json.job_title,\n  \"status\": value_status\n    }\n  }\n\n  // Return the JSON object\nreturn jsonValue;"},"id":"af514e75-b427-4fdd-875a-c50488c87a6d","name":"create_fields_user_info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-300,700]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendQuery":true,"queryParameters":{"parameters":[{"name":"filter","value":"=CurrentValue.[user_id]=\"{{ $json.fields.user_id }}\""}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"options":{}},"id":"50a7cb7f-034d-4391-b157-bf345120475a","name":"filter_info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-80,700]},{"parameters":{"conditions":{"number":[{"value1":"={{ $('filter_info').item.json.data.items.length }}","operation":"largerEqual","value2":1}]}},"id":"10f695e9-7164-4e7e-9b58-4e8a34ec9da2","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[140,700]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $('create_fields_user_info').item.json.fields }}"}]},"options":{}},"id":"53fbca43-b006-465b-a55e-4b394f36085e","name":"create_new_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[460,840]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records/ {{ $('filter_info').item.json.data.items[0].record_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $('create_fields_user_info').item.json.fields }}"}]},"options":{}},"id":"8c9bc401-cd78-4b18-8452-547b60b2f8f2","name":"update_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[460,460]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').item.json.tenant_access_token }}"}]},"options":{}},"id":"24b8f3fe-46eb-4d93-9774-f81211a13795","name":"list_user_id_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[540,1640]},{"parameters":{"batchSize":"=1","options":{}},"id":"f0b7be61-41cb-43f9-a529-0c29b3e25286","name":"split_user_id","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[1080,1640]},{"parameters":{"jsCode":"const date = new Date();\nconst year = date.getUTCFullYear();\nconst month = String(date.getUTCMonth() + 1).padStart(2, \"0\");\nconst day = String(date.getUTCDate()).padStart(2, \"0\");\n\nconst formattedDate = parseInt(year.toString() + month.toString() + day.toString());\n\nconst input = $('list_user_id_record').item.json.data.items;\nconst lst_user_ids = [];\nfor (const user of input){\n  lst_user_ids.push({'user_id': [user.fields.user_id], 'today': formattedDate})\n}\n  // Return the JSON object\nreturn lst_user_ids;"},"id":"aaa10763-1738-471b-a419-a830609115d1","name":"user_id | today","type":"n8n-nodes-base.code","typeVersion":2,"position":[820,1640]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/attendance/v1/user_tasks/query","sendQuery":true,"queryParameters":{"parameters":[{"name":"employee_type","value":"employee_id"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"user_ids","value":"={{ $('user_id | today').item.json.user_id }}"},{"name":"check_date_from","value":"={{ $('user_id | today').item.json.today }}"},{"name":"check_date_to","value":"={{ $('user_id | today').item.json.today }}"}]},"options":{}},"id":"88a03b8f-6b12-47c6-8d86-52663aeb0134","name":"attendance_result_by_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1380,1380]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"198d7d3d-44d5-49bf-af25-6aa316a1f630","name":"create_attendance_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2220,1660]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user').item.json.data.user_task_results[0];\n\nconst attendance_results = {\n    fields: {  \n  \"user_id\":jsonValue.user_id,\n  \"day\": Date.now(),\n\n//check_in\n  \"check_in_result\": jsonValue.records[0].check_in_result, \n      \n  \"check_in_time\": jsonValue.records[0].check_in_result === 'Lack' ? parseInt(jsonValue.records[0].check_in_shift_time)* 1000 : +parseInt(jsonValue.records[0].check_in_record.check_time)* 1000, \n      \n  \"check_in_shift_time\": parseInt(jsonValue.records[0].check_in_shift_time)* 1000,\n      \n  \"location_name_in\":jsonValue.records[0].check_in_result === 'Lack' ? \"\" : jsonValue.records[0].check_in_record.location_name,\n\n//check_out\n  \"check_out_result\":jsonValue.records[0].check_out_result, \n      \n  \"check_out_time\":jsonValue.records[0].check_out_result === 'Lack' ? parseInt(jsonValue.records[0].check_out_shift_time)* 1000 : +parseInt(jsonValue.records[0].check_out_record.check_time)* 1000,   \n      \n  \"check_out_shift_time\": parseInt(jsonValue.records[0].check_out_shift_time)* 1000,\n      \n  \"location_name_out\":jsonValue.records[0].check_out_result === 'Lack' ? \"\" : jsonValue.records[0].check_out_record.location_name\n    }\n  }\n\n\nreturn attendance_results;"},"id":"f50f708f-9761-46d3-9681-cb94e533cc97","name":"real_attendance_result","type":"n8n-nodes-base.code","typeVersion":2,"position":[1960,1660]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user').item.json.data.user_task_results[0];\n\nconst attendance_results = {\n    fields: {\n      \"user_id\": $('split_user_id').item.json.user_id[0],\n  \"day\": Date.now(),\n\n//check_in\n  \"check_in_result\": 'Lack',      \n  \"location_name_in\":'',\n\n//check_out\n  \"check_out_result\":'Lack',       \n  \"location_name_out\":''\n    }\n  }\n\n\nreturn attendance_results;"},"id":"208fe8f4-cb57-4c1a-ae50-317777aa04fa","name":"not_attendance_results","type":"n8n-nodes-base.code","typeVersion":2,"position":[1940,1160]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"fb667132-241a-4322-86f0-10142ccf5509","name":"create_attendance_record1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2220,1160]},{"parameters":{"content":"Cập nhật thông tin user vaof Base"},"id":"d4c311ea-f8c2-4e79-83f2-27bb60265134","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[980,580]},{"parameters":{"content":"Đoạn này là cập nhật chấm công vào base"},"id":"da1df599-f7ff-4e1c-8350-ebd6878e3b45","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[2720,1400]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.data.user_task_results.length }}","operation":"equal"}]}},"id":"9ae8a05c-80d9-4a75-92bb-81cb1c0d4c86","name":"IF attendance result?","type":"n8n-nodes-base.if","typeVersion":1,"position":[1600,1380]},{"parameters":{"batchSize":"=1","options":{}},"id":"f5d618a8-618d-448e-a8fa-fddccb7cab07","name":"Split department","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-1420,1500]}],"connections":{"Schedule Trigger":{"main":[[{"node":"tenant_access_token","type":"main","index":0}]]},"tenant_access_token":{"main":[[{"node":"user_access_token","type":"main","index":0}]]},"user_access_token":{"main":[[{"node":"sub_departments","type":"main","index":0}]]},"sub_departments":{"main":[[{"node":"open_department_id","type":"main","index":0}]]},"open_department_id":{"main":[[{"node":"Split department","type":"main","index":0}]]},"users_by_department":{"main":[[{"node":"user_info","type":"main","index":0}]]},"user_info":{"main":[[{"node":"Split user_info","type":"main","index":0}]]},"Split user_info":{"main":[[{"node":"create_fields_user_info","type":"main","index":0}],[{"node":"list_user_id_record","type":"main","index":0}]]},"create_fields_user_info":{"main":[[{"node":"filter_info","type":"main","index":0}]]},"filter_info":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"update_user","type":"main","index":0}],[{"node":"create_new_user","type":"main","index":0}]]},"create_new_user":{"main":[[{"node":"user_info","type":"main","index":0}]]},"update_user":{"main":[[{"node":"user_info","type":"main","index":0}]]},"list_user_id_record":{"main":[[{"node":"user_id | today","type":"main","index":0}]]},"split_user_id":{"main":[[{"node":"attendance_result_by_user","type":"main","index":0}]]},"user_id | today":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"attendance_result_by_user":{"main":[[{"node":"IF attendance result?","type":"main","index":0}]]},"create_attendance_record":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"real_attendance_result":{"main":[[{"node":"create_attendance_record","type":"main","index":0}]]},"not_attendance_results":{"main":[[{"node":"create_attendance_record1","type":"main","index":0}]]},"create_attendance_record1":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"IF attendance result?":{"main":[[{"node":"not_attendance_results","type":"main","index":0}],[{"node":"real_attendance_result","type":"main","index":0}]]},"Split department":{"main":[[{"node":"users_by_department","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"4251f6f0-4ea4-4e39-b418-5efa03494799","triggerCount":0,"tags":[]}
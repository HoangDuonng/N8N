{"createdAt":"2023-09-20T00:47:09.096Z","updatedAt":"2023-09-23T18:36:09.000Z","id":"538","name":"[Moto] Sync Attendance to Base","active":true,"nodes":[{"parameters":{"rule":{"interval":[{"triggerAtHour":19}]}},"id":"e3c03373-eb3f-46f5-8d0e-9ab6084daf3f","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.1,"position":[-5340,280]},{"parameters":{"method":"POST","url":"\t https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a4f2f2539db8d02f"},{"name":"app_secret","value":"nnuHqN4YPTlQcGOduU0C6gpQtgpMkVNk"}]},"options":{}},"id":"1442a320-0c8d-4e0f-9e61-5070e8c16b93","name":"tenant_access_token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-5060,280]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tblczYjBlnB2AZJv/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.tenant_access_token }}"}]},"options":{}},"id":"2d675d54-6a3d-4c23-a447-fdb77fbc995f","name":"user_access_token","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-4486,1480]},{"parameters":{"url":"https://open.larksuite.com/open-apis/contact/v3/users/find_by_department","sendQuery":true,"queryParameters":{"parameters":[{"name":"department_id","value":"={{ $json.open_department_id }}"},{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('user_access_token').item.json.data.items[0].fields.user_access_token }} "}]},"options":{}},"id":"f2a52126-3258-474d-b96f-5f666e83f502","name":"users_by_department","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-1686,1240]},{"parameters":{"jsCode":"const input =  $node[\"users_by_department\"].json;\nconst user_infos = [];\nfor (const item of input.data.items){\n  user_infos.push(item);\n};\n\nfor (var i = 0; i < user_infos.length; i++) {\n  user_infos[i].stt = i + 1;\n  user_infos[i].total_user = user_infos.length;\n}\n\nreturn user_infos;\n"},"id":"012d5455-6a75-47aa-b4f3-f83b696c065e","name":"user_info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-1386,1240]},{"parameters":{"batchSize":1,"options":{"reset":"={{$node[\"Split user_info\"].context[\"noItemsLeft\"]}}"}},"id":"43164818-c3c8-4e1e-95ff-e8903fd8e652","name":"Split user_info","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-1106,1240]},{"parameters":{"jsCode":"function findKeyByValue(obj, value) {\n  for (let key in obj) {\n    if (obj.hasOwnProperty(key) && obj[key] === value) {\n      return key;\n    }\n  }\n  return null; // Return null if the value is not found\n}\n\nconst status = $('Split user_info').item.json.status;\nconst value_status = findKeyByValue(status, true)\n\n\n\nconst jsonValue = {\n    fields: {  \n  \"user_id\":$('Split user_info').item.json.user_id,\n  \"name\":$('Split user_info').item.json.name,\n  \"person\":[{'id': $('Split user_info').item.json.open_id}],\n  \"department\": $('Split user_info').item.json.department_path\n[0].department_name.name,\n  \"job_title\": $('Split user_info').item.json.job_title,\n  \"status\": value_status\n    },\n  stt: $('Split user_info').item.json.stt\n  }\n\n  // Return the JSON object\nreturn jsonValue;"},"id":"214d0ec9-8d9b-4d6c-86fc-f65d4c86a717","name":"create_fields_user_info","type":"n8n-nodes-base.code","typeVersion":2,"position":[-806,1220]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendQuery":true,"queryParameters":{"parameters":[{"name":"filter","value":"=CurrentValue.[user_id]=\"{{ $json.fields.user_id }}\""}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"options":{}},"id":"cf551e0e-3e9f-4d75-8938-aca0f963d294","name":"filter_info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-586,1220]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $('create_fields_user_info').item.json.fields }}"}]},"options":{}},"id":"8abe67e3-8d1a-487a-9d79-4faf1170391f","name":"create_new_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-66,1480]},{"parameters":{"method":"PUT","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records/{{ $('filter_info').item.json.data.items[0].record_id }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $('create_fields_user_info').item.json.fields }}"}]},"options":{}},"id":"7644696b-8b79-41a5-b392-a8ab90d1ea6b","name":"update_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-66,1020]},{"parameters":{"content":"CẬP NHẬT DỮ LIỆU NGƯỜI DÙNG","height":792.128356254093,"width":2711.969770520628},"id":"4a0fa92d-f80e-4754-ab08-20f674f214cf","name":"Sticky Note","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4580,980]},{"parameters":{"content":"CẬP NHẬT DỮ LIỆU CHẤM CÔNG CỦA NGÀY HÔM NAY THEO DANH SÁCH NGƯỜI DÙNG TỪ LARK BASE","height":817.6784544859191,"width":2686.185330713818},"id":"5d889485-e945-43ac-a8b7-d07144bb17d1","name":"Sticky Note1","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4580,-60]},{"parameters":{"conditions":{"boolean":[{"value1":true,"value2":"={{$node[\"Split user_info\"].context[\"noItemsLeft\"]}}"}]}},"id":"f57b2e68-abbd-4fd7-a9c3-b78cf2f1ec4d","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[214,1220]},{"parameters":{"conditions":{"number":[{"value1":"={{ $('filter_info').item.json.data.items.length }}","operation":"largerEqual","value2":1}]}},"id":"b44f3d03-6505-47af-a6a1-3da29d94b2bb","name":"Update / Create?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-366,1220]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.data.items.length }}","operation":"largerEqual","value2":1}]}},"id":"660ebeb8-7fe0-4893-989d-42714b9a9562","name":"Has children_department?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-3206,1140]},{"parameters":{"url":"\thttps://open.larksuite.com/open-apis/contact/v3/departments/0/children","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.data.items[0].fields.user_access_token }}"}]},"options":{}},"id":"81369e3e-00fa-48b1-8078-c53df6365e7e","name":"Get parent department info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-4206,1480]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nconst input = $('Get parent department info').item.json.data.items;\nconst arr=[]\nfor (const item of input)\n  {\n    // const jsonValue = JSON.parse();\n    arr.push({'open_department_id': item.open_department_id});\n  }\nreturn arr;\n"},"id":"f0bc4389-7327-4037-b41e-ec46e1050802","name":"get open_parent_department_id","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3986,1480]},{"parameters":{"batchSize":1,"options":{}},"id":"02a93ac6-1005-4685-98d8-a9cf50b34bdf","name":"Split open_parent_department_id","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-3706,1160]},{"parameters":{"url":"=https://open.larksuite.com/open-apis/contact/v3/departments/{{ $json.open_department_id }}/children","sendQuery":true,"queryParameters":{"parameters":[{"name":"page_size","value":"50"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('user_access_token').item.json.data.items[0].fields.user_access_token }}"}]},"options":{}},"id":"3f326348-6e7f-4f10-bafe-1769c9ee4b5d","name":"Get children department info","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-3426,1140]},{"parameters":{},"id":"75d95acb-eeb6-4671-9cce-a9e5a87706ae","name":"Merge","type":"n8n-nodes-base.merge","typeVersion":2.1,"position":[-2506,1520]},{"parameters":{"content":"CẬP NHẬT/ TẠO MỚI DỮ LIỆU NGƯỜI DÙNG THUỘC CÁC DEPARTMENT","height":817.6784544859191,"width":2686.185330713818},"id":"c789f9d1-9155-4827-8491-4e636ffdca13","name":"Sticky Note2","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1526,1000]},{"parameters":{"batchSize":"=1","options":{"reset":false}},"id":"4799b4c9-b97e-4f77-9bda-3be0c0b0ee74","name":"Split open_department_id","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-2166,1500]},{"parameters":{"jsCode":"// Loop over input items and add a new field called 'myNewField' to the JSON of each one\n// const list_department = $items('get open_parent_department_id');\nconst input = $('Has children_department?').item.json.data.items;\nconst arr=[]\nfor (const item of input)\n  {\n    arr.push({'open_department_id': item.open_department_id});\n  }\n\nreturn arr;\n"},"id":"702d4db3-db49-4a62-b720-704443b9f5c9","name":"Get children_open_department_id","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2946,1120]},{"parameters":{"content":"CẬP NHẬT DỮ LIỆU CHẤM CÔNG CỦA CẢ THÁNG ĐẾN NGÀY HÔM NAY THEO DANH SÁCH NGƯỜI DÙNG TỪ LARK BASE","height":1000.3230869138439,"width":3328.099362308787},"id":"23578869-3d70-4907-97d1-d10d515fbbe9","name":"Sticky Note3","type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4560,-1300]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').item.json.tenant_access_token }}"}]},"options":{}},"id":"874f6dfa-bd87-4a83-b508-fdefca9d0a89","name":"list_user_id_record1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-4520,-880],"executeOnce":true},{"parameters":{"batchSize":"=1","options":{}},"id":"356ba03c-4e2b-4e4a-9942-0191ec75154c","name":"split_user_id1","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-4020,-880]},{"parameters":{"jsCode":"const date = new Date();\nconst year = date.getUTCFullYear();\nconst month = String(date.getUTCMonth() + 1).padStart(2, \"0\");\nconst day = String(date.getUTCDate()).padStart(2, \"0\");\n\nconst formattedDate = parseInt(year.toString() + month.toString() + day.toString());\n\nconst input = $('list_user_id_record1').item.json.data.items;\nconst filteredList = input.filter(item => item.fields.status === 'is_activated');\nconst lst_user_ids = [];\nfor (const user of filteredList){\n  lst_user_ids.push({'user_id': [user.fields.user_id], 'today': formattedDate})\n}\n  // Return the JSON object\nreturn lst_user_ids;"},"id":"537a6447-92ed-4554-8120-d2340ff66958","name":"user_id | today1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4280,-880]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/attendance/v1/user_tasks/query","sendQuery":true,"queryParameters":{"parameters":[{"name":"employee_type","value":"employee_id"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"user_ids","value":"={{ $('split_user_id1').item.json.user_id }}"},{"name":"check_date_from","value":"={{ $json.day_int }}"},{"name":"check_date_to","value":"={{ $json.day_int }}"}]},"options":{}},"id":"afcdfe37-08fc-4a1d-a947-7753e9904dc8","name":"attendance_result_by_user1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-3100,-900]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"8eae1f95-8016-4c02-bb61-50b402c48724","name":"create_attendance_record2","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2260,-620]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user1').item.json.data.user_task_results[0];\n\nif (jsonValue.records[0].check_in_result === 'Lack' || jsonValue.records[0].check_in_result === 'NoNeedCheck')\n{\nreturn {\n    fields: {  \n  \"user_id\":jsonValue.user_id,\n  'day': $('get day').item.json.data_timestamp,\n\n//check_in\n  \"check_in_result\": jsonValue.records[0].check_in_result, \n     \n  \"check_in_shift_time\": parseInt(jsonValue.records[0].check_in_shift_time)* 1000,\n\n\n//check_out\n  \"check_out_result\":jsonValue.records[0].check_out_result, \n  \n      \n  \"check_out_shift_time\": parseInt(jsonValue.records[0].check_out_shift_time)* 1000,\n\n    }\n  }\n} \nelse \n{\n  return {\n    fields: {  \n  \"user_id\":jsonValue.user_id,\n  'day': $('get day').item.json.data_timestamp,\n\n//check_in\n  \"check_in_result\": jsonValue.records[0].check_in_result, \n      \n  \"check_in_time\": parseInt(jsonValue.records[0].check_in_record.check_time)* 1000, \n      \n  \"check_in_shift_time\": parseInt(jsonValue.records[0].check_in_shift_time)* 1000,\n      \n  \"location_name_in\":jsonValue.records[0].check_in_result === 'Lack' ? \"\" : jsonValue.records[0].check_in_record.location_name,\n\n//check_out\n  \"check_out_result\":jsonValue.records[0].check_out_result, \n      \n  \"check_out_time\":jsonValue.records[0].check_out_result === 'Lack' ? parseInt(jsonValue.records[0].check_out_shift_time)* 1000 : +parseInt(jsonValue.records[0].check_out_record.check_time)* 1000,   \n      \n  \"check_out_shift_time\": parseInt(jsonValue.records[0].check_out_shift_time)* 1000,\n      \n  \"location_name_out\":jsonValue.records[0].check_out_result === 'Lack' ? \"\" : jsonValue.records[0].check_out_record.location_name\n    }\n  }\n}\n"},"id":"e8cc75ee-76a9-4fb4-a62a-8fef40ae7033","name":"real_attendance_result1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2520,-620]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user1').item.json.data.user_task_results[0];\n\nconst attendance_results = {\n    fields: {\n      \"user_id\": $('split_user_id1').item.json.user_id[0],\n\n//check_in\n  \"check_in_result\": 'Lack',      \n  \"location_name_in\":'',\n  'day': $('get day').item.json.data_timestamp,\n\n//check_out\n  \"check_out_result\":'Lack',       \n  \"location_name_out\":''\n    }\n  }\n\n\nreturn attendance_results;"},"id":"c7b8907d-b07d-4f30-bf2e-8b7ab13ed501","name":"not_attendance_results1","type":"n8n-nodes-base.code","typeVersion":2,"position":[-2540,-1120]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"f50687f4-3806-43dd-b404-86542895c983","name":"create_attendance_record3","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2260,-1120]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.data.user_task_results.length }}","operation":"equal"}]},"combineOperation":"any"},"id":"5bf28f24-88d0-480d-9ed4-b145927c2a7e","name":"IF attendance result?1","type":"n8n-nodes-base.if","typeVersion":1,"position":[-2840,-900]},{"parameters":{"jsCode":"function getDatesFromStartOfMonth() {\n  var today = new Date();\n  var year = today.getFullYear();\n  var month = today.getMonth(); // Giá trị tháng từ 0 đến 11\n  var dates = [];\n\n  for (var day = 1; day <= today.getDate(); day++) {\n    var date = new Date(year, month, day);\n    var formattedMonth = (month + 1).toString().padStart(2, '0');\n    var formattedDay = day.toString().padStart(2, '0');\n    var formattedDate = parseInt(year + formattedMonth + formattedDay);\n    var timestamp = date.getTime();\n\n    var dateObject = {\n      day_int: formattedDate,\n      day_timestamp: timestamp\n    };\n\n    dates.push(dateObject);\n  }\n\n  return dates;\n}\n\n// Sử dụng hàm getDatesFromStartOfMonth để lấy danh sách các ngày từ đầu tháng đến hôm nay\nvar dateList = getDatesFromStartOfMonth();\n\nreturn dateList;"},"id":"92d5960e-5a9f-44e4-85b9-d2308f1e17d2","name":"get day","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3720,-900]},{"parameters":{"batchSize":1,"options":{"reset":"={{$node[\"Split In Batches\"].context[\"noItemsLeft\"]}}"}},"id":"112dd5bb-2d63-411d-aa92-6b18c651cccf","name":"Split In Batches","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-3500,-900]},{"parameters":{"conditions":{"boolean":[{"value2":"={{$node[\"Split In Batches\"].context[\"noItemsLeft\"]}}"}]}},"id":"8e237a8a-11ec-445c-a2e9-69c844fad617","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[-1880,-900]},{"parameters":{"url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbllMlNLDXOIYRAq/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').item.json.tenant_access_token }}"}]},"options":{}},"id":"d8f63cde-6ad1-43bf-9956-55137dfde0d0","name":"list_user_id_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-4520,320],"executeOnce":true},{"parameters":{"batchSize":"=1","options":{}},"id":"3ce511d1-2fc5-452a-8742-781066d3bd8c","name":"split_user_id","type":"n8n-nodes-base.splitInBatches","typeVersion":2,"position":[-4020,320]},{"parameters":{"jsCode":"const date = new Date();\nconst year = date.getUTCFullYear();\nconst month = String(date.getUTCMonth() + 1).padStart(2, \"0\");\nconst day = String(date.getUTCDate()).padStart(2, \"0\");\n\nconst formattedDate = parseInt(year.toString() + month.toString() + day.toString());\n\nconst input = $('list_user_id_record').item.json.data.items;\nconst filteredList = input.filter(item => item.fields.status === 'is_activated');\nconst lst_user_ids = [];\nfor (const user of filteredList){\n  lst_user_ids.push({'user_id': [user.fields.user_id], 'today': formattedDate})\n}\n  // Return the JSON object\nreturn lst_user_ids;"},"id":"600bf284-acd0-49c7-b81e-6598661f0a67","name":"user_id | today","type":"n8n-nodes-base.code","typeVersion":2,"position":[-4280,320]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/attendance/v1/user_tasks/query","sendQuery":true,"queryParameters":{"parameters":[{"name":"employee_type","value":"employee_id"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"user_ids","value":"={{ $('split_user_id').item.json.user_id }}"},{"name":"check_date_from","value":"={{ $json.day_int }}"},{"name":"check_date_to","value":"={{ $json.day_int }}"}]},"options":{}},"id":"93c2fc07-83f4-4a3a-8916-9e93036ed8f0","name":"attendance_result_by_user","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-3660,300]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"a68591e8-221a-42b6-a3d2-02c0ca15864a","name":"create_attendance_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2820,580]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user').item.json.data.user_task_results[0];\n\nif (jsonValue.records[0].check_in_result === 'Lack' || jsonValue.records[0].check_in_result === 'NoNeedCheck')\n{\nreturn {\n    fields: {  \n  \"user_id\":jsonValue.user_id,\n  'day': $('get day1').item.json.data_timestamp,\n\n//check_in\n  \"check_in_result\": jsonValue.records[0].check_in_result, \n     \n  \"check_in_shift_time\": parseInt(jsonValue.records[0].check_in_shift_time)* 1000,\n\n\n//check_out\n  \"check_out_result\":jsonValue.records[0].check_out_result, \n  \n      \n  \"check_out_shift_time\": parseInt(jsonValue.records[0].check_out_shift_time)* 1000,\n\n    }\n  }\n} \nelse \n{\n  return {\n    fields: {  \n  \"user_id\":jsonValue.user_id,\n  'day': $('get day1').item.json.data_timestamp,\n\n//check_in\n  \"check_in_result\": jsonValue.records[0].check_in_result, \n      \n  \"check_in_time\": parseInt(jsonValue.records[0].check_in_record.check_time)* 1000, \n      \n  \"check_in_shift_time\": parseInt(jsonValue.records[0].check_in_shift_time)* 1000,\n      \n  \"location_name_in\":jsonValue.records[0].check_in_result === 'Lack' ? \"\" : jsonValue.records[0].check_in_record.location_name,\n\n//check_out\n  \"check_out_result\":jsonValue.records[0].check_out_result, \n      \n  \"check_out_time\":jsonValue.records[0].check_out_result === 'Lack' ? parseInt(jsonValue.records[0].check_out_shift_time)* 1000 : +parseInt(jsonValue.records[0].check_out_record.check_time)* 1000,   \n      \n  \"check_out_shift_time\": parseInt(jsonValue.records[0].check_out_shift_time)* 1000,\n      \n  \"location_name_out\":jsonValue.records[0].check_out_result === 'Lack' ? \"\" : jsonValue.records[0].check_out_record.location_name\n    }\n  }\n}\n"},"id":"a39b227c-f12e-4dac-99ca-8f2a945b5d28","name":"real_attendance_result","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3080,580]},{"parameters":{"jsCode":"const jsonValue = $('attendance_result_by_user').item.json.data.user_task_results[0];\n\nconst attendance_results = {\n    fields: {\n      \"user_id\": $('split_user_id').item.json.user_id[0],\n\n//check_in\n  \"check_in_result\": 'Lack',      \n  \"location_name_in\":'',\n  'day': $('get day1').item.json.data_timestamp,\n\n//check_out\n  \"check_out_result\":'Lack',       \n  \"location_name_out\":''\n    }\n  }\n\n\nreturn attendance_results;"},"id":"f283ccf1-fdb4-41ca-a299-e2c695763149","name":"not_attendance_results","type":"n8n-nodes-base.code","typeVersion":2,"position":[-3100,80]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/XywobHQojaPFcPs1ah9lpnrjgwb/tables/tbl24PUiOPrhJAFN/records","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('tenant_access_token').first().json.tenant_access_token }}"},{"name":"Content-Type","value":"application/json; charset=utf-8"}]},"sendBody":true,"bodyParameters":{"parameters":[{"name":"fields","value":"={{ $json.fields }}"}]},"options":{}},"id":"1b8852bf-55e8-438c-9511-f63fdc8d2276","name":"create_attendance_record4","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[-2820,80]},{"parameters":{"conditions":{"number":[{"value1":"={{ $json.data.user_task_results.length }}","operation":"equal"}]},"combineOperation":"any"},"id":"c4641d2c-fd5e-43eb-9998-c31973bb9f00","name":"IF attendance result?","type":"n8n-nodes-base.if","typeVersion":1,"position":[-3400,300]}],"connections":{"Schedule Trigger":{"main":[[{"node":"tenant_access_token","type":"main","index":0}]]},"tenant_access_token":{"main":[[{"node":"list_user_id_record1","type":"main","index":0}]]},"user_access_token":{"main":[[{"node":"Get parent department info","type":"main","index":0}]]},"users_by_department":{"main":[[{"node":"user_info","type":"main","index":0}]]},"user_info":{"main":[[{"node":"Split user_info","type":"main","index":0}]]},"Split user_info":{"main":[[{"node":"create_fields_user_info","type":"main","index":0}]]},"create_fields_user_info":{"main":[[{"node":"filter_info","type":"main","index":0}]]},"filter_info":{"main":[[{"node":"Update / Create?","type":"main","index":0}]]},"create_new_user":{"main":[[{"node":"IF1","type":"main","index":0}]]},"update_user":{"main":[[{"node":"IF1","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Split open_department_id","type":"main","index":0}],[{"node":"Split user_info","type":"main","index":0}]]},"Update / Create?":{"main":[[{"node":"update_user","type":"main","index":0}],[{"node":"create_new_user","type":"main","index":0}]]},"Has children_department?":{"main":[[{"node":"Get children_open_department_id","type":"main","index":0}],[{"node":"Split open_parent_department_id","type":"main","index":0}]]},"Get parent department info":{"main":[[{"node":"get open_parent_department_id","type":"main","index":0}]]},"get open_parent_department_id":{"main":[[{"node":"Split open_parent_department_id","type":"main","index":0},{"node":"Merge","type":"main","index":1}]]},"Split open_parent_department_id":{"main":[[{"node":"Get children department info","type":"main","index":0}]]},"Get children department info":{"main":[[{"node":"Has children_department?","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Split open_department_id","type":"main","index":0}]]},"Split open_department_id":{"main":[[{"node":"users_by_department","type":"main","index":0}]]},"Get children_open_department_id":{"main":[[{"node":"Merge","type":"main","index":0},{"node":"Split open_parent_department_id","type":"main","index":0}]]},"list_user_id_record1":{"main":[[{"node":"user_id | today1","type":"main","index":0}]]},"split_user_id1":{"main":[[{"node":"get day","type":"main","index":0}]]},"user_id | today1":{"main":[[{"node":"split_user_id1","type":"main","index":0}]]},"attendance_result_by_user1":{"main":[[{"node":"IF attendance result?1","type":"main","index":0}]]},"real_attendance_result1":{"main":[[{"node":"create_attendance_record2","type":"main","index":0}]]},"not_attendance_results1":{"main":[[{"node":"create_attendance_record3","type":"main","index":0}]]},"IF attendance result?1":{"main":[[{"node":"not_attendance_results1","type":"main","index":0}],[{"node":"real_attendance_result1","type":"main","index":0}]]},"get day":{"main":[[{"node":"Split In Batches","type":"main","index":0}]]},"Split In Batches":{"main":[[{"node":"attendance_result_by_user1","type":"main","index":0}]]},"create_attendance_record3":{"main":[[{"node":"IF","type":"main","index":0}]]},"create_attendance_record2":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"split_user_id1","type":"main","index":0}],[{"node":"Split In Batches","type":"main","index":0}]]},"list_user_id_record":{"main":[[{"node":"user_id | today","type":"main","index":0}]]},"split_user_id":{"main":[[{"node":"attendance_result_by_user","type":"main","index":0}]]},"user_id | today":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"attendance_result_by_user":{"main":[[{"node":"IF attendance result?","type":"main","index":0}]]},"create_attendance_record":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"real_attendance_result":{"main":[[{"node":"create_attendance_record","type":"main","index":0}]]},"not_attendance_results":{"main":[[{"node":"create_attendance_record4","type":"main","index":0}]]},"create_attendance_record4":{"main":[[{"node":"split_user_id","type":"main","index":0}]]},"IF attendance result?":{"main":[[{"node":"not_attendance_results","type":"main","index":0}],[{"node":"real_attendance_result","type":"main","index":0}]]}},"settings":{},"staticData":{"node:Schedule Trigger":{"recurrencyRules":[]}},"pinData":{},"versionId":"ba201459-65ef-4754-89a4-5192eb9cecfd","triggerCount":1,"tags":[]}
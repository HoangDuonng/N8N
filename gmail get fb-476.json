{"createdAt":"2023-08-16T15:11:29.974Z","updatedAt":"2023-08-21T21:50:28.000Z","id":"476","name":"Gmail get FB","active":true,"nodes":[{"parameters":{"conditions":{"string":[{"value1":"={{ $json.headers.subject }}","operation":"contains","value2":"Your Meta ads receipt"}]}},"id":"f6cbf303-3d94-426b-96cd-8cd517610c36","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[220,360]},{"parameters":{"jsCode":"// Lấy nội dung văn bản đầu vào từ n8n\nconst inbut = $(\"Gmail\").first().json;\nconst inbutText = inbut.text;\nconst inputText = inbut.html;\n// Sử dụng biểu thức chính quy để trích xuất các thông tin\nconst nameMatch = inputText.match(/Receipt for:<\\/div><div style=\"[^\"]*\">([^<]+)<\\/div>/);\nconst amountMatch = inputText.match(/Amount billed<\\/td><\\/tr><tr><td[^>]*><div[^>]*>([^\\s]+)\\s+([A-Z]{3})<\\/div><\\/td>/);\nconst currencyMatch = inbutText.match(/(£|\\$|€)(\\d+\\.\\d{2}) [A-Z]{3}/);\nconst adIdMatch = inputText.match(/txid=([^&\"]+)/);\nconst adIdLink = inputText.match(/<a href=\"([^\"]*)/)\nconst dateRangeMatch = inputText.match(/Date range<\\/td><\\/tr><tr><td[^>]*><div[^>]*>([^<]+)<\\/div><\\/td><\\/tr>/);\nconst invoiceReasonMatch = inputText.match(/Billing reason<\\/td><\\/tr><tr><td style=\"\"><div[^>]*>([^<]+)<\\/div><\\/td><\\/tr>/);\nconst productTypeMatch = inputText.match(/Product type<\\/td><\\/tr><tr><td style=\"\"><div[^>]*>([^<]+)<\\/div><\\/td><\\/tr>/);\nconst paymentMethodMatch = inputText.match(/Payment method<\\/td><\\/tr><tr><td style=\"\"><div[^>]*>([^<]+)<\\/div><\\/td><\\/tr>/);\nconst referenceNumberMatch = inputText.match(/Reference number[^<]*<\\/td><\\/tr><tr><td style=\"\"><div[^>]*>([^<]+)<\\/div><\\/td><\\/tr>/);\n//const invoiceNumberMatch = inputText.match(/Số hóa đơn: ([^<]*)/);\n//const customerMatch = inputText.match(/Khách hàng: ([^<]*)/);\n//const addressMatch = inputText.match(/Địa chỉ: ([^<]*)/);\n// Lập trình thêm các biểu thức chính quy khác để trích xuất các thông tin còn lại\n\n// Trích xuất thông tin từ các kết quả khớp\nconst accountName = nameMatch && nameMatch[1];\nconst currency = amountMatch && amountMatch[2];\nconst amount1 = amountMatch && amountMatch[1];\nlet amount;\n//Đổi tiền thành số\nif (currency === \"VND\") {\n  const amountString = amount1;\n  const amountWithoutCurrency = amountString.replace(/[^\\d-]/g, \"\");\n  const amountWithoutCurrency1 = amountWithoutCurrency.replace(/(đ|£|\\$|€)/g,\"\");\n  amount = Math.floor(parseFloat(amountWithoutCurrency1));\n} else {\n  const amountString = amount1;\n  //const amountWithoutCurrency = Math.floor(parseFloat(amountString));\n  const amountWithoutCurrency1 = amountString.replace(/(đ|£|\\$|€)/g,\"\");\n  amount = parseInt(amountWithoutCurrency1.replace(/[^\\d-]/g, \",\"));\n}\n\n//tiếp tục\nconst adId = adIdMatch && adIdMatch[1];\nconst adURL = adIdLink && adIdLink[1];\nconst dateRange = dateRangeMatch && dateRangeMatch[1];\nconst invoiceReason = invoiceReasonMatch && invoiceReasonMatch[1];\nconst productType = productTypeMatch && productTypeMatch[1];\nconst paymentMethod = paymentMethodMatch && paymentMethodMatch[1];\nconst referenceNumber = referenceNumberMatch && referenceNumberMatch[1];\n//const invoiceNumber = invoiceNumberMatch && invoiceNumberMatch[1];\n//const customer = customerMatch && customerMatch[1];\n//const address = addressMatch && addressMatch[1];\n// Lập trình thêm các biến để lưu trữ các thông tin còn lại\n\n// Tạo đối tượng JSON để chứa tất cả các thông tin trích xuất\nconst fields = {\n  \"TenTaiKhoanQC\": accountName,\n  \"SoTien\": amount,\n  \"Currency\": currency,\n  \"Idgiaodich\": {\"link\": adURL,\n          \"text\": adId},\n  \"KhoangNgay\": dateRange,\n  \"LyDoLapHoaDon\": invoiceReason,\n  \"LoaiSanPham\": productType,\n  \"PhuongThucThanhToan\": paymentMethod,\n  \"SoThamChieu\": referenceNumber,\n  // Lập trình thêm các thông tin còn lại vào đây\n};\n\n// Trả về đối tượng JSON chứa tất cả thông tin trích xuất\nconst records = [];\nrecords.push({ fields });\nlet result = { json: { records } };\nreturn result;"},"id":"a781f9ee-201e-4c31-b258-fe443798a1d7","name":"Eng-Trans","type":"n8n-nodes-base.code","typeVersion":1,"position":[640,200]},{"parameters":{"postProcessAction":"nothing","format":"resolved","options":{}},"id":"d003dbd7-d738-4a3d-8602-16ff525da8be","name":"Gmail","type":"n8n-nodes-base.emailReadImap","typeVersion":2,"position":[0,360],"alwaysOutputData":true,"retryOnFail":true,"notesInFlow":false,"credentials":{"imap":{"id":"115","name":"IMAP account 3"}}},{"parameters":{"conditions":{"string":[{"value1":"={{ $('Gmail').item.json.subject }}","operation":"contains","value2":"Biên lai"}]}},"id":"62eeb4e1-328d-40c1-8312-65d9cb301f5b","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[440,540]},{"parameters":{"jsCode":"// Lấy nội dung văn bản đầu vào từ n8n\nconst inbut = $(\"Gmail\").first().json;\nconst inbutText = inbut.text;\nconst inputText = inbut.html;\n// Sử dụng biểu thức chính quy để trích xuất các thông tin\nconst nameMatch = inbutText.match(/Biên lai của:\\n(.*?)\\nID giao dịch/);\nconst amountMatch = inbutText.match(/Số tiền đã lập hóa đơn\\n\\n(.*?)₫/);\nconst currencyMatch = inbutText.match(/₫(.*?)\\n/);\nconst adIdMatch = inputText.match(/txid=([^&\"]+)/);\nconst adIdLink = inputText.match(/<a href=\"([^\"]*)/)\nconst dateRangeMatch = inbutText.match(/Khoảng ngày\\n\\n(.*?)\\nLý do lập hóa đơn/);\nconst invoiceReasonMatch = inbutText.match(/Lý do lập hóa đơn\\n\\n(.*?)\\n/);\nconst productTypeMatch = inbutText.match(/Loại sản phẩm\\n\\n(.*?)\\nPHƯƠNG THỨC THANH TOÁN/);\nconst paymentMethodMatch = inbutText.match(/PHƯƠNG THỨC THANH TOÁN\\n\\n(.*?)\\n/);\nconst referenceNumberMatch = inbutText.match(/Số tham chiếu\\n\\n(.*?)\\n/);\nconst invoiceNumberMatch = inputText.match(/Số hóa đơn: ([^<]*)/);\nconst customerMatch = inputText.match(/Khách hàng: ([^<]*)/);\nconst addressMatch = inputText.match(/Địa chỉ: ([^<]*)/);\n// Lập trình thêm các biểu thức chính quy khác để trích xuất các thông tin còn lại\n\n// Trích xuất thông tin từ các kết quả khớp\nconst accountName = nameMatch && nameMatch[1];\nconst amount1 = amountMatch && amountMatch[1];\n//Đổi tiền thành số\nconst amountString = amount1;\nconst amountWithoutCurrency = amountString.replace(/[^\\d-]/g, \"\");\nconst amount = Math.floor(parseFloat(amountWithoutCurrency));\n\nconst currency = currencyMatch && currencyMatch[1].trim();\n//tiếp tục\nconst adId = adIdMatch && adIdMatch[1];\nconst adURL = adIdLink && adIdLink[1];\nconst dateRange = dateRangeMatch && dateRangeMatch[1];\nconst invoiceReason = invoiceReasonMatch && invoiceReasonMatch[1];\nconst productType = productTypeMatch && productTypeMatch[1];\nconst paymentMethod = paymentMethodMatch && paymentMethodMatch[1];\nconst referenceNumber = referenceNumberMatch && referenceNumberMatch[1];\nconst invoiceNumber = invoiceNumberMatch && invoiceNumberMatch[1];\nconst customer = customerMatch && customerMatch[1];\nconst address = addressMatch && addressMatch[1];\n// Lập trình thêm các biến để lưu trữ các thông tin còn lại\n\n// Tạo đối tượng JSON để chứa tất cả các thông tin trích xuất\nconst fields = {\n  \"TenTaiKhoanQC\": accountName,\n  \"SoTien\": amount,\n  \"Currency\": currency,\n  \"Idgiaodich\": {\"link\": adURL,\n          \"text\": adId},\n  \"KhoangNgay\": dateRange,\n  \"LyDoLapHoaDon\": invoiceReason,\n  \"LoaiSanPham\": productType,\n  \"PhuongThucThanhToan\": paymentMethod,\n  \"SoThamChieu\": referenceNumber,\n  // Lập trình thêm các thông tin còn lại vào đây\n};\n\n// Trả về đối tượng JSON chứa tất cả thông tin trích xuất\nconst records = [];\nrecords.push({ fields });\nlet result = { json: { records } };\nreturn result;\n"},"id":"26222a7c-d5c7-451a-9525-4d161cda4aa1","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[660,540]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/PdU8bQkDDaqzZsssYJBlSHhPgLd/tables/tbl0QWieh4ScWg7p/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Tenant').item.json[\"body\"][\"tenant_access_token\"] }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($node[\"Eng-Trans\"].json[\"records\"]) }}}","options":{"response":{"response":{"fullResponse":true}}}},"id":"b7393b7f-cf90-466b-a2d4-50cd8a780e8e","name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1080,320]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a45d02c7fb21d02f"},{"name":"app_secret","value":"bXVZGZ3GaZnqeQmJ8qs92flFvGVbEHSV"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"d6c45c7b-6da3-4265-854d-789074bc2651","name":"Tenant","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[860,320]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal","sendBody":true,"bodyParameters":{"parameters":[{"name":"app_id","value":"cli_a45d02c7fb21d02f"},{"name":"app_secret","value":"bXVZGZ3GaZnqeQmJ8qs92flFvGVbEHSV"}]},"options":{"response":{"response":{"fullResponse":true}}}},"id":"b7bf78eb-4197-4051-810e-edbad5da8b45","name":"TenantVi","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[900,540]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/PdU8bQkDDaqzZsssYJBlSHhPgLd/tables/tbl0QWieh4ScWg7p/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.body.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($node[\"Code\"].json[\"records\"]) }}}\n","options":{"response":{"response":{"fullResponse":true}}}},"id":"a02b8f4a-244f-4dc1-a432-0928ad3e037d","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1100,540]}],"connections":{"IF":{"main":[[{"node":"Eng-Trans","type":"main","index":0}],[{"node":"IF1","type":"main","index":0}]]},"Gmail":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Code","type":"main","index":0}]]},"Eng-Trans":{"main":[[{"node":"Tenant","type":"main","index":0}]]},"Code":{"main":[[{"node":"TenantVi","type":"main","index":0}]]},"Tenant":{"main":[[{"node":"HTTP Request1","type":"main","index":0}]]},"TenantVi":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]}},"settings":{},"staticData":{"node:Email Trigger (IMAP)":{"lastMessageUid":1348},"node:Gmail":{"lastMessageUid":3327}},"pinData":{},"versionId":"057c95fd-1f0e-4ebb-a9ca-5cfea2e1ca54","triggerCount":1,"tags":[]}
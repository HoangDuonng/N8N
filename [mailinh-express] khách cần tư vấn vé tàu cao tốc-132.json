{"createdAt":"2023-06-14T06:51:24.885Z","updatedAt":"2023-06-14T07:08:07.000Z","id":"132","name":"[MaiLinh.express] Khách cần tư vấn vé tàu cao tốc","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"mailinhexpress","options":{}},"id":"9d3f8caa-211d-4639-bd29-088fedadc57e","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[820,500],"webhookId":"6e5da7f2-db4c-45a0-bc5c-2f06d4b927a1"},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/8af563f0-2196-410f-8aea-2284ebf3ff6c","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Code1').first().json)}}","options":{}},"id":"b0f09484-5818-4fc9-bd89-8ffc0c32c333","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1480,500]},{"parameters":{"jsCode":"const data = $('Webhook').first().json.body;\n\nlet ten_ve = \"Vé tàu cao tốc \" + data.tuyen + \" hãng Mai Linh Express\";\nten_ve = ten_ve.replace(/\\n/g, \", \");\n\nlet fullname = data.fullname || '-';\nfullname = fullname.replace(/\\n/g, \", \");\n\nlet phone = data.phone || '-';\nphone = phone.replace(/\\n/g, \", \");\n\nlet sdtZalo = '84' + phone.slice(1);\n\nlet nhieu_thong_tin = false;\nif (data.nhieu_thong_tin !== '') nhieu_thong_tin = true;\n\nlet so_chieu = 2;\nif (data.so_chieu == 'Một chiều') so_chieu = 1;\n\nlet ngay_khoi_hanh = (data.ngay_khoi_hanh === '') ? '-' : new Date(data.ngay_khoi_hanh).toLocaleDateString('en-GB');\n\nlet ngay_tro_ve = (data.ngay_tro_ve === '') ? '-' : new Date(data.ngay_tro_ve).toLocaleDateString('en-GB');\n\nlet so_luong_khach = data.so_luong_khach || 0;\n\nhang = \"Mai Linh Express\";\n\nlet noi_khoi_hanh = data.tuyen.slice(0, data.tuyen.indexOf('-')) || '-';\nnoi_khoi_hanh = noi_khoi_hanh.replace(/\\n/g, \", \");\n\nlet diem_den = data.tuyen.slice(data.tuyen.indexOf('-')+1, data.tuyen.length) || '-';\ndiem_den = diem_den.replace(/\\n/g, \", \");\n\nlet chatcode = Math.floor(Math.random() * 101);\n\nconst source_title = data.source_title;\nconst source_url = data.source_url;\n\nif (nhieu_thong_tin === false) {\n  ngay_khoi_hanh = '-';\n  ngay_tro_ve = '-';\n  hang = '-';\n  so_chieu = '-';\n  so_luong_khach = '-';\n  noi_khoi_hanh = '-';\n  diem_den = '-';\n}\n\nif (so_chieu === 1) {\n  ngay_tro_ve = '-';\n}\nreturn {\n  chatcode,\n  fullname,\n  phone,\n  sdtZalo,\n  nhieu_thong_tin,\n  ten_ve,\n  so_chieu,\n  ngay_khoi_hanh,\n  ngay_tro_ve,\n  so_luong_khach,\n  hang,\n  noi_khoi_hanh,\n  diem_den,\n  source_title,\n  source_url\n}\n\n\n\n"},"id":"d5bf6666-ff64-4320-9715-383fd370ed03","name":"Code","type":"n8n-nodes-base.code","typeVersion":1,"position":[1040,500]},{"parameters":{"jsCode":"const data = $(\"Code\").first().json;\n\nlet elements = [];\n\nelements.push({\n    tag: \"div\",\n    fields: [\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Họ và tên:** ${data.fullname}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số điện thoại:** ${data.phone}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Mã đặt vé:** ${data.chatcode}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Hãng:** ${data.hang}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nơi khởi hành:** ${data.noi_khoi_hanh}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Nơi đến:** ${data.diem_den}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngày khởi hành:** ${data.ngay_khoi_hanh}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Ngày trở về:** ${data.ngay_tro_ve}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số chiều:** ${data.so_chieu}`,\n            },\n        },\n        {\n            is_short: true,\n            text: {\n                tag: \"lark_md\",\n                content: `**Số khách:** ${data.so_luong_khach}`,\n            },\n        },\n    ],\n});\n\n// Add action buttons\nelements.push({\n    tag: \"action\",\n    actions: [\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Chat Zalo cá nhân\",\n            },\n            url: `https://zalo.me/${data.phone}`,\n            type: \"primary\",\n        },\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Gọi điện cá nhân\",\n            },\n            url: `tel:${data.phone}`,\n            type: \"default\",\n        },\n        {\n            tag: \"button\",\n            text: {\n                tag: \"plain_text\",\n                content: \"Xem trên web\",\n            },\n            url: `${data.source_url}`,\n            type: \"default\",\n        }\n    ],\n});\n\n\nlet result = {\n    msg_type: \"interactive\",\n    card: {\n        config: {\n            wide_screen_mode: true,\n        },\n        header: {\n            template: \"green\",\n            title: {\n                content: `Yêu cầu tư vấn ${data.source_title}`,\n                tag: \"plain_text\",\n            },\n        },\n        elements,\n    },\n};\nreturn { json: result };"},"id":"27ddfe74-1b62-408a-bcad-62a28c925e4d","name":"Code1","type":"n8n-nodes-base.code","typeVersion":1,"position":[1260,500]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.msg }}","value2":"success"}]}},"id":"6ecbbaec-c4e6-4739-add1-461f6e8154fb","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[1700,500]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $node.Code.json.nhieu_thong_tin }}","value2":"={{ true }}"}]}},"id":"c850e714-aa0f-44f9-a162-8d91e2832f58","name":"IF1","type":"n8n-nodes-base.if","typeVersion":1,"position":[1880,360]},{"parameters":{"application":{"__rl":true,"value":"appg7xGBQYqUYbJAr","mode":"id"},"table":{"__rl":true,"value":"tblWAtHbJemABDvCG","mode":"id"},"id":"recqr9eRsaI69jq2D"},"id":"d10176d8-0eb6-4b91-b429-17a2b6185cf8","name":"Airtable","type":"n8n-nodes-base.airtable","typeVersion":1,"position":[2100,360],"credentials":{"airtableApi":{"id":"20","name":"Airtable: lekhoi456@gmail.com"}}},{"parameters":{"method":"POST","url":"https://business.openapi.zalo.me/message/template","sendHeaders":true,"headerParameters":{"parameters":[{"name":"access_token","value":"={{ $node.Airtable.json.fields.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"phone\": \"{{$node[\"Code\"].json[\"sdtZalo\"]}}\",\n    \"template_id\": \"259151\",\n    \"template_data\": {\n        \"loai_ve\": \"{{$node[\"Webhook\"].json[\"body\"][\"so_chieu\"]}}\",\n        \"ngay_tro_ve\": \"{{$node[\"Code\"].json[\"ngay_tro_ve\"]}}\",\n        \"diem_den\": \"{{$node[\"Code\"].json[\"diem_den\"]}}\",\n        \"hang\": \"{{$node[\"Code\"].json[\"hang\"]}}\",\n        \"ngay_khoi_hanh\": \"{{$node[\"Code\"].json[\"ngay_khoi_hanh\"]}}\",\n        \"ma_dat_ve\": \"{{$node[\"Code\"].json[\"chatcode\"]}}\",\n        \"ten_ve\": \"{{$node[\"Code\"].json[\"ten_ve\"]}}\",\n        \"noi_khoi_hanh\": \"{{$node[\"Code\"].json[\"noi_khoi_hanh\"]}}\",\n        \"trang_thai\": \"Đang kiểm tra vé\",\n        \"so_luong_khach\": {{$node[\"Code\"].json[\"so_luong_khach\"]}},\n        \"ho_va_ten\": \"{{$node[\"Code\"].json[\"fullname\"]}}\"\n    },\n    \"tracking_id\": \"ncmk_phong_ve_khach_de_lai_thong_tin\"\n}","options":{}},"id":"b5569fe0-7f10-42de-b076-c50e67b7a539","name":"HTTP Request1","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,160]},{"parameters":{"conditions":{"number":[{"value1":"={{ $node.Code.json.so_chieu }}","operation":"equal","value2":2}]}},"id":"2876e988-92e7-4077-85c2-d729bb815d8c","name":"IF2","type":"n8n-nodes-base.if","typeVersion":1,"position":[2320,360]},{"parameters":{"method":"POST","url":"https://business.openapi.zalo.me/message/template","sendHeaders":true,"headerParameters":{"parameters":[{"name":"access_token","value":"={{ $node.Airtable.json.fields.access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\n    \"phone\": \"{{$node[\"Code\"].json[\"sdtZalo\"]}}\",\n    \"template_id\": \"259152\",\n    \"template_data\": {\n        \"loai_ve\": \"{{$node[\"Webhook\"].json[\"body\"][\"so_chieu\"]}}\",\n        \"diem_den\": \"{{$node[\"Code\"].json[\"diem_den\"]}}\",\n        \"hang\": \"{{$node[\"Code\"].json[\"hang\"]}}\",\n        \"ngay_khoi_hanh\": \"{{$node[\"Code\"].json[\"ngay_khoi_hanh\"]}}\",\n        \"ma_dat_ve\": \"{{$node[\"Code\"].json[\"chatcode\"]}}\",\n        \"ten_ve\": \"{{$node[\"Code\"].json[\"ten_ve\"]}}\",\n        \"noi_khoi_hanh\": \"{{$node[\"Code\"].json[\"noi_khoi_hanh\"]}}\",\n        \"trang_thai\": \"Đang kiểm tra vé\",\n        \"so_luong_khach\": {{$node[\"Code\"].json[\"so_luong_khach\"]}},\n        \"ho_va_ten\": \"{{$node[\"Code\"].json[\"fullname\"]}}\"\n    },\n    \"tracking_id\": \"ncmk_phong_ve_khach_de_lai_thong_tin\"\n}","options":{}},"id":"5f96acb9-aef2-4410-bb3f-4e2d835a6638","name":"HTTP Request2","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2540,380]}],"connections":{"Webhook":{"main":[[{"node":"Code","type":"main","index":0}]]},"Code":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code1":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"IF1","type":"main","index":0}]]},"IF1":{"main":[[{"node":"Airtable","type":"main","index":0}]]},"Airtable":{"main":[[{"node":"IF2","type":"main","index":0}]]},"IF2":{"main":[[{"node":"HTTP Request1","type":"main","index":0}],[{"node":"HTTP Request2","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"WordPress/6.2.2; https://mailinh.local","content-length":"480","accept":"*/*","accept-encoding":"deflate, gzip, br, zstd","content-type":"application/json; charset=UTF-8","x-forwarded-for":"125.235.236.200","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"ba8c3a24b3d5","x-real-ip":"125.235.236.200"},"params":{},"query":{},"body":{"tuyen":"Cần Thơ - Côn Đảo","fullname":"Le Quoc Khoi","phone":"0333111868","nhieu_thong_tin":["Tôi sẽ cung cấp nhiều thông tin hơn"],"so_chieu":"Khứ hồi","ngay_khoi_hanh":"2023-06-15","ngay_tro_ve":"2023-06-16","so_luong_khach":"2","source_title":"Tàu cao tốc Mai Linh Express - Vé tàu Cần Thơ - Côn Đảo giá rẻ","source_url":"https://mailinh.local:10164/"}},"pairedItem":{"item":0}}]},"versionId":"abd44646-2527-48a7-b45c-6a98a47535f0","triggerCount":1,"tags":[{"createdAt":"2023-05-09T11:00:16.326Z","updatedAt":"2023-05-09T11:00:16.326Z","id":"16","name":"vere"}]}
{"createdAt":"2023-07-13T09:44:10.459Z","updatedAt":"2023-07-15T04:44:25.000Z","id":"164","name":"khoi: catch balance sms & extract data","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"kdigi-api-bank","options":{}},"id":"b4de67e5-38cd-468f-8570-b0fc6a5e1fe2","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[1400,500],"webhookId":"243b3294-25f7-4240-987d-01a168faab28"},{"parameters":{"jsCode":"const data = $input.first().json.data;\n\nlet elements = [];\n\nelements.push(\n  // First section\n  {\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Ngân hàng**: ${data.bankName}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số tài khoản**: ${data.receiverAccount}`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư thay đổi:** (${data.transactionType.text}) ${data.transactionAmount.text} VND`,\n        },\n      },\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Số dư tạm tính**: ${data.balance.text} VND`,\n        },\n      },\n    ],\n  },\n  { tag: 'hr' },\n\n  //   Second section\n  {\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Nội dung chuyển khoản:**\\n ${data.transactionMessage}`,\n        },\n      },\n    ],\n  },\n  { tag: 'hr' },\n\n  //   Third section\n  {\n    tag: 'div',\n    fields: [\n      {\n        is_short: false,\n        text: {\n          tag: 'lark_md',\n          content: `**Thời gian nhận:** ${data.receivedTime.text}`,\n        },\n      },\n    ],\n  }\n);\n\n// Add transactionId to third section\nif (data.transactionId) {\n  elements[4].fields.push({\n    is_short: false,\n    text: {\n      tag: 'lark_md',\n      content: `**Mã giao dịch:** ${data.transactionId}`,\n    },\n  });\n}\n\n// Add action\nif (data.deepLinks) {\n  elements.push({\n    tag: 'action',\n    actions: [],\n  });\n\n  //   if iOS link found\n  if (data.deepLinks.ios.link) {\n    elements.at(-1).actions.push({\n      tag: 'button',\n      text: {\n        tag: 'plain_text',\n        content: `Mở App ${data.bankName} (iOS)`,\n      },\n      url: `${data.deepLinks.ios.link}`,\n      type: 'primary',\n    });\n  }\n\n  //   if android link found\n  if (data.deepLinks.android.link) {\n    elements.at(-1).actions.push({\n      tag: 'button',\n      text: {\n        tag: 'plain_text',\n        content: `Mở App ${data.bankName} (Android)`,\n      },\n      url: `${data.deepLinks.android.link}`,\n      type: 'default',\n    });\n  }\n}\n\n// create message card\nlet result = {\n  msg_type: 'interactive',\n  card: {\n    config: {\n      wide_screen_mode: true,\n    },\n    header: {\n      template: 'green',\n      title: {\n        content: `${data.bankName}-${data.receiverAccount} (${data.transactionType.text}) ${data.transactionAmount.text}VND`,\n        tag: 'plain_text',\n      },\n    },\n    elements,\n  },\n};\n\nreturn { json: result };\n"},"id":"65036269-a824-46b8-96fe-501f9252a31f","name":"Convert to Lark Message Card","type":"n8n-nodes-base.code","typeVersion":1,"position":[2280,660]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $input.item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $input.item.json[\"appSecret\"] }}\" }","options":{}},"id":"ecfc5c46-0d38-4605-a9f3-2931538b6174","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[2460,340]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a36a65082eb85009"},{"name":"appSecret","value":"n6EEtyICEiK2IoQGXLAFtedQTGY0Z5Sk"}]},"options":{}},"id":"04ee72ae-0bfa-4c2c-9b2a-8386074758a2","name":"Set Lark auth data","type":"n8n-nodes-base.set","typeVersion":1,"position":[2260,340]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($('Convert to Lark Message Card').first().json)}}","options":{}},"id":"69af75c4-3582-4270-bd82-092c0495373a","name":"[Lark] Send noti to group chat","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2480,660]},{"parameters":{"jsCode":"let input = $('Lark entry point').first().json.data;\n\n// Convert to Lark Base format\nlet records = [\n  {\n    fields: {\n      ID: input.bankName + '-' + input.receiverAccount,\n      Bank: input.bankName,\n      Account: input.receiverAccount,\n      'Transaction Type': input.transactionType.type === 0 ? 'Debit' : 'Credit',\n      Debit:\n        input.transactionType.type === 0\n          ? input.transactionAmount.amount\n          : undefined,\n      Credit:\n        input.transactionType.type === 1\n          ? input.transactionAmount.amount\n          : undefined,\n      Balance: input.balance.amount,\n      // 'Transaction ID':input.transactionId,\n      'Transaction Message': input.transactionMessage,\n      'Original Message': input.originalMessage,\n      'Time received': input.receivedTime.timestamp,\n    },\n  },\n];\n\nlet result = { json: { records } };\nreturn result;\n"},"id":"8be4e447-ff48-4778-b17e-3fe80c9a7f31","name":"Convert to Lark Base format","type":"n8n-nodes-base.code","typeVersion":1,"position":[2640,340]},{"parameters":{},"id":"62408ae4-3394-4f88-a5a8-a471f9f0d5b2","name":"Lark entry point","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1960,500]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $input.item.json[\"appId\"] }}/tables/{{ $input.item.json[\"tableId\"] }}/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('Convert to Lark Base format').first().json.records) }}}","options":{}},"id":"d1d6f90c-e25b-42f3-b803-4f4f79c17695","name":"[SMS Log] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[3000,340]},{"parameters":{"values":{"string":[{"name":"appId","value":"Vz9eb7avZa95IUsOk99uji8Fsdd"},{"name":"tableId","value":"tbl9prfOWONpDCbk"}]},"options":{}},"id":"4d433300-f5fb-4237-889a-f154808fe3f2","name":"Set SMS Log config","type":"n8n-nodes-base.set","typeVersion":2,"position":[2820,340]},{"parameters":{"method":"POST","url":"https://app.n8n.vn/webhook/kdigi-process-sms-banking","sendBody":true,"specifyBody":"json","jsonBody":"={{ JSON.stringify($input.first().json.body) }}","options":{}},"id":"fa4213a0-9c68-4984-8404-2ef07d28037c","name":"Call KDIGI API","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1640,500]}],"connections":{"Webhook":{"main":[[{"node":"Call KDIGI API","type":"main","index":0}]]},"Convert to Lark Message Card":{"main":[[{"node":"[Lark] Send noti to group chat","type":"main","index":0}]]},"Set Lark auth data":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Convert to Lark Base format","type":"main","index":0}]]},"Convert to Lark Base format":{"main":[[{"node":"Set SMS Log config","type":"main","index":0}]]},"Lark entry point":{"main":[[{"node":"Convert to Lark Message Card","type":"main","index":0},{"node":"Set Lark auth data","type":"main","index":0}]]},"Set SMS Log config":{"main":[[{"node":"[SMS Log] Add records to Bitable","type":"main","index":0}]]},"Call KDIGI API":{"main":[[{"node":"Lark entry point","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"SMS Forwarder App","transfer-encoding":"chunked","accept-encoding":"gzip","content-type":"application/json; charset=utf-8","x-forwarded-for":"125.235.237.202","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"125.235.237.202"},"params":{},"query":{},"body":{"from":"OCB","text":"OCB 13/07 17:47\nTK 88882\n(+) 12,345 VND\nN/dung: MBVCB.3847384432.027204.Khoi test chuyen tien api lark.CT tu 6681888888 LE QUOC KHOI toi 88...\nSo du: 50,058 VND","sentStamp":1689245252000,"receivedStamp":1689245252894,"sim":"sim1"}}}]},"versionId":"49632683-e697-4494-ae1b-c46edc1c5c63","triggerCount":1,"tags":[{"createdAt":"2023-01-05T09:55:57.214Z","updatedAt":"2023-01-05T09:55:57.214Z","id":"1","name":"Lark"},{"createdAt":"2023-07-15T01:37:36.669Z","updatedAt":"2023-07-15T01:37:36.669Z","id":"27","name":"KDIGI"}]}
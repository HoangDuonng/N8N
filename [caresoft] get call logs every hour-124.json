{"createdAt":"2023-06-13T07:52:39.568Z","updatedAt":"2023-06-19T07:15:39.000Z","id":"124","name":"[Caresoft] Get call logs every hour","active":false,"nodes":[{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"id":"fd76bbcd-bc77-419f-a4d5-9245e48abec3","name":"Schedule Trigger","type":"n8n-nodes-base.scheduleTrigger","typeVersion":1,"position":[140,380]},{"parameters":{"jsCode":"// Loop over input items and add a new field\n// called 'myNewField' to the JSON of each one\nlet startDate = new Date($('Schedule Trigger').first().json.timestamp);\nlet endDate = new Date($('Schedule Trigger').first().json.timestamp);\n\nstartDate.setHours(startDate.getHours() + 6);\n// startDate.setHours(startDate.getHours() - 720); // fetch data previous 30 days\nstartDate.setMinutes(0);\nstartDate.setSeconds(1);\n\nendDate.setHours(endDate.getHours() + 7); // Add 7 hrs to compensate for Caresoft time\n\nreturn {\n  json: {\n    startDate: startDate.toISOString(),\n    endDate: endDate.toISOString(),\n  },\n};"},"id":"465cd94d-9ae8-490d-8235-a1c7d2a31514","name":"Get start time","type":"n8n-nodes-base.code","typeVersion":1,"position":[340,380]},{"parameters":{"url":"https://web11.caresoft.vn/hsvn/api/v1/calls","sendQuery":true,"queryParameters":{"parameters":[{"name":"start_time_since","value":"={{ $node[\"Get start time\"].json.startDate }}"},{"name":"start_time_to","value":"={{ $node[\"Get start time\"].json.endDate }}"},{"name":"count","value":"500"},{"name":"page","value":"1"},{"name":"order_by","value":"start_time"},{"name":"order_type","value":"desc"}]},"sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization"}]},"options":{}},"id":"3ca9065d-0c49-4258-acc8-b95ed6e7d608","name":"Get call log in the last hour","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[520,380]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/baslg7TBWBKBB5Bc5vJhovnm3Jc/tables/tbl62BNK4pAYT76F/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('[Call Log] Convert to Lark format').first().json.records) }}}","options":{}},"id":"5262915a-0195-42a3-86d8-9268e14b1351","name":"[Call data] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1300,500]},{"parameters":{"method":"POST","url":"https://open.larksuite.com/open-apis/bitable/v1/apps/baslg7TBWBKBB5Bc5vJhovnm3Jc/tables/tblstCVsQu0Etn5e/records/batch_create","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $node[\"Get Lark tenant access token\"].json.tenant_access_token }}"}]},"sendBody":true,"specifyBody":"json","jsonBody":"={\"records\":{{ JSON.stringify($('[Raw call log] Convert to Lark format').first().json.records) }}}","options":{}},"id":"211f3057-995f-4e00-967c-18b60a22b9ac","name":"[Raw call log data] Add records to Bitable","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1300,280]},{"parameters":{"jsCode":"let input = $('Get call log in the last hour').first().json.calls;\n\n// Get calls data\nlet records = input.map((call) => {\n  let fields = {\n    id: call.id,\n    customer_id: call.customer_id,\n    call_id: call.call_id,\n    path: {\n      text: \"Xem cuộc gọi\",\n      link: call.path\n    },\n    path_download: {\n      text:\"Tải cuộc gọi\",\n      link: call.path_download\n    },\n    caller: call.caller,\n    called: call.called,\n    user_id: call.user_id,\n    agent_id: call.agent_id.split(',').at(-1),\n    agent_log: call.agent_id,\n    group_id: call.group_id,\n    call_type: call.call_type,\n    start_time: new Date(call.start_time).getTime() - 3600000*7, // substract 7hrs\n    call_status: call.call_status,\n    end_time: new Date(call.end_time).getTime() - 3600000*7,\n    wait_time: call.wait_time,\n    hold_time: call.hold_time,\n    talk_time: call.talk_time,\n    end_status: call.end_status,\n    ticket_id: call.ticket_id,\n    last_agent_id: call.last_agent_id,\n    last_user_id: call.last_user_id,\n    call_survey: call.call_survey,\n    call_survey_result: call.call_survey_result,\n    missed_reason: call.missed_reason,\n  };\n  return { fields };\n});\n\nlet result = { json: { records } };\nreturn result;"},"id":"865c559e-4bf8-44db-a81a-afe23890e84c","name":"[Raw call log] Convert to Lark format","type":"n8n-nodes-base.code","typeVersion":1,"position":[1100,280]},{"parameters":{"jsCode":"let input = $('Get call log in the last hour').first().json.calls;\n\n// Get calls data\nlet records = input.map((call) => {\n  let fields = {    \n    \"ID cuộc gọi\": call.call_id,   \n    // customer_id: call.customer_id,\n    // agent_id: call.agent_id,\n    // group_id: call.group_id,    \n    // ticket_id: call.ticket_id,   \n  };\n  return { fields };\n});\n\nlet result = { json: { records } };\nreturn result;"},"id":"bd587dd3-1e8c-42d7-9ecf-2022552759fc","name":"[Call Log] Convert to Lark format","type":"n8n-nodes-base.code","typeVersion":1,"position":[1100,500]},{"parameters":{"url":"=https://open.larksuite.com/open-apis/bitable/v1/apps/{{ $('Set Lark auth').json.appId }}/tables/{{ $('Set Lark auth').json.appId }}/records  ","options":{}},"id":"706450c5-31dc-41b7-aac5-cb0f4f103d2c","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[880,380]},{"parameters":{"values":{"string":[{"name":"appId"},{"name":"appSecret"}]},"options":{}},"id":"dbc64b45-4156-4f8f-9e2e-998302399f1a","name":"Set Lark auth","type":"n8n-nodes-base.set","typeVersion":1,"position":[700,380]}],"connections":{"Get start time":{"main":[[{"node":"Get call log in the last hour","type":"main","index":0}]]},"Get call log in the last hour":{"main":[[{"node":"Set Lark auth","type":"main","index":0}]]},"[Raw call log] Convert to Lark format":{"main":[[{"node":"[Raw call log data] Add records to Bitable","type":"main","index":0}]]},"[Call Log] Convert to Lark format":{"main":[[{"node":"[Call data] Add records to Bitable","type":"main","index":0}]]},"Set Lark auth":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"[Raw call log] Convert to Lark format","type":"main","index":0},{"node":"[Call Log] Convert to Lark format","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"c618768a-e84a-4397-95dd-d2f01ac74834","triggerCount":0,"tags":[{"createdAt":"2023-02-27T05:42:03.910Z","updatedAt":"2023-02-27T05:42:03.910Z","id":"10","name":"Caresoft"},{"createdAt":"2023-04-13T09:24:58.649Z","updatedAt":"2023-06-13T07:54:39.069Z","id":"14","name":"Template"}]}
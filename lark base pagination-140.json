{"createdAt":"2023-06-19T10:13:49.365Z","updatedAt":"2023-09-05T02:59:42.000Z","id":"140","name":"Lark base pagination","active":false,"nodes":[{"parameters":{"conditions":{"boolean":[{"value1":"={{ $json.isValidRecordId }}","value2":"={{ true }}"}]}},"id":"86dfb37e-c91b-4a99-942d-cb693f967053","name":"check_found_order","type":"n8n-nodes-base.if","typeVersion":1,"position":[2260,440]},{"parameters":{"url":"={{ $('Config Url').first().json.url }}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $('Get Lark tenant access token').item.json.tenant_access_token }}"}]},"sendBody":true,"bodyParameters":{"parameters":[{}]},"options":{}},"id":"3f2e4cd3-a974-4a3d-8e43-ce742b5132bd","name":"get_list_record","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1800,440]},{"parameters":{"conditions":{"boolean":[{"value1":"={{ $('get_list_record').item.json.data.has_more }}","value2":true}]}},"id":"440a2de5-00ac-464e-922c-ac055100e153","name":"if_has_more_list","type":"n8n-nodes-base.if","typeVersion":1,"position":[2260,660]},{"parameters":{"jsCode":"const data = $('get_list_record').first().json.data\nconst order = data.items.find(forItem => forItem.fields.order_id === $('get_order_id_from_tx').first().json.order_id)\nlet isValidRecordId = !!order?.record_id\nif (!order) return {isValidRecordId}\nlet order_id = order?.fields.order_id\nlet record_id = order?.record_id\nlet moneyReceive = $('get_order_id_from_tx').first().json.total_receive\nconsole.log(moneyReceive)\nlet moneyTotal = order?.fields.total\n// thằng chuyển nhiều tiền hơn orderTotal\nlet moneyRest = (moneyTotal-moneyReceive)>0 ? moneyTotal-moneyReceive : moneyTotal-moneyReceive\nlet statusPayment = $('check_is_true_tx').first().json.total_receive === moneyTotal?'Đã thanh toán đủ':'Đã thanh toán một phần'\nconsole.log(order)\nlet email = order?.fields.email\nreturn {\n  isValidRecordId,\n  email,\n  statusPayment,\n  moneyReceive,\n  moneyTotal,\n  moneyRest,\n  record_id,\n  order_id,\n  order_data: order?.fields\n}"},"id":"3298e9f3-c739-41a8-8324-d6b7944b7af9","name":"handle_record_id","type":"n8n-nodes-base.code","typeVersion":1,"position":[2000,440]},{"parameters":{"jsCode":"if (items[0].json?.pageToken){\n  return {\n    url: `https://open.larksuite.com/open-apis/bitable/v1/apps/${$('Set Lark Base info').first().json[\"baseId\"]}/tables/${$('Set Lark Base info').first().json[\"tableId\"]}/records?page_size=500&page_token=${items[0].json?.pageToken}&sort=%5B%22created_at+DESC%22%5D`\n  }\n}\n\nreturn {\n  url: `https://open.larksuite.com/open-apis/bitable/v1/apps/${$('Set Lark Base info').first().json[\"baseId\"]}/tables/${$('Set Lark Base info').first().json[\"tableId\"]}/records?page_size=5&sort=%5B%22created_at+DESC%22%5D`\n}"},"id":"5f4817fa-5194-4ed6-aeb6-ce4da47dd0d6","name":"Config Url","type":"n8n-nodes-base.code","typeVersion":1,"position":[1620,440]},{"parameters":{"values":{"string":[{"name":"pageToken","value":"={{ $('get_list_record').item.json.data.page_token}}"}]},"options":{}},"id":"74a390f1-a95c-4d0b-857b-740d270a5afe","name":"Set","type":"n8n-nodes-base.set","typeVersion":2,"position":[1820,820]},{"parameters":{},"id":"b3cce1da-1757-4388-8401-10c75b9fb0e1","name":"When clicking \"Execute Workflow\"","type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[680,440]},{"parameters":{"method":"POST","url":"=https://open.larksuite.com/open-apis/auth/v3/tenant_access_token/internal/","sendBody":true,"specifyBody":"json","jsonBody":"={ \"app_id\" : \"{{ $('Set Lark auth data').item.json[\"appId\"] }}\", \"app_secret\" : \"{{ $('Set Lark auth data').item.json[\"appSecret\"] }}\" }","options":{}},"id":"d86faddb-08b4-466d-a5ea-7a344b1c4a5a","name":"Get Lark tenant access token","type":"n8n-nodes-base.httpRequest","typeVersion":3,"position":[1140,440]},{"parameters":{"values":{"string":[{"name":"appId","value":"cli_a36a65082eb85009"},{"name":"appSecret","value":"n6EEtyICEiK2IoQGXLAFtedQTGY0Z5Sk"}]},"options":{}},"id":"d87a0ac3-2c38-4070-abe6-ca3b46182cd2","name":"Set Lark auth data","type":"n8n-nodes-base.set","typeVersion":1,"position":[940,440]},{"parameters":{"values":{"string":[{"name":"baseId","value":"JxmFbMji9a8sGHs8KrfuAkkfsgf"},{"name":"tableId","value":"tblNSWaikG3Anktj"}]},"options":{}},"id":"77f69cf3-2f91-4d23-b86d-f80465a008d1","name":"Set Lark Base info","type":"n8n-nodes-base.set","typeVersion":2,"position":[1360,440]}],"connections":{"check_found_order":{"main":[[],[{"node":"if_has_more_list","type":"main","index":0}]]},"get_list_record":{"main":[[{"node":"handle_record_id","type":"main","index":0}]]},"if_has_more_list":{"main":[[{"node":"Set","type":"main","index":0}]]},"handle_record_id":{"main":[[{"node":"check_found_order","type":"main","index":0}]]},"Config Url":{"main":[[{"node":"get_list_record","type":"main","index":0}]]},"Set":{"main":[[{"node":"Config Url","type":"main","index":0}]]},"When clicking \"Execute Workflow\"":{"main":[[{"node":"Set Lark auth data","type":"main","index":0}]]},"Set Lark auth data":{"main":[[{"node":"Get Lark tenant access token","type":"main","index":0}]]},"Get Lark tenant access token":{"main":[[{"node":"Set Lark Base info","type":"main","index":0}]]},"Set Lark Base info":{"main":[[{"node":"Config Url","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{},"versionId":"79a7036a-6467-4ef9-a1bd-2f9e30769c3f","triggerCount":0,"tags":[{"createdAt":"2023-04-13T09:24:58.649Z","updatedAt":"2023-06-13T07:54:39.069Z","id":"14","name":"Template"}]}
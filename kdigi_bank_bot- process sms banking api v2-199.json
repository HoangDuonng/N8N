{"createdAt":"2023-07-19T04:30:04.366Z","updatedAt":"2023-07-29T04:57:20.000Z","id":"199","name":"KDIGI_BANK_BOT: process SMS banking API v2","active":false,"nodes":[{"parameters":{"httpMethod":"POST","path":"v2/kdigi-bank-bot-process-data","responseMode":"responseNode","options":{"ignoreBots":false}},"id":"906be869-0738-4b81-8f93-58f0213e1ba8","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[1460,340],"webhookId":"41106822-4ca9-4367-8150-b893b23c7335"},{"parameters":{"respondWith":"json","responseBody":"={{ JSON.stringify($(\"codeHandle\").first().json) }}","options":{}},"id":"d8aaa35f-2360-4b18-b123-7533c8284f0b","name":"Respond to Webhook","type":"n8n-nodes-base.respondToWebhook","typeVersion":1,"position":[2220,340]},{"parameters":{"jsCode":"const rawWebhook = $('Webhook').first().json;\n\nconst webhookBody = rawWebhook.body;\n\n// Create respond object\nlet respond = {};\n\n// const listBankSupport = $input.first().json.data;\nconst listBankSupport = [\n      \"vietcombank\",\n      \"tpbank\",\n      \"vpbank\",\n      \"vib\",\n      \"seabank\",\n      \"bidv\",\n      \"ocb\",\n      \"techcombank\"\n    ];\n\n// Check valid bank support\nconst bankName = webhookBody.from.toLowerCase();\nconst isBankSupport = listBankSupport.includes(bankName);\n\nrespond = {\n  ...respond,\n  isBankSupport,\n};\n\nif (!isBankSupport) {\n  return respond;\n}\n\n// If config accepted banks\nlet isBankAccepted = true;\n\nrespond = {\n  ...respond,\n  isBankAccepted,\n};\n\nif (webhookBody.acceptedBanks?.trim()?.length > 0) {\n  const acceptedBanks = webhookBody.acceptedBanks?.split(',') ?? [];\n  isBankAccepted = acceptedBanks.includes(bankName);\n\n  respond = {\n    ...respond,\n    isBankAccepted,\n  };\n\n  if (!isBankAccepted) {\n    return respond;\n  }\n}\n\n\n\nconst result = {\n  bankName: '',\n  receivedTime: {},\n  receiverAccount: '',\n  senderAccount: '',\n  transactionType: {},\n  transactionAmount: {},\n  balance: {},\n  transactionId: '',\n  transactionMessage: '',\n  originalMessage: '',\n  larkMessConfig: {\n    cardColor: 'blue',\n  },\n};\n\nresult.bankName = getBankName(bankName);\nresult.receivedTime = getReceivedTime(webhookBody.sentStamp);\nresult.receiverAccount = getReceiverAccount(webhookBody.text, bankName);\nresult.senderAccount = getSenderAccount(webhookBody.text, bankName);\nresult.transactionType = getTransactionType(webhookBody.text, bankName);\nresult.transactionAmount = getTransactionAmount(webhookBody.text, bankName);\nresult.balance = getBalance(webhookBody.text, bankName);\nresult.transactionId = getTransactionId(webhookBody.text, bankName);\nresult.transactionMessage = getTransactionMessage(webhookBody.text, bankName);\nresult.originalMessage = webhookBody.text.toString().replace(/\\n/g, '');\nresult.larkMessConfig = getLarkMessConfig(bankName);\n\nreturn {\n  ...respond,\n  result,\n};\n\nfunction getBankName(msg) {\n  return msg;\n}\n\nfunction getReceivedTime(timestamp) {\n  return {\n    text: new Date(timestamp).toLocaleString('vi-VN', {\n      timeZone: 'Asia/Ho_Chi_Minh',\n    }),\n    timestamp: timestamp,\n  };\n}\n\nfunction getReceiverAccount(msg, bankName) {\n  let regex;\n  let match;\n  let account = '-';\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /SD TK (\\d+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'vpbank':\n      regex = /TK (\\d+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'tpbank':\n      regex = /TK: (\\w+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'vib':\n      regex = /TK:(\\d+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'seabank':\n      regex = /TK (\\d+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'bidv':\n      regex = /TK(\\w+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'ocb':\n      regex = /TK (\\w+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'techcombank':\n      regex = /TK (\\w+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    default:\n      return account;\n  }\n}\n\nfunction getSenderAccount(msg, bankName) {\n  let regex;\n  let match;\n  let account = '-';\n\n  switch (bankName) {\n    case 'vietcombank':\n      return account;\n\n    case 'vpbank':\n      regex = /ND: NHAN TU (\\d+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        account = match[1];\n      }\n      return account;\n\n    case 'tpbank':\n      return account;\n\n    case 'vib':\n      return account;\n\n    case 'seabank':\n      //   regex = /CT tu (\\d+)/;\n      //   match = msg.match(regex);\n\n      //   if (match) {\n      //     return match[1];\n      //   }\n      return account;\n\n    case 'bidv':\n      return account;\n\n    case 'ocb':\n      return account;\n\n    case 'techcombank':\n      return account;\n\n    default:\n      return account;\n  }\n}\n\nfunction getTransactionType(msg, bankName) {\n  let regex;\n  let match;\n  let transactionType = {\n    type: '-1',\n    typeText: '-',\n  };\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /SD TK \\d+ ([+-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'vpbank':\n      regex = /([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'tpbank':\n      regex = /PS:([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'vib':\n      regex = /PS:([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'seabank':\n      regex = /phat sinh ([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'bidv':\n      regex = /([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'ocb':\n      regex = /\\(([\\+\\-])\\)/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    case 'techcombank':\n      regex = /([\\+\\-])/;\n      match = msg.match(regex);\n      if (match) {\n        transactionType = {\n          type: match[1],\n          typeText: match[1] === '+' ? 'credit' : 'debit',\n        };\n      }\n      return transactionType;\n\n    default:\n      return transactionType;\n  }\n}\n\nfunction getTransactionAmount(msg, bankName) {\n  let regex;\n  let match;\n  let transactionAmount = {\n    amount: -1,\n    amountText: '-',\n  };\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /SD TK \\d+ [+-]?(\\d{1,3}(,\\d{3})*?)VND/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: parseFloat(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'vpbank':\n      regex = /[\\+\\-](\\d{1,3}(?:,\\d{3})*)VND/;\n      match = msg.match(regex);\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'tpbank':\n      regex = /PS:[+-]([\\d.,]+)VND/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'vib':\n      regex = /PS:[+-]([\\d.,]+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'seabank':\n      regex = /phat sinh [+-]([\\d.,]+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'bidv':\n      regex = /[+-]([\\d.,]+)VND/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'ocb':\n      regex = /\\([\\+\\-]\\) ([\\d.,]+) VND/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    case 'techcombank':\n      regex = /[\\+\\-]([\\d.,]+)/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionAmount = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return transactionAmount;\n\n    default:\n      return transactionAmount;\n  }\n}\n\nfunction getBalance(msg, bankName) {\n  let regex;\n  let match;\n  let balance = {\n    amount: -1,\n    amountText: '-',\n  };\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /(?<=SD )\\d{1,3}(,\\d{3})*?(?=VND)/;\n      match = msg.match(regex);\n      if (match) {\n        balance = {\n          amount: parseFloat(match[0].replace(/[\\.\\,]+/g, '')),\n          amountText: match[0],\n        };\n      }\n      return balance;\n\n    case 'vpbank':\n      regex = /So du\\s?(\\d{1,3}(?:,\\d{3})*)VND/;\n      match = msg.match(regex);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'tpbank':\n      regex = /SD:\\s?([\\d.,]+)VND/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'vib':\n      regex = /SODU:[+-]([\\d.,]+)/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'seabank':\n      regex = /SD:\\s?([\\d.,]+)VND/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'bidv':\n      regex = /So du:([\\d.,]+)VND/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'ocb':\n      regex = /So du:\\s?([\\d.,]+) VND/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    case 'techcombank':\n      regex = /So du:\\s?([\\d.,]+)/;\n      match = regex.exec(msg);\n      if (match) {\n        balance = {\n          amount: Number(match[1].replace(/[\\.\\,]+/g, '')),\n          amountText: match[1],\n        };\n      }\n      return balance;\n\n    default:\n      return balance;\n  }\n}\n\nfunction getTransactionId(msg, bankName) {\n  let regex;\n  let match;\n  let transactionId;\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /Ref (\\d{1,}\\.\\d{1,}\\.\\d{1,})/;\n      match = msg.match(regex);\n\n      if (match) {\n        transactionId = match[1];\n      }\n      return transactionId;\n\n    case 'vpbank':\n      return transactionId;\n\n    case 'tpbank':\n      regex = /ND:\\s*([A-Z0-9.-]+B-11\\.)/;\n      match = msg.match(regex);\n\n      if (match) {\n        return match[1];\n      }\n      return transactionId;\n\n    case 'vib':\n      return transactionId;\n\n    case 'seabank':\n      return transactionId;\n\n    case 'bidv':\n      return transactionId;\n\n    case 'ocb':\n      return transactionId;\n\n    case 'techcombank':\n      return transactionId;\n\n    default:\n      return transactionId;\n  }\n}\n\nfunction getTransactionMessage(msg, bankName) {\n  let regex;\n  let match;\n  let message = '-';\n\n  switch (bankName) {\n    case 'vietcombank':\n      regex = /VND. Ref (.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'vpbank':\n      regex = /ND:\\s*(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'tpbank':\n      regex = /ND:\\s*(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'vib':\n      regex = /ND:\\s*(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'seabank':\n      regex = /ND:\\s*(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'bidv':\n      regex = /ND:\\s*(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'ocb':\n      regex = /N\\/dung:\\s*(.*)\\.\\.\\./;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    case 'techcombank':\n      regex = /So du:\\s?[\\d.,]+\\n(.*)/;\n      match = msg.match(regex);\n\n      if (match) {\n        message = match[1];\n      }\n      return message;\n\n    default:\n      return message;\n  }\n}\n\n/**\n * Set config for Lark Messenger\n * Card header color reference: https://open.larksuite.com/document/common-capabilities/message-card/message-cards-content/card-header\n * @param bankName Name of bank\n * @returns\n */\nfunction getLarkMessConfig(bankName) {\n  let larkMessConfig = {\n    cardColor: 'blue',\n  };\n  switch (bankName) {\n    case 'vietcombank':\n      larkMessConfig = {\n        cardColor: 'green',\n      };\n      return larkMessConfig;\n\n    case 'vpbank':\n      larkMessConfig = {\n        cardColor: 'turquoise',\n      };\n      return larkMessConfig;\n\n    case 'tpbank':\n      larkMessConfig = {\n        cardColor: 'violet',\n      };\n      return larkMessConfig;\n\n    case 'vib':\n      larkMessConfig = {\n        cardColor: 'orange',\n      };\n      return larkMessConfig;\n\n    case 'seabank':\n      larkMessConfig = {\n        cardColor: 'red',\n      };\n      return larkMessConfig;\n\n    case 'bidv':\n      larkMessConfig = {\n        cardColor: 'turquoise',\n      };\n      return larkMessConfig;\n\n    case 'ocb':\n      larkMessConfig = {\n        cardColor: 'green',\n      };\n      return larkMessConfig;\n\n    case 'techcombank':\n      larkMessConfig = {\n        cardColor: 'red',\n      };\n      return larkMessConfig;\n\n    default:\n      return larkMessConfig;\n  }\n}\n\n// function template(msg, bankName) {\n//   let regex;\n//   let match;\n//   switch (bankName) {\n//     case 'vietcombank':\n//       regex = /ND: NHAN TU (\\d+)/;\n//       match = msg.match(regex);\n\n//       if (match) {\n//         return match[1];\n//       }\n//       return '-';\n//     case 'vpbank':\n//       return '-';\n//     case 'tpbank':\n//       return '-';\n//     case 'vib':\n//       return '-';\n//     case 'seabank':\n//       return '-';\n\n//     default:\n//       return '-';\n//   }\n// }\n"},"id":"5015a95a-d58d-489c-beba-bd7fac3c7a44","name":"codeHandle","type":"n8n-nodes-base.code","typeVersion":1,"position":[1960,340]},{"parameters":{"url":"https://app.n8n.vn/webhook/kdigi-get-list-bank-support","options":{}},"id":"0e1fb189-1bf7-4d27-9daf-c3a44ae64e3c","name":"Get list bank support","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1660,120]}],"connections":{"Webhook":{"main":[[{"node":"codeHandle","type":"main","index":0}]]},"codeHandle":{"main":[[{"node":"Respond to Webhook","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Webhook":[{"json":{"headers":{"host":"app.n8n.vn","user-agent":"axios/0.21.4","content-length":"615","accept":"application/json,text/html,application/xhtml+xml,application/xml,text/*;q=0.9, image/*;q=0.8, */*;q=0.7","content-type":"application/json","x-forwarded-for":"172.23.0.1","x-forwarded-host":"app.n8n.vn","x-forwarded-port":"443","x-forwarded-proto":"https","x-forwarded-server":"f2605f992776","x-real-ip":"172.23.0.1","accept-encoding":"gzip"},"params":{},"query":{},"body":{"from":"Techcombank","text":"TK 168816881688\nSo tien GD:+468,000\nSo du:11,038,677\nMBVCB.3865659241.078855.VU HAI SON chuyen tien.CT tu 0591000340457 VU HAI SON toi 168816881688 DANG THI T HANH HUE Ngan hang Ky thuong Viet N am (TECHCOMBANK)","sentStamp":1689410517000,"receivedStamp":1689410517697,"sim":"sim1","appId":"cli_a33cd37530b8900a","appSecret":"qNz8YxoCCZoGm9Nlm2bOrcUriJsJtHHD","enableBalance":true,"enableOTP":false,"enableOutgoing":false,"enableIncoming":true,"acceptedBanks":"vietcombank,bidv,techcombank","customBotURL":"https://open.larksuite.com/open-apis/bot/v2/hook/b8407056-e8cc-45d0-bfc6-7893201c4ff4"}}}],"Get list bank support":[{"json":{"data":["vietcombank","tpbank","vpbank","vib","seabank","bidv","ocb","techcombank"]}}]},"versionId":"e3e821fa-ab71-4e2d-a462-25a583b05da4","triggerCount":1,"tags":[{"createdAt":"2023-07-15T01:37:36.669Z","updatedAt":"2023-07-15T01:37:36.669Z","id":"27","name":"KDIGI"}]}
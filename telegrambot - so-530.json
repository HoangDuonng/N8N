{"createdAt":"2023-09-14T05:03:10.926Z","updatedAt":"2023-09-14T14:15:15.000Z","id":"530","name":"telegrambot - SO","active":true,"nodes":[{"parameters":{"httpMethod":"POST","path":"bec43177-abbb-4c60-9da7-cad6891a1200","options":{}},"id":"9bf04de1-1a46-45b0-b97a-b20332ae0ead","name":"Webhook","type":"n8n-nodes-base.webhook","typeVersion":1,"position":[500,260],"webhookId":"bec43177-abbb-4c60-9da7-cad6891a1200"},{"parameters":{"chatId":"={{ $json.body.telegramIdUser }}","text":"=Bạn vui lòng nhập mã định danh có dạng: HTC-xxxx để tiến hành kết nối.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Nhập mã định danh","additionalFields":{"switch_inline_query_current_chat":"Mã định danh là: HTC-"}}]}}]},"additionalFields":{}},"id":"8d898aa7-c91f-4ef0-aa38-2ea96454bce9","name":"Hỏi mã định danh","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[1480,-80],"credentials":{"telegramApi":{"id":"121","name":"Success Oceans Bot"}}},{"parameters":{"url":"https://api.smax.pro/gettoken?bizCode=lark_smax","options":{}},"id":"eae81b47-d960-4e00-8df1-e63d5f27dd47","name":"HTTP Request","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1840,0]},{"parameters":{"url":"={{encodeURI(`https://open.larksuite.com/open-apis/bitable/v1/apps/HyEybYz22aqO9nsTK74lacD6gFe/tables/tblcoZ51NTxTceIm/records?filter=CurrentValue.[Mã_Học_Viên] = \"HTC-0001\"`)}}","sendHeaders":true,"headerParameters":{"parameters":[{"name":"Authorization","value":"=Bearer {{ $json.token }}"}]},"options":{}},"id":"9f180d34-f3d3-4132-b62f-6668b4edd402","name":"Lấy thông tin","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[2040,20]},{"parameters":{"chatId":"={{ $('Switch_Text').item.json.body.telegramIdUser }}","text":"=Thông tin của bạn là:\nHọ tên: {{ $json[\"data\"][\"items\"][0][\"fields\"][\"Họ_tên\"][0][\"text\"] }}\nEmail:  {{ $json.data.items[0].fields.Email[0].text }}  ","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Xác Nhận","additionalFields":{"callback_data":"=XacNhanEmail_{{ $json.data.items[0].fields.Email[0].text }}"}}]}}]},"additionalFields":{}},"id":"44d7a218-5337-4ec1-a3ef-051ea71a2424","name":"Telegram","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[2280,0],"credentials":{"telegramApi":{"id":"121","name":"Success Oceans Bot"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"function getHTCCode(text) {\n  const regex = /HTC-\\d{4}/;\n  const match = text.match(regex);\n\n  if (match) {\n    return { code: match[0] }; // Trả về đối tượng chứa mã tìm thấy\n  } else {\n    return { error: \"Không tìm thấy mã HTC-xxxx trong đoạn văn bản.\" }; // Trả về đối tượng chứa thông báo lỗi\n  }\n}\n\nconst text = $json.body.telegram_text;\nconst result = getHTCCode(text);\nreturn result;"},"id":"1068c3ca-2995-4d5d-b2fd-10035e56a9a5","name":"Lấy mã HTC","type":"n8n-nodes-base.code","typeVersion":1,"position":[1500,80]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.body.telegram_query_data }}","operation":"isEmpty"}]}},"id":"5d2a7b35-5818-4f1c-b078-a9d010bd9fd0","name":"Check Text/Button","type":"n8n-nodes-base.if","typeVersion":1,"position":[720,260]},{"parameters":{"dataType":"string","value1":"={{ $json.body.telegram_query_data }}","rules":{"rules":[{"operation":"contains","value2":"XacNhanEmail"}]}},"id":"fddeec21-4716-4767-9731-17d99076e11f","name":"Switch1_Button","type":"n8n-nodes-base.switch","typeVersion":1,"position":[940,380]},{"parameters":{"dataType":"string","value1":"={{ $json.body.telegram_text }}","rules":{"rules":[{"value2":"/login"},{"operation":"contains","value2":"HTC-","output":1},{"operation":"contains","value2":"Mã OTP là","output":2}]}},"id":"8839e136-f6bc-414b-be3f-cce7adbe9138","name":"Switch_Text","type":"n8n-nodes-base.switch","typeVersion":1,"position":[920,180]},{"parameters":{},"id":"02086517-484e-422c-a45f-513f65549751","name":"Xác Nhận Email","type":"n8n-nodes-base.noOp","typeVersion":1,"position":[1240,420]},{"parameters":{"mode":"runOnceForEachItem","jsCode":"function extractEmail(text) {\n  const regex = /XacNhanEmail_(.+)/;\n  const match = text.match(regex);\n\n  if (match && match.length > 1) {\n    return {email: match[1]}; // Trả về giá trị sau \"XacNhanEmail_\"\n  } else {\n    return {error: \"Không tìm thấy địa chỉ email trong thông tin.\"}; // Trả về thông báo lỗi\n  }\n}\n\nconst text = $json.body.telegram_query_data;\nconst result = extractEmail(text);\nreturn result;"},"id":"39b771bb-0272-40bb-9c50-097acdfe41e8","name":"Lấy Email","type":"n8n-nodes-base.code","typeVersion":1,"position":[1460,420]},{"parameters":{"html":"<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">\n<html xmlns=\"http://www.w3.org/1999/xhtml\">\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=UTF-8\" />\n  <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n  <title>Lark Verification</title>\n</head>\n<body style=\"margin: 0; padding: 0; font-size: 0;\">\n  <style type=\"text/css\">\n    @media screen and (max-width:568px) {\n      .td-body {\n        padding-left: 24px!important;\n        padding-right: 24px!important;\n      }\n      .td-top-blue {\n        display: none;\n      }\n      .img-logo {\n        height: 30px!important;\n        width: auto!important;\n      }\n    }\n  </style>\n  <table border=\"0\" cellpadding=\"0\" cellspacing=\"0\" width=\"100%\">\n    <tbody>\n      <tr>\n        <td align=\"center\" style=\"background-color:#F2F3F5\">\n          <table style=\"max-width: 604px; font-family:Helvetica Neue;\" cellpadding=\"0\" cellspacing=\"0\">\n            <tbody>\n              <tr><td class=\"td-top-blue\" style=\"height: 4px; line-height: 4px; background-color: #bdd432;\"></td></tr>\n              <tr>\n                <td class=\"td-body\" style=\"background-color: #FFFFFF; padding: 32px 32px 60px;\">\n                  <table cellpadding=\"0\" cellspacing=\"0\">\n                    <tbody>\n                      <tr>\n                        <td>\n                          <img class=\"img-logo\" src='https://i.imgur.com/qQeCPSk.jpg'\n                            height=\"36\" width=\"126\" style=\"height:36px; background: #FFFFFF\" alt=\"logo\"/>\n                        </td>\n                      </tr>\n                      <tr>\n                        <td style=\"font-size: 16px; color:#1F2329; padding-top: 32px;\">Dưới đây là mã xác thực OTP của bạn tại Telegram Bot của Success Ocean:</td>\n                      </tr>\n                      <tr>\n                        <td style=\"font-size: 30px; color:#bdd432; padding-top: 56px; font-weight: bold;\">{{$json.OTP}}</td>\n                      </tr>\n                      <tr>\n                        <td style=\"font-size: 16px; color:#1F2329; padding-top: 54px;\">Success Oceans Team</td>\n                      </tr>\n                    </tbody>\n                  </table>\n                </td>\n              </tr>\n            </tbody>\n          </table>\n        </td>\n      </tr>\n    </tbody>\n  </table>\n</body>\n</html>"},"id":"184742bc-5359-4e2e-916d-29f9345a3415","name":"HTML","type":"n8n-nodes-base.html","typeVersion":1,"position":[2000,420]},{"parameters":{"fromEmail":"admin@go.cani.vn","toEmail":"={{ $('Lấy Email').item.json.email }}","subject":"={{ $('Tạo OTP').item.json.OTP }} - Là mã xác nhận với Telegram Bot của Success Ocean","emailFormat":"html","html":"={{ $json.html }}","options":{}},"id":"e6420d63-a342-40c6-be3c-b00f8614e7ba","name":"Send Email","type":"n8n-nodes-base.emailSend","typeVersion":2,"position":[2360,420],"credentials":{"smtp":{"id":"122","name":"admin@go.cani.vn (new)"}}},{"parameters":{"method":"POST","url":"=https://api.smax.pro/htc?event=OTP&job=TaoOTP&telegram_id={{ $('Switch1_Button').item.json.body.telegram_chat_id }}","sendQuery":true,"queryParameters":{"parameters":[{}]},"options":{}},"id":"d8ba17c9-8d0f-4faa-a617-3fe49acd55a7","name":"Tạo OTP","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1680,420]},{"parameters":{"chatId":"={{ $('Xác Nhận Email').item.json.body.telegram_chat_id }}","text":"=Vui lòng kiểm tra email:  {{ $('Lấy Email').item.json.email }}.\nMột mã OTP đã được gửi về email của bạn.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Nhập mã OTP","additionalFields":{"switch_inline_query_current_chat":"Mã OTP là: "}}]}}]},"additionalFields":{}},"id":"b9dab3fb-ef20-4d3f-95ef-68679b208ead","name":"Hỏi OTP","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[2620,420],"credentials":{"telegramApi":{"id":"121","name":"Success Oceans Bot"}}},{"parameters":{"mode":"runOnceForEachItem","jsCode":"function getHTCCode(text) {\nconst regex = /\\b\\d{6}\\b/;\n  const match = text.match(regex);\n\n  if (match) {\n    return { OTP: match[0] }; // Trả về đối tượng chứa mã tìm thấy\n  } else {\n    return { error: \"Không tìm thấy mã HTC-xxxx trong đoạn văn bản.\" }; // Trả về đối tượng chứa thông báo lỗi\n  }\n}\n\nconst text = $json.body.telegram_text;\nconst result = getHTCCode(text);\nreturn result;"},"id":"40dabba7-d9f8-434f-b227-80f56237a662","name":"Lấy mã OTP","type":"n8n-nodes-base.code","typeVersion":1,"position":[1240,260]},{"parameters":{"method":"POST","url":"=https://api.smax.pro/htc?event=OTP&job=Check-OTP&telegram_id={{ $('Switch_Text').item.json.body.telegram_chat_id }}&OTP={{ $json.OTP }}","sendQuery":true,"queryParameters":{"parameters":[{}]},"options":{}},"id":"f50e20ed-4f63-4ee8-be51-b489bf840d5d","name":"Check OTP","type":"n8n-nodes-base.httpRequest","typeVersion":4.1,"position":[1480,240]},{"parameters":{"conditions":{"string":[{"value1":"={{ $json.OTP }}","value2":"SAI"}]}},"id":"1d0c6d85-22e1-4683-b4f8-8a1e1100b60f","name":"IF","type":"n8n-nodes-base.if","typeVersion":1,"position":[1700,240]},{"parameters":{"chatId":"={{ $('Switch_Text').item.json.body.telegram_chat_id }}","text":"=Mã OTP bạn vừa nhập không chính xác. \nHãy nhập lại mã OTP gửi vào email của bạn.","replyMarkup":"inlineKeyboard","inlineKeyboard":{"rows":[{"row":{"buttons":[{"text":"Nhập mã OTP","additionalFields":{"switch_inline_query_current_chat":"Mã OTP là: "}}]}}]},"additionalFields":{}},"id":"da1e56a2-ef2c-484f-adb7-81ee972fceb0","name":"SAI OTP","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[2000,180],"credentials":{"telegramApi":{"id":"121","name":"Success Oceans Bot"}}},{"parameters":{"chatId":"={{ $('Switch_Text').item.json.body.telegram_chat_id }}","text":"=Cám ơn bạn đã xác nhận thành công.\nChúng tôi đang tiến hành tạo link giới thiệu chương trình chuyển hoá cho bạn.","additionalFields":{}},"id":"aefdda9c-9046-48d4-8ca6-772baf38bfc1","name":"ĐÚNG OTP","type":"n8n-nodes-base.telegram","typeVersion":1,"position":[2000,280],"credentials":{"telegramApi":{"id":"121","name":"Success Oceans Bot"}}}],"connections":{"Webhook":{"main":[[{"node":"Check Text/Button","type":"main","index":0}]]},"HTTP Request":{"main":[[{"node":"Lấy thông tin","type":"main","index":0}]]},"Lấy thông tin":{"main":[[{"node":"Telegram","type":"main","index":0}]]},"Lấy mã HTC":{"main":[[{"node":"HTTP Request","type":"main","index":0}]]},"Check Text/Button":{"main":[[{"node":"Switch_Text","type":"main","index":0}],[{"node":"Switch1_Button","type":"main","index":0}]]},"Switch_Text":{"main":[[{"node":"Hỏi mã định danh","type":"main","index":0}],[{"node":"Lấy mã HTC","type":"main","index":0}],[{"node":"Lấy mã OTP","type":"main","index":0}]]},"Switch1_Button":{"main":[[{"node":"Xác Nhận Email","type":"main","index":0}]]},"Xác Nhận Email":{"main":[[{"node":"Lấy Email","type":"main","index":0}]]},"Lấy Email":{"main":[[{"node":"Tạo OTP","type":"main","index":0}]]},"HTML":{"main":[[{"node":"Send Email","type":"main","index":0}]]},"Tạo OTP":{"main":[[{"node":"HTML","type":"main","index":0}]]},"Send Email":{"main":[[{"node":"Hỏi OTP","type":"main","index":0}]]},"Lấy mã OTP":{"main":[[{"node":"Check OTP","type":"main","index":0}]]},"Check OTP":{"main":[[{"node":"IF","type":"main","index":0}]]},"IF":{"main":[[{"node":"SAI OTP","type":"main","index":0}],[{"node":"ĐÚNG OTP","type":"main","index":0}]]}},"settings":{},"staticData":null,"pinData":{"Tạo OTP":[{"json":{"OTP":716069}}],"Send Email":[{"json":{"accepted":["andybui.maxout@gmail.com"],"rejected":[],"ehlo":["AUTH PLAIN LOGIN"],"envelopeTime":3071,"messageTime":2777,"messageSize":3089,"response":"250 2.0.0 OK: queued","envelope":{"from":"admin@go.cani.vn","to":["andybui.maxout@gmail.com"]},"messageId":"<4b339c93-4a9f-69f8-3723-fb26d6ac87fc@go.cani.vn>"}}],"Webhook":[{"json":{"body":{"telegramIdUser":6357057913,"telegram_message_id":870,"telegram_chat_id":315840332,"telegram_chat_username":"andybuimaxout","telegram_chat_name":"Bùi Tuấn Anh","telegram_from_id":6357057913,"telegram_text":"Mã OTP là: 625285","telegram_query_data":""}}}]},"versionId":"09e3d9e0-c3e4-409a-9887-dc88a770ca1c","triggerCount":1,"tags":[]}